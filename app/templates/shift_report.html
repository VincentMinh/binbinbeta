{% extends "base.html" %}
{% block title %}Quản lý Giao Ca - Bin Bin Hotel{% endblock %}
{% set active_page = active_page or 'shift-report' %}
{% block page_title %}Lịch Sử Giao Dịch Ca{% endblock %}
{% block content %}

<script id="initial-data" type="application/json">
    {{ initial_records | tojson | safe }}
</script>

{% block head_extra %}
{% endblock %}

<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .animate-fadeInUp {
        animation: fadeInUp 0.5s ease-out forwards;
    }
    /* THÊM: CSS cho cột sắp xếp */
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 24px !important; /* Thêm khoảng trống cho icon */
    }
    .sortable .sort-indicator {
        position: absolute;
        top: 50%;
        right: 8px;
        transform: translateY(-50%);
        opacity: 0.5;
        font-size: 0.8em;
        color: #6b7280;
        line-height: 1;
    }
    .sortable.asc .sort-indicator, .sortable.desc .sort-indicator {
        opacity: 1;
        color: #2563eb;
    }
    .sortable:hover .sort-indicator {
        opacity: 0.8;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="p-4 sm:p-6 lg:p-8" x-data="shiftReport(
         '#initial-data', 
         {{ total_records }}, 
         {{ current_page }}, 
         {{ total_pages }}
     )">

    <!-- ================================================================== -->
    <!-- ================== MONTHLY SUMMARY (ADMIN/BOSS) ================== -->
    <!-- ================================================================== -->
    <div class="mb-8 animate-fadeInUp" id="dashboard-container">
        <!-- Giao diện cho Admin, Boss (hiển thị biểu đồ xếp hạng) -->
        <div x-show="userRole === 'admin' || userRole === 'boss'" class="space-y-6 mb-6" x-cloak>
            <!-- Xếp hạng Doanh thu Chi nhánh -->
            <div class="bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700/50 rounded-2xl shadow-sm p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-semibold text-slate-700 dark:text-slate-200">Xếp hạng Doanh thu Chi nhánh</h3>
                </div>
                <div class="h-80">
                    <template x-if="charts.loading">
                        <div class="flex items-center justify-center h-full">
                            <p class="text-slate-500 dark:text-slate-400">Đang tải dữ liệu xếp hạng...</p>
                        </div>
                    </template>
                    <div x-show="!charts.loading" class="w-full h-full">
                        <canvas id="branchRevenueChart"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <!-- Giao diện chung cho tất cả các vai trò có quyền xem dashboard -->
        <div x-show="userRole === 'admin' || userRole === 'boss' || userRole === 'quanly'" class="space-y-6 mb-6" x-cloak>
            <div class="bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700/50 rounded-2xl shadow-sm p-5" x-show="userRole !== 'letan'">
                <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-4">Tổng Quan Doanh Thu</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Card Tổng Doanh Thu (Theo PMS) -->
                    <div class="rounded-xl bg-indigo-50 dark:bg-indigo-900/30 p-4 shadow-sm border border-indigo-200 dark:border-indigo-800 flex flex-col">
                        <p class="text-sm font-medium text-indigo-600 dark:text-indigo-300">Tổng Doanh Thu (PMS)</p>
                        <p class="mt-1 text-xl font-bold text-indigo-800 dark:text-indigo-200" x-text="formatCurrency(charts.data.total_pms_revenue || 0)"></p>
                        <div x-show="userRole !== 'letan'" class="mt-3 pt-2 border-t border-indigo-200 dark:border-indigo-800 text-xs space-y-1">
                            <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Tiền mặt:</span> <span class="font-semibold" x-text="formatCurrency(charts.data.total_cash_revenue || 0)"></span></div>
                            <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Giao dịch chờ xử lý:</span> <span class="font-semibold" x-text="formatCurrency(totalPendingRevenue)"></span></div>
                        </div>
                    </div>
                    <!-- Card Doanh thu Online -->
                    <div class="rounded-xl bg-blue-50 dark:bg-blue-900/30 p-4 shadow-sm border border-blue-200 dark:border-blue-800 flex flex-col">
                        <p class="text-sm font-medium text-blue-600 dark:text-blue-300">Doanh thu Online</p>
                        <p class="mt-1 text-xl font-bold text-blue-800 dark:text-blue-200" x-text="formatCurrency(onlineRevenueValue)"></p>
                        <div x-show="userRole !== 'letan'" class="mt-3 pt-2 border-t border-blue-200 dark:border-blue-800 text-xs space-y-1">
                            <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Đã kết ca:</span> <span class="font-semibold" x-text="formatCurrency(charts.data.by_type.closed_online)"></span></div>
                            <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Đang xử lý:</span> <span class="font-semibold" x-text="formatCurrency(charts.data.by_type.pending_online)"></span></div>
                        </div>
                    </div>
                    <!-- Card Doanh thu Chi nhánh -->
                    <div class="rounded-xl bg-green-50 dark:bg-green-900/30 p-4 shadow-sm border border-green-200 dark:border-green-800 flex flex-col">
                        <p class="text-sm font-medium text-green-600 dark:text-green-300">Doanh thu Chi nhánh</p>
                        <p class="mt-1 text-xl font-bold text-green-800 dark:text-green-200" x-text="formatCurrency(branchRevenueValue)"></p>
                        <div x-show="userRole !== 'letan'" class="mt-3 pt-2 border-t border-green-200 dark:border-green-800 text-xs space-y-1">
                            <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Đã kết ca:</span> <span class="font-semibold" x-text="formatCurrency(charts.data.by_type.closed_branch)"></span></div>
                            <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Đang xử lý:</span> <span class="font-semibold" x-text="formatCurrency(charts.data.by_type.pending_branch)"></span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700/50 rounded-2xl shadow-sm p-5">
                <h3 class="text-base font-semibold text-slate-700 dark:text-slate-200 mb-4">Lịch sử Kết ca Gần đây</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 dark:text-slate-400 uppercase">
                            <tr>
                                <th class="px-4 py-2">Thời gian</th>                                
                                <!-- SỬA: Chỉ hiển thị cột Chi nhánh cho admin/boss/quản lý -->
                                <th x-show="userRole !== 'letan'" class="px-4 py-2">Chi nhánh</th>
                                
                                <!-- SỬA: Đổi tên cột dựa trên vai trò -->
                                <th class="px-4 py-2">Ca làm</th>
                                <th class="px-4 py-2 text-right">Doanh thu PMS</th>
                                <th class="px-4 py-2 text-center"></th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-700 dark:text-slate-300 divide-y divide-slate-200 dark:divide-slate-700">
                            <template x-if="charts.loading">
                                <tr><td colspan="5" class="text-center py-6 text-slate-500 dark:text-slate-400">Đang tải...</td></tr>
                            </template>
                            <template x-if="!charts.loading && charts.data.recent_closes.length === 0">
                                <tr><td colspan="5" class="text-center py-6 text-slate-500 dark:text-slate-400">Chưa có lịch sử kết ca.</td></tr>
                            </template>
                            <template x-for="log in charts.data.recent_closes" :key="log.id">
                                <tr @click="openShiftCloseDetailModal(log.id)" class="hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer transition-colors">
                                    <td class="px-4 py-3" x-text="formatDate(log.closed_datetime)"></td>
                                    
                                    <!-- SỬA: Chỉ hiển thị cột Chi nhánh cho admin/boss/quản lý -->
                                    <td x-show="userRole !== 'letan'" class="px-4 py-3 font-medium" x-text="log.branch_code"></td>

                                    <td class="px-4 py-3" x-text="log.closer_name"></td>
                                    <td class="px-4 py-3 text-right font-semibold" x-text="formatCurrency(log.pms_revenue)"></td>
                                    <td class="px-4 py-3 text-center" @click.stop>
                                        <div x-show="userRole === 'admin' || userRole === 'boss'" class="flex items-center justify-center gap-3">
                                            <button @click="undoShiftClose(log.id)" title="Hoàn tác kết ca này" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M15.79 15.79a.75.75 0 01-1.06 0l-3.25-3.25a.75.75 0 010-1.06l3.25-3.25a.75.75 0 111.06 1.06L13.31 12l2.48 2.48a.75.75 0 010 1.06zM10 18a8 8 0 100-16 8 8 0 000 16z" clip-rule="evenodd" />
                                                </svg>
                                            </button>
                                            <button @click="deleteShiftClose(log.id)" title="Xóa vĩnh viễn lần kết ca này" class="text-rose-500 hover:text-rose-700 dark:text-rose-400 dark:hover:text-rose-300 transition-colors">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.428a.75.75 0 00-.588.733v3.498a.75.75 0 00.588.733c.785.207 1.57.35 2.365.428v.443a2.75 2.75 0 002.75 2.75h2.5A2.75 2.75 0 0014 10.25v-.443c.795-.077 1.58-.22 2.365-.428a.75.75 0 00.588-.733V5.147a.75.75 0 00-.588-.733c-.785-.208-1.57-.351-2.365-.428v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.552 0 1 .448 1 1v1.25a.75.75 0 000 1.5V9c0 .552-.448 1-1 1s-1-.448-1-1V7.75a.75.75 0 000-1.5V5c0-.552.448-1 1-1z" clip-rule="evenodd" /></svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- THÊM: Công cụ giao ca cho Lễ tân -->
        <div x-show="userRole === 'letan'" class="mt-4 animate-fadeInUp" x-cloak>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Bảng Giao Ca -->
                <div class="lg:col-span-1 bg-white dark:bg-slate-800/50 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700/50 p-6 flex flex-col justify-between">
                    <div>
                        <div class="flex items-center gap-2.5 mb-4">
                            <svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100">Bảng Giao Ca</h3>
                        </div>
                        
                        <label for="main_letan_pms_revenue_compact" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Doanh thu PMS (Nhập từ PMQL Khách sạn)</label>
                        <div class="relative">
                            <input type="text" id="main_letan_pms_revenue_compact" x-model="letanShiftClose.pmsRevenue" @input="handleAmountInput($event, 'letan_pms')" placeholder="0"
                                class="block w-full rounded-xl border-0 py-4 pl-4 pr-16 bg-white dark:bg-slate-900 
                                        text-slate-900 dark:text-white 
                                        ring-1 ring-inset ring-slate-300 dark:ring-slate-700 
                                        placeholder:text-slate-400 dark:placeholder:text-slate-500 
                                        focus:ring-2 focus:ring-inset focus:ring-blue-500 
                                        text-2xl font-semibold text-right">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-5 pointer-events-none">
                                <span class="text-sm font-medium text-slate-500 dark:text-slate-400">VNĐ</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                        <div class="grid grid-cols-2 gap-3">
                            <button @click="openHandoverModal()"
                                class="w-full bg-gradient-to-r from-purple-600 to-pink-500
                                        text-white px-4 py-3 rounded-lg shadow-lg shadow-purple-500/30
                                        flex items-center justify-center gap-2 font-semibold transition text-sm
                                        transform hover:-translate-y-0.5 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.174C2.996 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.746-1.994-1.802-2.169a47.82 47.82 0 00-1.134-.174 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0z" /></svg>
                                <span>Giao Ca</span>
                            </button>
                            
                            <button @click="initiateLetanCloseShift" 
                                    class="w-full bg-gradient-to-r from-blue-600 to-teal-400 
                                        text-white px-4 py-3 rounded-lg shadow-lg shadow-blue-500/30
                                        flex items-center justify-center gap-2 font-semibold transition text-sm
                                        transform hover:-translate-y-0.5 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span>Kết Ca</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bảng Đối Soát -->
                <div class="lg:col-span-2 bg-white dark:bg-slate-800/50 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700/50 p-6">
                    <div class="flex items-center gap-2.5 mb-4">
                        <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75l-2.489-2.489m0 0a3.375 3.375 0 10-4.773-4.773 3.375 3.375 0 004.774 4.774zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100">Bảng Đối Soát</h3>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        
                        <div class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-2 mb-1 text-sm font-medium text-slate-500 dark:text-slate-400">
                                <svg class="w-4 h-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 15.75l2.25-2.25m0 0l2.25 2.25M6 13.5l2.25 2.25m0 0l2.25 2.25m-2.25-2.25L6 13.5m0 0l2.25-2.25m2.25 2.25l2.25 2.25M12 18l2.25-2.25m0 0l2.25 2.25M14.25 15.75l2.25 2.25m0 0l2.25 2.25m-2.25-2.25l-2.25-2.25m2.25 2.25l2.25-2.25m-15-6l2.25-2.25m0 0l2.25 2.25M6 4.5l2.25 2.25m0 0l2.25 2.25M8.25 6.75l2.25 2.25m0 0l2.25 2.25m-2.25-2.25L8.25 6.75m0 0l2.25-2.25m2.25 2.25l2.25 2.25M12 9l2.25-2.25m0 0l2.25 2.25M14.25 6.75l2.25 2.25m0 0l2.25 2.25m-2.25-2.25l-2.25-2.25m2.25 2.25l2.25-2.25" /></svg>
                                <span>Doang Thu Online</span>
                            </div>
                            <div class="flex items-baseline justify-end gap-1.5">
                                <p class="text-2xl font-semibold text-blue-800 dark:text-blue-200" x-text="formatCurrency(onlineRevenueValue)"></p>
                                <span class="text-sm font-medium text-blue-500 dark:text-blue-400">VNĐ</span>
                            </div>
                        </div>

                        <div class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-2 mb-1 text-sm font-medium text-slate-500 dark:text-slate-400">
                                <svg class="w-4 h-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18h13.5V3M8.25 21h7.5M12 3v18" /></svg>
                                <span>Doanh Thu Chi nhánh</span>
                            </div>
                            <div class="flex items-baseline justify-end gap-1.5">
                                <p class="text-2xl font-semibold text-green-800 dark:text-green-200" x-text="formatCurrency(branchRevenueValue)"></p>
                                <span class="text-sm font-medium text-green-500 dark:text-green-400">VNĐ</span>
                            </div>
                        </div>

                        <div class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-2 mb-1 text-sm font-medium text-slate-500 dark:text-slate-400">
                                <svg class="w-4 h-4 text-amber-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6V5.25M3.75 4.5h.75a.75.75 0 000-1.5h-1.5a.75.75 0 00-.75.75v1.5m3.75 0h.75a.75.75 0 000-1.5h-1.5a.75.75 0 00-.75.75v1.5m3.75 0h.75a.75.75 0 000-1.5h-1.5a.75.75 0 00-.75.75v1.5m3.75 0h.75a.75.75 0 000-1.5h-1.5a.75.75 0 00-.75.75v1.5M12 12.75a.75.75 0 000-1.5h.008a.75.75 0 000 1.5h-.008Z" /></svg>
                                <span>Tiền mặt</span>
                            </div>
                            <div class="flex items-baseline justify-end gap-1.5">
                                <p class="text-2xl font-semibold text-amber-600 dark:text-amber-400" x-text="letanShiftClose.pmsRevenue.trim() !== '' ? formatCurrency(letanCounterCash) : '-'"></p>
                                <span x-show="letanPmsRevenueValue > 0" class="text-sm font-medium text-amber-500 dark:text-amber-400">VNĐ</span>
                            </div>
                        </div>

                        </div>

                    <div class="mt-4 p-5 rounded-xl bg-gradient-to-r from-slate-700 to-slate-900 dark:from-slate-100 dark:to-white shadow-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-bold text-white dark:text-slate-900 flex items-center gap-2">
                                <svg class="w-6 h-6 text-amber-400 dark:text-amber-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.75 7.5h16.5v-1.5c0-1.43-1.146-2.59-2.57-2.724A48.06 48.06 0 0012 3 48.06 48.06 0 006.32 3.276C4.895 3.41 3.75 4.57 3.75 6v1.5z" /></svg>
                                TỔNG TIỀN QUẦY
                            </span>
                            <div class="flex items-baseline justify-end gap-1.5">
                                <span class="text-3xl font-bold text-amber-400 dark:text-amber-600" x-text="letanShiftClose.pmsRevenue.trim() !== '' ? formatCurrency(letanTotalCounter) : '-'"></span>
                                <span x-show="letanPmsRevenueValue > 0" class="text-base font-medium text-amber-400 dark:text-amber-600">VNĐ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div x-show="isShiftCloseModalOpen" 
         @keydown.escape.window="closeShiftCloseModal()" 
         class="modal fixed inset-0 z-[10001] flex items-center justify-center p-4" 
         x-cloak>
        <div x-show="isShiftCloseModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-black/40 backdrop-blur-sm"></div>

        <div @click.outside="closeShiftCloseModal()" 
             x-show="isShiftCloseModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
             class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="grid place-items-center w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <h2 class="text-lg font-semibold text-slate-800 dark:text-white">Kết Ca Cho Chi Nhánh</h2>
                </div>
                <button @click="closeShiftCloseModal()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="admin-close-shift-form" @submit.prevent="submitAdminCloseShift" class="p-5 space-y-5 overflow-y-auto">
                <div>
                    <label for="admin_close_shift_branch" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                        Chọn chi nhánh để kết ca <span class="text-rose-500">*</span>
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" /></svg>
                        </div>
                        <select id="admin_close_shift_branch" name="branch" x-model="adminShiftClose.branch" required
                                class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                    ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                    focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm appearance-none">
                            <option value="" disabled selected>Chọn chi nhánh</option>
                            {% for b in branches %}<option value="{{ b }}">{{ b }}</option>{% endfor %}
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="admin_pms_revenue" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                        Doanh thu PMS của chi nhánh <span class="text-rose-500">*</span>
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.5 4A1.5 1.5 0 0 0 1 5.5V6h18v-.5A1.5 1.5 0 0 0 17.5 4h-15Z" /><path d="M1 7.5v7A1.5 1.5 0 0 0 2.5 16h15a1.5 1.5 0 0 0 1.5-1.5v-7H1ZM5 10.25a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h8.5a.75.75 0 0 0 0-1.5h-8.5Z" /></svg>
                        </div>
                        <input type="text" id="admin_pms_revenue" x-model="adminShiftClose.pmsRevenue" @input="handleAmountInput($event, 'admin_pms')" placeholder="0" required
                            class="block w-full rounded-lg border-0 py-2.5 pl-10 pr-14 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                    ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                    placeholder:text-slate-400 dark:placeholder:text-slate-500
                                    focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm text-right font-semibold">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400">VNĐ</span>
                        </div>
                    </div>
                </div>
            </form>
            <div class="p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <button type="button" @click="closeShiftCloseModal()" class="px-5 py-2.5 text-center text-sm font-semibold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">Hủy</button>
                <button type="submit" form="admin-close-shift-form" class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-colors shadow-lg shadow-blue-500/20">Xác nhận Kết Ca</button>
            </div>
        </div>
    </div>

    <div x-show="isLetanShiftCloseModalOpen" 
         @keydown.escape.window="closeLetanShiftCloseModal()" 
         class="modal fixed inset-0 z-[10001] flex items-center justify-center p-4" 
         x-cloak>
        <div x-show="isLetanShiftCloseModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-black/40 backdrop-blur-sm"></div>

        <div @click.outside="closeLetanShiftCloseModal()" 
             x-show="isLetanShiftCloseModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
             class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="grid place-items-center w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <h2 class="text-lg font-semibold text-slate-800 dark:text-white">Kết Ca (Lễ Tân)</h2>
                </div>
                <button @click="closeLetanShiftCloseModal()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="letan-close-shift-form" @submit.prevent="submitLetanCloseShift" class="p-5 space-y-5 overflow-y-auto">
                
                <div>
                    <label for="letan_pms_revenue" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                        Doanh thu PMS của chi nhánh <span class="text-rose-500">*</span>
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.5 4A1.5 1.5 0 0 0 1 5.5V6h18v-.5A1.5 1.5 0 0 0 17.5 4h-15Z" /><path d="M1 7.5v7A1.5 1.5 0 0 0 2.5 16h15a1.5 1.5 0 0 0 1.5-1.5v-7H1ZM5 10.25a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h8.5a.75.75 0 0 0 0-1.5h-8.5Z" /></svg>
                        </div>
                        <input type="text" id="letan_pms_revenue" x-model="letanShiftClose.pmsRevenue" @input="handleAmountInput($event, 'letan_pms')" placeholder="0" required
                            class="block w-full rounded-lg border-0 py-2.5 pl-10 pr-14 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                    ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                    placeholder:text-slate-400 dark:placeholder:text-slate-500
                                    focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm text-right font-semibold">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400">VNĐ</span>
                        </div>
                    </div>
                </div>
                <!-- THÊM: Các trường tính toán tự động -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-700">
                        <p class="font-medium text-slate-500 dark:text-slate-400">Quầy</p>
                        <p class="mt-1 text-lg font-bold text-slate-800 dark:text-slate-100" 
                           x-text="formatCurrency(letanCounterCash)"></p>
                    </div>
                    <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-700">
                        <p class="font-medium text-slate-500 dark:text-slate-400">Tổng quầy</p>
                        <p class="mt-1 text-lg font-bold text-slate-800 dark:text-slate-100"
                           x-text="formatCurrency(letanTotalCounter)"></p>
                    </div>
                </div>


            </form>
            <div class="p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <button type="button" @click="closeLetanShiftCloseModal()" class="px-5 py-2.5 text-center text-sm font-semibold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">Hủy</button>
                <button type="submit" form="letan-close-shift-form" class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-colors shadow-lg shadow-blue-500/20">Xác nhận Kết Ca</button>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- ============ MODAL XÁC THỰC MẬT KHẨU BOSS (MỚI) ================== -->
    <!-- ================================================================== -->
    <div x-show="isBossAuthModalOpen" 
        @keydown.escape.window="closeBossAuthModal()" 
        @click="closeBossAuthModal()" class="modal fixed inset-0 z-[10002] flex items-center justify-center p-4" 
        x-cloak>
        
        <div x-show="isBossAuthModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-black/40 backdrop-blur-sm"></div>

        <div @click.stop x-show="isBossAuthModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
            class="relative w-full max-w-sm bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col">
            
            <div class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="grid place-items-center w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-900/50">
                        <svg class="w-5 h-5 text-amber-600 dark:text-amber-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                    </div>
                    <h2 class="text-lg font-semibold text-slate-800 dark:text-white">Yêu cầu xác thực</h2>
                </div>
                <button @click="closeBossAuthModal()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <form id="boss-auth-form" @submit.prevent="verifyBossPasswordAndProceed" class="p-5 space-y-4">
                <p class="text-sm text-slate-600 dark:text-slate-300">Hành động này cần sự phê duyệt của quản lý cấp cao. Vui lòng nhập thông tin tài khoản Admin/Boss.</p>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.5 5.5 0 0 0-5.5 5.5a.75.75 0 0 0 1.5 0a4 4 0 0 1 8 0a.75.75 0 0 0 1.5 0A5.5 5.5 0 0 0 10 12Z" clip-rule="evenodd" /></svg></div>
                    <input type="text" x-model="bossAuth.username" placeholder="Tên đăng nhập Admin/Boss..." required class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-300 dark:ring-slate-700 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                </div>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 0 0-4.5 4.5V9H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-.5V5.5A4.5 4.5 0 0 0 10 1Zm3 8V5.5a3 3 0 1 0-6 0V9h6Z" clip-rule="evenodd" /></svg></div>
                    <input type="password" x-model="bossAuth.password" placeholder="Mật khẩu..." required class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-300 dark:ring-slate-700 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                </div>
            </form>
            
            <div class="p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <button type="button" @click="closeBossAuthModal()" class="px-5 py-2.5 text-center text-sm font-semibold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">Hủy</button>
                <button type="submit" form="boss-auth-form" class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-colors shadow-lg shadow-blue-500/20">Xác nhận</button>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-sm mb-6">
        <div class="p-4">
            <div id="search-filters" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 
                            {% if user.role == 'letan' %}lg:grid-cols-4{% else %}lg:grid-cols-5{% endif %} 
                            gap-4">                    
                    <!-- 1. Chọn ngày tạo -->
                    <div>
                        <input type="text" id="created_date" placeholder="Chọn ngày tạo..." class="datepicker w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    
                    <!-- 2. Chọn chi nhánh -->
                    {% if user.role != 'letan' %}
                    <div>
                        <select id="chi_nhanh" @change="currentPage = 1; fetchData(); fetchDashboardSummary()" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="" selected>Tất cả chi nhánh</option>
                            {% for b in branches %}<option value="{{ b }}" {% if b == branch_filter %}selected{% endif %}>{{ b }}</option>{% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <!-- 3. Loại giao dịch -->
                    <div>
                        <select id="transaction_type" @change="currentPage = 1; fetchData(); fetchDashboardSummary()" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">Tất cả loại GD</option>
                            {% for t in transaction_types %}<option value="{{ t.value }}" {% if t.value == type_filter %}selected{% endif %}>{{ type_display_map.get(t.value, t.value) }}</option>{% endfor %}
                        </select>
                    </div>
                    
                    <!-- 4. Chọn trạng thái -->
                    <div>
                        <select id="status" @change="currentPage = 1; fetchData(); fetchDashboardSummary()" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">Tất cả trạng thái</option>
                            {% for s in statuses %}<option value="{{ s.value }}" {% if s.value == status_filter %}selected{% endif %}>{{ status_display_map.get(s.value, s.value) }}</option>{% endfor %}
                            {% if user.role in ['admin', 'boss'] %}<option value="DELETED" class="text-rose-600 font-medium">Đã xoá</option>{% endif %}
                        </select>
                    </div>

                    <!-- 5. Tìm theo mã GD -->
                    <div class="lg:col-span-1">
                        <input type="search" id="search" @keydown.enter.prevent="document.getElementById('apply-filters').click()" class="w-full py-2.5 px-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Tìm theo mã GD...">
                    </div>
                </div>
                <div class="flex flex-wrap justify-between items-center gap-4 pt-2">
                    <div class="flex items-center gap-3">
                        <button id="apply-filters" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow-md flex items-center gap-2 font-semibold transition text-sm">Áp dụng</button>
                        <button id="clear-filters" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-slate-800 dark:text-slate-100 px-5 py-2 rounded-lg flex items-center gap-2 font-medium transition text-sm">Xóa bộ lọc</button>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- THÊM LẠI: Nút kết ca cho Admin/Boss/Quản lý -->
                        <button x-show="userRole === 'admin' || userRole === 'boss' || userRole === 'quanly'" 
                                @click="closeAllPending()"
                                class="bg-gradient-to-r from-rose-500 to-orange-500 hover:from-orange-600 hover:to-rose-600 text-white px-5 py-2 rounded-lg shadow-md flex items-center gap-2 font-semibold transition text-sm">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span>Kết Ca Chi Nhánh</span>
                        </button>

                        <button @click="openAddModal()" class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-blue-600 hover:to-green-600 text-white px-5 py-2 rounded-lg shadow-md flex items-center gap-2 font-semibold transition text-sm">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                            <span>Thêm Giao Dịch</span> </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-4 flex flex-col sm:flex-row justify-between items-center gap-4 transition-all duration-300">
        <div class="flex items-center gap-4">
            {% if user.role in ['letan', 'quanly', 'admin', 'boss'] %}
            <button id="delete-selected-btn" @click="batchDelete" x-show="selectedIds.length > 0" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition font-semibold text-sm flex items-center gap-2 shadow-sm hover:shadow-md active:scale-95" x-cloak>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Xóa (<span x-text="selectedIds.length"></span>) mục
            </button>
            {% endif %}
            <div class="flex items-center gap-2">
                <label for="per-page-select" class="text-sm font-medium text-slate-600 dark:text-slate-300 whitespace-nowrap">Hiển thị:</label>
                <select id="per-page-select" @change="changePerPage($event.target.value)" x-model="recordsPerPage" class="block rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2 pl-3 pr-8 text-sm">
                    <option value="9">9</option>
                    <option value="18">18</option>
                    <option value="36">36</option>
                    <option value="54">54</option>
                </select>
            </div>
            <p id="record-count" class="text-sm text-slate-500 dark:text-slate-400 font-medium"></p>
        </div>
        <div id="pagination-container" class="w-full sm:w-auto flex justify-center items-center mt-4 sm:mt-0">
            <div id="pagination-controls" class="flex justify-center items-center gap-1"></div>
        </div>
    </div>


    <div class="w-full bg-white dark:bg-slate-900/70 overflow-hidden rounded-2xl shadow-md border border-slate-200 dark:border-slate-800 transition-all duration-300 mb-6 hidden lg:block">
        <div class="overflow-auto max-h-[65vh]">
            <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400 border-collapse">
                <thead class="sticky top-0 z-10 text-xs text-slate-700 uppercase dark:text-slate-400 bg-gradient-to-b from-slate-100 to-slate-50 dark:from-slate-800 dark:to-slate-700 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                        {% if user.role in ['letan', 'quanly', 'admin', 'boss'] %}
                        
                        <th scope="col" class="w-12 px-4 py-3 text-center">
                            <input type="checkbox" id="select-all-checkbox" @click="toggleSelectAll" 
                                :checked="allSelectableChecked" class="h-4 w-4 rounded border-gray-300 dark:border-slate-600 text-blue-600 focus:ring-blue-500 bg-white dark:bg-slate-700">
                        </th>
                        {% endif %}
                        <th scope="col" class="w-28 px-4 py-3 text-left sortable" @click="sortBy('transaction_code')"> Mã GD
                            <span class="sort-indicator"></span>
                        </th>
                        <th scope="col" class="w-40 px-4 py-3 text-left sortable" @click="sortBy('created_datetime')"> Thời Gian
                            <span class="sort-indicator"></span>
                        </th>
                        <th scope="col" class="w-40 px-4 py-3 text-left sortable" @click="sortBy('recorded_by')"> Người Ghi Nhận
                            <span class="sort-indicator"></span>
                        </th>
                        <th scope="col" class="w-36 px-4 py-3 text-left sortable" @click="sortBy('room_number')"> Số Phòng
                            <span class="sort-indicator"></span>
                        </th>
                        <th scope="col" class="w-64 px-4 py-3 text-left"> Thông tin GD
                        </th>
                        <th scope="col" class="w-36 px-4 py-3 text-left sortable" @click="sortBy('transaction_type')"> Loại Giao Dịch
                            <span class="sort-indicator"></span>
                        </th>
                        <th scope="col" class="w-40 px-4 py-3 text-right sortable" @click="sortBy('amount')"> Số Tiền
                            <span class="sort-indicator"></span>
                        </th>
                        <th scope="col" class="w-32 px-4 py-3 text-center sortable" @click="sortBy('status')"> 
                            Trạng thái
                            <span class="sort-indicator"></span>
                        </th>
                        <th scope="col" class="w-24 px-4 py-3 text-center">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-if="loading">
                        <!-- SKELETON LOADER CHO BẢNG -->
                        <template x-for="i in (recordsPerPage || 9)" :key="i">
                            <tr class="animate-pulse">
                                <td x-show="canDelete" class="px-4 py-4 text-center">
                                    <div class="h-4 w-4 bg-slate-200 dark:bg-slate-700 rounded"></div>
                                </td>
                                <td class="px-4 py-4"><div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-20"></div></td>
                                <td class="px-4 py-4"><div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-32"></div></td>
                                <td class="px-4 py-4"><div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-28"></div></td>
                                <td class="px-4 py-4"><div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-16"></div></td>
                                <td class="px-4 py-4"><div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-48"></div></td>
                                <td class="px-4 py-4"><div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-24"></div></td>
                                <td class="px-4 py-4">
                                    <div class="flex justify-end">
                                        <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-24"></div>
                                    </div>
                                </td>
                                <td class="px-4 py-4"><div class="h-6 bg-slate-200 dark:bg-slate-700 rounded-full w-20 mx-auto"></div></td>
                                <td class="px-4 py-4"><div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-12 mx-auto"></div></td>
                            </tr>
                        </template>
                    </template>
                    <template x-if="records.length === 0 && !loading">
                        <tr>
                            <td :colspan="canDelete ? 9 : 8" 
                                class="text-center py-16 text-slate-500 dark:text-slate-400">
                                Không tìm thấy giao dịch nào.
                            </td>
                        </tr>
                    </template>
                    <template x-for="item in records" :key="item.id">
                        <tr @click='openDetailsModal(item)' 
                            class="bg-white border-b dark:bg-slate-900 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/60 transition-colors duration-150 cursor-pointer"
                            :class="{ 'opacity-60': item.status.includes('Đã xoá') }">
                            
                            <td x-show="canDelete" class="px-4 py-3 text-center" @click.stop>
                                <input type="checkbox" @click="handleCheckboxClick($event, item.id)" :checked="selectedIds.includes(item.id)"
                                       :disabled="item.status === 'Đã kết ca'"
                                       class="row-checkbox h-4 w-4 rounded border-gray-300 dark:border-slate-600 text-blue-600 focus:ring-blue-500 bg-white dark:bg-slate-700 pointer-events-auto"
                                       :class="{ 'cursor-not-allowed opacity-50': item.status === 'Đã kết ca' }"
                                >
                            </td>
                            
                            <td class="px-4 py-3 text-left font-medium text-slate-800 dark:text-slate-200" 
                                x-text="item.transaction_code"></td>
                            <td class="px-4 py-3 text-left" x-text="formatDate(item.created_datetime)"></td>
                            <td class="px-4 py-3 text-left" x-text="item.recorded_by || 'N/A'"></td>
                            <td class="px-4 py-3 text-left font-medium" x-text="item.room_number || '-'"></td>
                            <td class="px-4 py-3 text-left max-w-xs truncate" :title="item.transaction_info" x-text="item.transaction_info || '-'"></td>
                            <td class="px-4 py-3 text-left" x-text="item.transaction_type_display"></td>
                            <td class="px-4 py-3 text-right font-semibold" 
                                :class="item.amount >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'"
                                x-text="formatCurrency(item.amount)">
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold"
                                      :class="getStatusInfo(item.status).badge" 
                                      x-text="item.status"></span>
                            </td>

                            <td class="px-4 py-3 text-center" @click.stop>
                                <div class="flex justify-center items-center gap-2">
                                    <button x-show="hasEditPermission && item.status === 'Chờ xử lý'" @click='openEditModal(item)' title="Sửa" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 transition"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg></button>
                                    
                                    <button x-show="canDelete && item.status === 'Chờ xử lý'" @click="deleteItem(item.id, false)" title="Xóa" class="text-rose-600 hover:text-rose-800 dark:text-rose-400 dark:hover:text-rose-300 transition"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <div id="error" class="hidden text-center py-16 bg-rose-100 text-rose-700 rounded-lg"><p>Có lỗi xảy ra khi tải dữ liệu.</p></div>

    <div class="block lg:hidden w-full scroll-smooth space-y-4">
        <template x-if="loading">
            <!-- SKELETON LOADER CHO CARD -->
            <template x-for="i in 5" :key="i">
                <div class="animate-pulse rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 space-y-3">
                    <div class="flex justify-between items-start">
                        <div class="space-y-2 flex-1 pr-4">
                            <div class="h-5 bg-slate-200 dark:bg-slate-700 rounded w-3/5"></div>
                            <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-2/5"></div>
                        </div>
                        <div class="h-6 w-24 bg-slate-200 dark:bg-slate-700 rounded-full"></div>
                    </div>
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-full"></div>
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-4/5"></div>
                </div>
            </template>
        </template>
        <template x-if="records.length === 0 && !loading">
            <div class="text-center py-16 text-slate-500 dark:text-slate-400">
                Không tìm thấy giao dịch nào.
            </div>
        </template>
        <template x-for="item in records" :key="item.id">
            <div @click='openDetailsModal(item)' 
                 class="relative overflow-hidden rounded-2xl shadow-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800"
                 :class="{ 'opacity-60': item.status.includes('Đã xoá') }">
                <div class="p-4 flex flex-col gap-2">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 pr-4">
                            <div class="font-semibold text-slate-800 dark:text-slate-100" x-text="item.transaction_code"></div>
                            <div class="text-sm text-blue-600 dark:text-blue-400 font-medium" x-text="item.transaction_type_display"></div>
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold"
                              :class="getStatusInfo(item.status).badge"
                              x-text="item.status"></span>
                    </div>
                    <div class="text-sm text-slate-600 dark:text-slate-300">
                        <p><strong>Số tiền:</strong> 
                            <span class="font-semibold"
                                  :class="item.amount >= 0 ? 'text-emerald-700 dark:text-emerald-400' : 'text-rose-700 dark:text-rose-400'"
                                  x-text="formatCurrency(item.amount)">
                            </span>
                        </p>
                        <p x-show="item.room_number">
                            <strong>Số phòng:</strong> 
                            <span class="font-semibold" x-text="item.room_number"></span>
                        </p>
                        <p x-show="item.transaction_info">
                            <strong>Thông tin:</strong> 
                            <span class="font-medium" x-text="item.transaction_info"></span>
                        </p>
                        <p><strong>Người ghi:</strong> <span x-text="item.recorded_by || 'N/A'"></span></p>
                        <p x-show="userRole !== 'letan' && item.chi_nhanh" 
                           class="text-xs text-slate-500 dark:text-slate-400" 
                           x-text="'Chi nhánh: ' + item.chi_nhanh"></p>
                    </div>
                    <div class="text-xs text-slate-500 dark:text-slate-400 pt-2 border-t border-slate-200 dark:border-slate-700 mt-2"
                         x-text="formatDate(item.created_datetime)">
                    </div>
                    <div class="absolute top-3 right-3 flex flex-col gap-2">
                        <button x-show="hasEditPermission && item.status === 'Chờ xử lý'" @click.stop='openEditModal(item)' title="Sửa" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-700 text-yellow-600 dark:text-yellow-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg></button>
                    </div>
                </div>
            </div>
        </template>
    </div>
    
    <div x-show="isAddModalOpen" 
         @keydown.escape.window="closeAddModal()" 
         class="modal fixed inset-0 z-50 flex items-center justify-center p-4"
         x-cloak>
        <div x-show="isAddModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-black/40 backdrop-blur-sm"></div>
    
        <div @click.outside="closeAddModal()" 
             x-show="isAddModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
             class="relative w-full max-w-2xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-h-[90vh] flex flex-col"> <div class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="grid place-items-center w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50">
                            <svg class="w-5 h-5 text-blue-600 dark:text-blue-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0l.879-.659M12 21a9 9 0 110-18 9 9 0 010 18z" /></svg>
                    </div>
                    <h2 class="text-lg font-semibold text-slate-800 dark:text-white">Ghi nhận Giao Dịch Mới</h2>
                </div>
                <button @click="closeAddModal()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
    
            <form id="add-item-form" @submit.prevent="submitAddItemForm" class="p-5 space-y-5 overflow-y-auto">
                <!-- Người tạo và Chi nhánh (Hiển thị khác nhau tùy vai trò) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Người tạo -->
                    <div x-show="userRole === 'admin' || userRole === 'boss' || userRole === 'quanly'" class="relative">
                        <label for="add_recorded_by_search" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                            Người ghi nhận <span class="text-rose-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.5 5.5 0 0 0-5.5 5.5a.75.75 0 0 0 1.5 0a4 4 0 0 1 8 0a.75.75 0 0 0 1.5 0A5.5 5.5 0 0 0 10 12Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input type="text" id="add_recorded_by_search" placeholder="Mặc định là bạn..." autocomplete="off"
                                @input.debounce.300ms="searchRecorders($event.target.value)"
                                @focus="searchRecorders($event.target.value)"
                                class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                        ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                        placeholder:text-slate-400 dark:placeholder:text-slate-500
                                        focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                            <input type="hidden" id="add_recorded_by" name="recorded_by">
                        </div>
                        <div x-show="recorderSuggestions.length > 0" @click.outside="recorderSuggestions = []"
                            class="absolute z-20 mt-1 w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md shadow-lg max-h-48 overflow-auto">
                            <template x-for="recorder in recorderSuggestions" :key="recorder.code">
                                <div @click="selectRecorder(recorder)"
                                    class="cursor-pointer select-none relative py-2 px-3 text-slate-900 dark:text-slate-200 hover:bg-blue-500 hover:text-white"
                                    x-text="`${recorder.name} (${recorder.code})`">
                                </div>
                            </template>
                        </div>
                    </div>
                    <div x-show="userRole === 'letan'" class="relative">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                            Người ghi nhận
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.5 5.5 0 0 0-5.5 5.5a.75.75 0 0 0 1.5 0a4 4 0 0 1 8 0a.75.75 0 0 0 1.5 0A5.5 5.5 0 0 0 10 12Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm font-semibold" x-text="user.name"></div>
                            <input type="hidden" name="recorded_by" :value="user.name">
                        </div>
                    </div>
                    
                    <!-- Chi nhánh -->
                    <div x-show="userRole === 'admin' || userRole === 'boss' || userRole === 'quanly'">
                        <label for="add_chi_nhanh" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                            Chi nhánh <span class="text-rose-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <select id="add_chi_nhanh" name="chi_nhanh" 
                                :required="userRole === 'admin' || userRole === 'boss' || userRole === 'quanly'"
                                class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                    ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                    focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                                <option value="" disabled selected>Chọn chi nhánh</option>
                                {% for b in branches %}<option value="{{ b }}">{{ b }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div x-show="userRole === 'letan'" class="relative">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                            Chi nhánh
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm font-semibold" x-text="displayBranch"></div>
                            <input type="hidden" name="chi_nhanh" :value="displayBranch">
                        </div>
                    </div>
                </div>

                <div>
                    <label for="add_amount" class="block text-sm font-semibold text-slate-800 dark:text-slate-100 mb-1.5">
                        Số tiền
                        <span class="text-rose-500">*</span>
                    </label>
                    <div class="relative rounded-lg shadow-sm">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2.5 4A1.5 1.5 0 0 0 1 5.5V6h18v-.5A1.5 1.5 0 0 0 17.5 4h-15Z" />
                                <path d="M1 7.5v7A1.5 1.5 0 0 0 2.5 16h15a1.5 1.5 0 0 0 1.5-1.5v-7H1ZM5 10.25a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h8.5a.75.75 0 0 0 0-1.5h-8.5Z" />
                            </svg>
                        </div>
                        <input type="text" x-model="formattedAmount" @input="handleAmountInput($event, 'add')"
                            inputmode="numeric" placeholder="0" required
                            class="block w-full rounded-lg border-0 py-3 pl-10 pr-14 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                    ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                    placeholder:text-slate-400 dark:placeholder:text-slate-500
                                    focus:ring-2 focus:ring-inset focus:ring-blue-500
                                    text-right font-semibold text-xl">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400">VNĐ</span>
                        </div>
                        <input type="hidden" id="add_amount" name="amount" :value="getRawAmount('add')">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="add_transaction_type" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                            Loại giao dịch <span class="text-rose-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.5 3A2.5 2.5 0 0 0 3 5.5v2.879a.75.75 0 0 0 .22.53l6.101 6.1a.75.75 0 0 0 1.06 0l2.879-2.879a.75.75 0 0 0 0-1.06L7.16 5.22a.75.75 0 0 0-.53-.22H5.5ZM3.75 6a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd" /></svg>
                            </div>
                            <select id="add_transaction_type" name="transaction_type" x-model="addTransactionType" required
                                    class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                        ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                        focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                                <option value="" disabled selected>Chọn loại giao dịch</option>
                                {% for t in transaction_types %}
                                <option value="{{ t.value }}">{{ type_display_map.get(t.value, t.value) }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="add_room_number" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                            Số phòng
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M11.01 3.51a.75.75 0 0 1 .497.462l1.668 5.003 5.004 1.668a.75.75 0 0 1 .018 1.41l-5.004 1.667-1.668 5.004a.75.75 0 0 1-1.41-.018l-1.667-5.004-5.004-1.668a.75.75 0 0 1-.018-1.41l5.004-1.667 1.667-5.003a.75.75 0 0 1 .913-.445ZM4.12 8.12a.75.75 0 0 1 .445.913l-.5 1.5.5 1.5a.75.75 0 0 1-.913.445l-1.5-.5-1.5.5a.75.75 0 0 1-.445-.913l.5-1.5-.5-1.5a.75.75 0 0 1 .913-.445l1.5.5 1.5-.5Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input type="text" id="add_room_number" name="room_number" placeholder="VD: 201, 302..."
                                class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                        ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                        placeholder:text-slate-400 dark:placeholder:text-slate-500
                                        focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <div>
                    <label for="add_transaction_info" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                        Thông tin giao dịch
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pt-2.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m2.695 14.763 1.262-3.155a.5.5 0 0 1 .47-.325H11.5a.5.5 0 0 1 0 1H4.928l-.34 1.156 4.704 1.679a.5.5 0 0 1 .326.47l-.34 3.154a.5.5 0 0 1-.94.066l-1.262-3.155A.5.5 0 0 1 2.695 14.763Z" /><path d="M13.5 3A2.5 2.5 0 0 0 11 5.5V11h4.5a2.5 2.5 0 0 0 2.5-2.5V5.5A2.5 2.5 0 0 0 15.5 3h-2Z" /></svg>
                        </div>
                        <textarea id="add_transaction_info" name="transaction_info" rows="3"
                                placeholder="VD: Mã booking, tên khách, chi tiết chi tiêu..."
                                class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                        ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                        placeholder:text-slate-400 dark:placeholder:text-slate-500
                                        focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"></textarea>
                    </div>
                </div>
                
            </form>
    
            <div class="p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <button type="button" @click="closeAddModal()" class="px-5 py-2.5 text-center text-sm font-semibold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">Hủy</button>
                <button type="submit" form="add-item-form" class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-colors shadow-lg shadow-blue-500/20">Lưu Giao Dịch</button>
            </div>
        </div>
    </div>

    <div x-show="isEditModalOpen" 
         @keydown.escape.window="closeEditModal()" 
         class="modal fixed inset-0 z-[10001] flex items-center justify-center p-4" 
         x-cloak>
        <div x-show="isEditModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-black/40 backdrop-blur-sm"></div>
    
        <div @click.outside="closeEditModal()" 
             x-show="isEditModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
             class="relative w-full max-w-2xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-h-[90vh] flex flex-col"> <div class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="grid place-items-center w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/50">
                            <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-slate-800 dark:text-white">Chỉnh sửa Giao dịch</h2>
                </div>
                <button @click="closeEditModal()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
    
            <form id="edit-item-form" @submit.prevent="submitEditForm()" x-bind:action="'/shift-report/edit-details/' + editItem.id" class="p-5 space-y-5 overflow-y-auto">
                <input type="hidden" name="item_id" x-model="editItem.id">

                <div x-show="userRole === 'admin' || userRole === 'boss' || userRole === 'quanly'" class="relative">
                    <label for="edit_recorded_by_search" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                        Người ghi nhận (Admin)
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.5 5.5 0 0 0-5.5 5.5a.75.75 0 0 0 1.5 0a4 4 0 0 1 8 0a.75.75 0 0 0 1.5 0A5.5 5.5 0 0 0 10 12Z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="text" id="edit_recorded_by_search" placeholder="Tìm người ghi nhận..." autocomplete="off"
                            @input.debounce.300ms="searchRecorders($event.target.value, 'edit')"
                            @focus="searchRecorders($event.target.value, 'edit')"
                            x-model="editItem.recorded_by"
                            class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                    ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                    placeholder:text-slate-400 dark:placeholder:text-slate-500
                                    focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                        <input type="hidden" id="edit_recorded_by" name="recorded_by" x-model="editItem.recorded_by">
                    </div>
                    <div x-show="recorderSuggestions.length > 0" @click.outside="recorderSuggestions = []"
                        class="absolute z-20 mt-1 w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md shadow-lg max-h-48 overflow-auto">
                        <template x-for="recorder in recorderSuggestions" :key="recorder.code">
                            <div @click="selectRecorder(recorder, 'edit')"
                                class="cursor-pointer select-none relative py-2 px-3 text-slate-900 dark:text-slate-200 hover:bg-blue-500 hover:text-white"
                                x-text="`${recorder.name} (${recorder.code})`">
                            </div>
                        </template>
                    </div>
                </div>

                {% if user.role in ['quanly', 'admin', 'boss'] %}
                <div x-show="userRole === 'admin' || userRole === 'boss' || userRole === 'quanly'">
                    <label for="edit_chi_nhanh" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                        Chi nhánh <span class="text-rose-500">*</span>
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <select id="edit_chi_nhanh" name="chi_nhanh" x-model="editItem.chi_nhanh" required
                                class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                    ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                    focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                            <option value="" disabled>Chọn chi nhánh</option>
                            {% for b in branches %}<option value="{{ b }}">{{ b }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                {% endif %}

                <div>
                    <label for="edit_amount" class="block text-sm font-semibold text-slate-800 dark:text-slate-100 mb-1.5">
                        Số tiền
                        <span class="text-rose-500">*</span>
                    </label>
                    <div class="relative rounded-lg shadow-sm">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2.5 4A1.5 1.5 0 0 0 1 5.5V6h18v-.5A1.5 1.5 0 0 0 17.5 4h-15Z" />
                                <path d="M1 7.5v7A1.5 1.5 0 0 0 2.5 16h15a1.5 1.5 0 0 0 1.5-1.5v-7H1ZM5 10.25a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h8.5a.75.75 0 0 0 0-1.5h-8.5Z" />
                            </svg>
                        </div>
                        <input type="text" x-model="formattedAmount" @input="handleAmountInput($event, 'edit')"
                            inputmode="numeric" placeholder="0" required
                            class="block w-full rounded-lg border-0 py-3 pl-10 pr-14 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                    ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                    placeholder:text-slate-400 dark:placeholder:text-slate-500
                                    focus:ring-2 focus:ring-inset focus:ring-blue-500
                                    text-right font-semibold text-xl">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                            <span class="text-sm font-medium text-slate-500 dark:text-slate-400">VNĐ</span>
                        </div>
                        <input type="hidden" id="edit_amount" name="amount" :value="getRawAmount('edit')">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="edit_transaction_type" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                            Loại giao dịch <span class="text-rose-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.5 3A2.5 2.5 0 0 0 3 5.5v2.879a.75.75 0 0 0 .22.53l6.101 6.1a.75.75 0 0 0 1.06 0l2.879-2.879a.75.75 0 0 0 0-1.06L7.16 5.22a.75.75 0 0 0-.53-.22H5.5ZM3.75 6a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd" /></svg>
                            </div>
                            <select id="edit_transaction_type" name="transaction_type" x-model="editItem.transaction_type" required
                                    class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                        ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                        focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                                <option value="" disabled>Chọn loại giao dịch</option>
                                {% for t in transaction_types %}
                                <option value="{{ t.value }}">{{ type_display_map.get(t.value, t.value) }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="edit_room_number" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                            Số phòng
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M11.01 3.51a.75.75 0 0 1 .497.462l1.668 5.003 5.004 1.668a.75.75 0 0 1 .018 1.41l-5.004 1.667-1.668 5.004a.75.75 0 0 1-1.41-.018l-1.667-5.004-5.004-1.668a.75.75 0 0 1-.018-1.41l5.004-1.667 1.667-5.003a.75.75 0 0 1 .913-.445ZM4.12 8.12a.75.75 0 0 1 .445.913l-.5 1.5.5 1.5a.75.75 0 0 1-.913.445l-1.5-.5-1.5.5a.75.75 0 0 1-.445-.913l.5-1.5-.5-1.5a.75.75 0 0 1 .913-.445l1.5.5 1.5-.5Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input type="text" id="edit_room_number" name="room_number" x-model="editItem.room_number" placeholder="VD: 201, 302..."
                                class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                        ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                        placeholder:text-slate-400 dark:placeholder:text-slate-500
                                        focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <div>
                    <label for="edit_transaction_info" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                        Thông tin giao dịch
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pt-2.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m2.695 14.763 1.262-3.155a.5.5 0 0 1 .47-.325H11.5a.5.5 0 0 1 0 1H4.928l-.34 1.156 4.704 1.679a.5.5 0 0 1 .326.47l-.34 3.154a.5.5 0 0 1-.94.066l-1.262-3.155A.5.5 0 0 1 2.695 14.763Z" /><path d="M13.5 3A2.5 2.5 0 0 0 11 5.5V11h4.5a2.5 2.5 0 0 0 2.5-2.5V5.5A2.5 2.5 0 0 0 15.5 3h-2Z" /></svg>
                        </div>
                        <textarea id="edit_transaction_info" name="transaction_info" x-model="editItem.transaction_info" rows="3"
                                placeholder="VD: Mã booking, tên khách, chi tiết chi tiêu..."
                                class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white
                                        ring-1 ring-inset ring-slate-300 dark:ring-slate-700
                                        placeholder:text-slate-400 dark:placeholder:text-slate-500
                                        focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"></textarea>
                    </div>
                </div>
            </form>
    
            <div class="p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <button type="button" @click="closeEditModal()" class="px-5 py-2.5 text-center text-sm font-semibold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">Hủy</button>
                <button type="submit" form="edit-item-form" class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-colors shadow-lg shadow-blue-500/20">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <div x-show="isHandoverModalOpen" 
     @keydown.escape.window="closeHandoverModal()" 
     class="modal fixed inset-0 z-[10002] flex items-center justify-center p-4" 
     x-cloak>
        <div x-show="isHandoverModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>

        <div @click.outside="closeHandoverModal()" 
            x-show="isHandoverModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
            class="relative w-full max-w-4xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-h-[90vh] flex flex-col">
            
            <div id="handover-modal-content" class="flex flex-col bg-white dark:bg-slate-800 rounded-2xl overflow-y-auto">
                <div class="flex items-start justify-between p-5 border-b border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-4">
                        <div class="grid place-items-center w-12 h-12 rounded-xl bg-purple-100 dark:bg-purple-900/50">
                            <svg class="w-6 h-6 text-purple-600 dark:text-purple-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.174C2.996 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.746-1.994-1.802-2.169a47.82 47.82 0 00-1.134-.174 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0z" /></svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Biên Bản Giao Ca</h2>
                            <div class="mt-1.5 text-sm text-slate-500 dark:text-slate-400 flex flex-wrap items-center gap-x-2">
                                <span class="font-semibold" x-text="user.name || '...'"></span>
                                <span>&bull;</span>
                                <span x-text="displayBranch || '...'"></span> <span>&bull;</span>
                                <span x-text="formatDate(new Date().toISOString())"></span>
                            </div>
                        </div>
                    </div>
                    <button @click="closeHandoverModal()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="p-5 space-y-5">
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">

                        <div class="p-5 rounded-xl bg-white dark:bg-slate-800 shadow-lg border border-slate-200 dark:border-slate-700 flex flex-col justify-center">
                            <div class="flex items-center gap-2.5 mb-1">
                                <svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.23 13.28l-2.002 2.002a2.824 2.824 0 01-4 0l-1.5-1.5a2.824 2.824 0 010-4l2.002-2.002M7.5 7.5h.008v.008H7.5V7.5zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                                <h3 class="text-base font-medium text-slate-600 dark:text-slate-300">Doanh thu PMS</h3>
                            </div>
                            <div class="flex items-baseline justify-end gap-1.5">
                                <p class="text-3xl font-bold text-blue-600 dark:text-blue-400"
                                x-text="formatCurrency(letanPmsRevenueValue)"></p>
                                <span class="text-sm font-medium text-blue-600 dark:text-blue-400">VNĐ</span>
                            </div>
                        </div>

                        <div class="lg:col-span-2 p-5 rounded-xl bg-white dark:bg-slate-800 shadow-lg border border-slate-200 dark:border-slate-700 space-y-4">
                            
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div class="p-4 rounded-lg bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">DT Online</p>
                                    <p class="text-xl font-bold text-blue-700 dark:text-blue-300" x-text="formatCurrency(onlineRevenueValue)"></p>
                                </div>
                                <div class="p-4 rounded-lg bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">DT Chi nhánh</p>
                                    <p class="text-xl font-bold text-green-700 dark:text-green-300" x-text="formatCurrency(branchRevenueValue)"></p>
                                </div>
                                <div class="p-4 rounded-lg bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Tiền mặt</p>
                                    <p class="text-xl font-bold text-amber-600 dark:text-amber-400" x-text="formatCurrency(letanCounterCash)"></p>
                                </div>
                            </div>

                            <div class="p-5 rounded-xl bg-gradient-to-r from-slate-700 to-slate-900 dark:from-slate-100 dark:to-white shadow-lg">
                                <div class="flex items-center justify-between">
                                    <span class="text-lg font-bold text-white dark:text-slate-900 flex items-center gap-2">
                                        <svg class="w-6 h-6 text-amber-400 dark:text-amber-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.75 7.5h16.5v-1.5c0-1.43-1.146-2.59-2.57-2.724A48.06 48.06 0 0012 3 48.06 48.06 0 006.32 3.276C4.895 3.41 3.75 4.57 3.75 6v1.5z" /></svg>
                                        TỔNG TIỀN QUẦY
                                    </span>
                                    <div class="flex items-baseline justify-end gap-1.5">
                                        <span class="text-3xl font-bold text-amber-400 dark:text-amber-600" x-text="formatCurrency(letanTotalCounter)"></span>
                                        <span class="text-base font-medium text-amber-400 dark:text-amber-600">VNĐ</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-base font-semibold text-slate-800 dark:text-white mb-3">
                            Có <span x-text="handoverTransactions.list.length" class="font-bold text-blue-600 dark:text-blue-400"></span> giao dịch đang chờ xử lý
                        </h3>
                        <div class="w-full bg-slate-50 dark:bg-slate-900/50 overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700">
                            <div>
                                <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400 border-collapse">
                                    <thead class="sticky top-0 z-10 text-xs text-slate-700 uppercase dark:text-slate-400 bg-slate-100 dark:bg-slate-800">
                                        <tr>
                                            <th scope="col" class="px-4 py-2.5">Mã GD</th>
                                            <th scope="col" class="px-4 py-2.5">Thời gian</th>
                                            <th scope="col" class="px-4 py-2.5">Loại GD</th>
                                            <th scope="col" class="px-4 py-2.5">Phòng</th>
                                            <th scope="col" class="px-4 py-2.5">Thông tin</th>
                                            <th scope="col" class="px-4 py-2.5 text-right">Số tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                        <template x-if="handoverTransactions.loading">
                                            <tr><td colspan="6" class="text-center py-8 text-slate-500 dark:text-slate-400">Đang tải danh sách giao dịch...</td></tr>
                                        </template>
                                        <template x-if="!handoverTransactions.loading && handoverTransactions.list.length === 0">
                                            <tr><td colspan="6" class="text-center py-8 text-slate-500 dark:text-slate-400">Không có giao dịch nào đang chờ xử lý.</td></tr>
                                        </template>
                                        <template x-for="tx in handoverTransactions.list" :key="tx.id">
                                            <tr>
                                                <td class="px-4 py-2.5 font-mono text-xs" x-text="tx.transaction_code"></td>
                                                <td class="px-4 py-2.5" x-text="formatDate(tx.created_datetime)"></td>
                                                <td class="px-4 py-2.5" x-text="tx.transaction_type_display"></td>
                                                <td class="px-4 py-2.5" x-text="tx.room_number || '-'"></td>
                                                <td class="px-4 py-2.5 max-w-xs truncate" :title="tx.transaction_info" x-text="tx.transaction_info || '-'"></td>
                                                <td class="px-4 py-2.5 text-right font-semibold" 
                                                    :class="tx.amount >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'"
                                                    x-text="formatCurrency(tx.amount)">
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-5 border-t border-slate-200 dark:border-slate-700 flex justify-end">
                <button type="button" @click="captureHandoverModal()" :disabled="isCapturing"
                        class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-purple-600 rounded-xl hover:bg-purple-700 active:bg-purple-800 transition-colors shadow-lg shadow-purple-500/20
                            flex items-center justify-center gap-2"
                        :class="{ 'opacity-50 cursor-not-allowed': isCapturing }">
                    <svg x-show="isCapturing" class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <svg x-show="!isCapturing" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    <span x-text="isCapturing ? 'Đang chụp...' : 'Tải & Sao chép (.png)'"></span>
                </button>
            </div>
        </div>
    </div>

    <div x-show="isDetailsModalOpen" 
         @keydown.escape.window="closeDetailsModal()" 
         class="modal fixed inset-0 z-[10000] flex items-center justify-center p-4" 
         x-cloak>
        <div x-show="isDetailsModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    
        <div @click.outside="closeDetailsModal()" 
             x-show="isDetailsModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
             class="relative w-full max-w-2xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-4">
                    <div class="grid place-items-center w-12 h-12 rounded-xl" :class="getStatusInfo(selectedItem.status).iconBg">
                        <svg class="w-6 h-6" :class="getStatusInfo(selectedItem.status).iconColor" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" x-html="getStatusInfo(selectedItem.status).iconPath"></svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white" x-text="selectedItem.transaction_code"></h2>
                        <div class="mt-1.5">
                            <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" :class="getStatusInfo(selectedItem.status).badge" x-text="selectedItem.status"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="closeDetailsModal()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div class="p-5 space-y-5 overflow-y-auto">
                <!-- THÔNG TIN THỜI GIAN & NGƯỜI THỰC HIỆN -->
                <div class="space-y-4 pb-5 border-b border-slate-200 dark:border-slate-700">
                    <!-- Thời gian tạo và Người ghi nhận -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Thời gian tạo</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd" /></svg></div>
                                <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm" x-text="formatDate(selectedItem.created_datetime)"></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Người ghi nhận</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.5 5.5 0 0 0-5.5 5.5a.75.75 0 0 0 1.5 0a4 4 0 0 1 8 0a.75.75 0 0 0 1.5 0A5.5 5.5 0 0 0 10 12Z" clip-rule="evenodd" /></svg></div>
                                <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm" x-text="selectedItem.recorded_by || 'N/A'"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Thông tin kết ca (hiển thị nếu có ngày kết ca) -->
                    <div x-show="selectedItem.closed_datetime" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Thời gian kết ca</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd" /></svg></div>
                                <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm" x-text="formatDate(selectedItem.closed_datetime) || 'N/A'"></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Người kết ca</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.5 5.5 0 0 0-5.5 5.5a.75.75 0 0 0 1.5 0a4 4 0 0 1 8 0a.75.75 0 0 0 1.5 0A5.5 5.5 0 0 0 10 12Z" clip-rule="evenodd" /></svg></div>
                                <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm" x-text="selectedItem.closed_by || 'N/A'"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Thông tin xoá (hiển thị nếu có ngày xoá) -->
                    <div x-show="selectedItem.deleted_datetime" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Thời gian xoá</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd" /></svg></div>
                                <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm" x-text="formatDate(selectedItem.deleted_datetime) || 'N/A'"></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Người xoá</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.5 5.5 0 0 0-5.5 5.5a.75.75 0 0 0 1.5 0a4 4 0 0 1 8 0a.75.75 0 0 0 1.5 0A5.5 5.5 0 0 0 10 12Z" clip-rule="evenodd" /></svg></div>
                                <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm" x-text="selectedItem.deleted_by || 'N/A'"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Chi nhánh -->
                <div x-show="userRole !== 'letan' && selectedItem.chi_nhanh">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Chi nhánh</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm font-semibold" x-text="selectedItem.chi_nhanh || 'N/A'"></div>
                    </div>
                </div>
                <!-- Số tiền -->
                <div>
                    <label class="block text-sm font-semibold text-slate-800 dark:text-slate-100 mb-1.5">Số tiền</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.5 4A1.5 1.5 0 0 0 1 5.5V6h18v-.5A1.5 1.5 0 0 0 17.5 4h-15Z" /><path d="M1 7.5v7A1.5 1.5 0 0 0 2.5 16h15a1.5 1.5 0 0 0 1.5-1.5v-7H1ZM5 10.25a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h8.5a.75.75 0 0 0 0-1.5h-8.5Z" /></svg>
                        </div>
                        <div class="block w-full rounded-lg border-0 py-3 pl-10 pr-14 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 text-right font-bold text-xl"
                             :class="selectedItem.amount >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'"
                             x-text="formatCurrency(selectedItem.amount, false)">
                        </div>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none"><span class="text-sm font-medium text-slate-500 dark:text-slate-400">VNĐ</span></div>
                    </div>
                </div>

                <!-- Loại GD và Số phòng -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Loại giao dịch</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.5 3A2.5 2.5 0 0 0 3 5.5v2.879a.75.75 0 0 0 .22.53l6.101 6.1a.75.75 0 0 0 1.06 0l2.879-2.879a.75.75 0 0 0 0-1.06L7.16 5.22a.75.75 0 0 0-.53-.22H5.5ZM3.75 6a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd" /></svg></div>
                            <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm" x-text="selectedItem.transaction_type_display || 'N/A'"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Số phòng</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.01 3.51a.75.75 0 0 1 .497.462l1.668 5.003 5.004 1.668a.75.75 0 0 1 .018 1.41l-5.004 1.667-1.668 5.004a.75.75 0 0 1-1.41-.018l-1.667-5.004-5.004-1.668a.75.75 0 0 1-.018-1.41l5.004-1.667 1.667-5.003a.75.75 0 0 1 .913-.445ZM4.12 8.12a.75.75 0 0 1 .445.913l-.5 1.5.5 1.5a.75.75 0 0 1-.913.445l-1.5-.5-1.5.5a.75.75 0 0 1-.445-.913l.5-1.5-.5-1.5a.75.75 0 0 1 .913-.445l1.5.5 1.5-.5Z" clip-rule="evenodd" /></svg></div>
                            <div class="block w-full rounded-lg border-0 py-2.5 pl-10 bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm" x-text="selectedItem.room_number || 'N/A'"></div>
                        </div>
                    </div>
                </div>

                <!-- Thông tin giao dịch -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Thông tin giao dịch</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pt-2.5 pointer-events-none"><svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m2.695 14.763 1.262-3.155a.5.5 0 0 1 .47-.325H11.5a.5.5 0 0 1 0 1H4.928l-.34 1.156 4.704 1.679a.5.5 0 0 1 .326.47l-.34 3.154a.5.5 0 0 1-.94.066l-1.262-3.155A.5.5 0 0 1 2.695 14.763Z" /><path d="M13.5 3A2.5 2.5 0 0 0 11 5.5V11h4.5a2.5 2.5 0 0 0 2.5-2.5V5.5A2.5 2.5 0 0 0 15.5 3h-2Z" /></svg></div>
                        <div class="block w-full rounded-lg border-0 py-2.5 pl-10 min-h-[80px] bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white ring-1 ring-inset ring-slate-200 dark:ring-slate-700 sm:text-sm whitespace-pre-wrap break-words" x-text="selectedItem.transaction_info || 'Không có'"></div>
                    </div>
                </div>

            </div>

            <div class="p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <template x-if="canDelete && selectedItem.status === 'Chờ xử lý'">
                    <button type="button" @click="deleteItem(selectedItem.id, false)" class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span>Xóa</span>
                    </button>
                </template>
                
                <!-- THÊM: Nút Sửa -->
                <template x-if="hasEditPermission && selectedItem.status === 'Chờ xử lý'">
                    <button type="button" @click="openEditModal(selectedItem)" class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-yellow-600 rounded-xl hover:bg-yellow-700 active:bg-yellow-800 transition-colors shadow-lg shadow-yellow-500/20 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"></path></svg>
                        <span>Sửa</span>
                    </button>
                </template>

                <template x-if="userRole === 'admin' || userRole === 'boss'">
                    <button type="button" @click="deleteItem(selectedItem.id, true)" x-show="selectedItem.status && selectedItem.status.includes('Đã xoá')" class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-rose-600 rounded-xl hover:bg-rose-700 active:bg-rose-800 transition-colors shadow-lg shadow-rose-500/20 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span>Xóa Vĩnh Viễn</span>
                    </button>
                </template>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- ============ MODAL CHI TIẾT KẾT CA (MỚI) ======================= -->
    <!-- ================================================================== -->
    <div x-show="isShiftCloseDetailModalOpen" 
        @keydown.escape.window="closeShiftCloseDetailModal()" 
        class="modal fixed inset-0 z-[10002] flex items-center justify-center p-4" 
        x-cloak>
        <div x-show="isShiftCloseDetailModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>

        <div x-show="isShiftCloseDetailModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
            class="relative w-full max-w-4xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-h-[90vh] flex flex-col">
            
            <div id="shift-close-detail-content" class="flex flex-col bg-white dark:bg-slate-800 rounded-t-2xl overflow-y-auto">
            
                <div class="flex items-start justify-between p-5 border-b border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-4">
                        <div class="grid place-items-center w-12 h-12 rounded-xl bg-green-100 dark:bg-green-900/50">
                            <svg class="w-6 h-6 text-green-600 dark:text-green-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Chi tiết Kết ca</h2>
                            <div class="mt-1.5 text-sm text-slate-500 dark:text-slate-400 flex flex-wrap items-center gap-x-2">
                                <span class="font-semibold" x-text="shiftCloseDetails.log.closer_name || '...'"></span>
                                <span>&bull;</span>
                                <span x-text="shiftCloseDetails.log.branch_code || '...'"></span>
                                <span>&bull;</span>
                                <span x-text="formatDate(shiftCloseDetails.log.closed_datetime)"></span>
                            </div>
                        </div>
                    </div>
                    <button @click="closeShiftCloseDetailModal()" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="p-5 space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="p-4 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-200 dark:border-indigo-800">
                            <p class="text-sm font-medium text-indigo-600 dark:text-indigo-300">Doanh thu PMS</p>
                            <p class="mt-1 text-xl font-bold text-indigo-800 dark:text-indigo-200" x-text="formatCurrency(shiftCloseDetails.log.pms_revenue)"></p>
                        </div>
                        <div class="p-4 rounded-xl bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800">
                            <p class="text-sm font-medium text-blue-600 dark:text-blue-300">Doanh thu Online</p>
                            <p class="mt-1 text-xl font-bold text-blue-800 dark:text-blue-200" x-text="formatCurrency(shiftCloseDetails.log.closed_online_revenue)"></p>
                        </div>
                        <div class="p-4 rounded-xl bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800">
                            <p class="text-sm font-medium text-green-600 dark:text-green-300">Doanh thu Chi nhánh</p>
                            <p class="mt-1 text-xl font-bold text-green-800 dark:text-green-200" x-text="formatCurrency(shiftCloseDetails.log.closed_branch_revenue)"></p>
                        </div>
                        <div class="p-4 rounded-xl bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800">
                            <p class="text-sm font-medium text-amber-600 dark:text-amber-300">Tiền mặt</p>
                            <p class="mt-1 text-xl font-bold text-amber-800 dark:text-amber-200" x-text="formatCurrency(shiftCloseDetails.log.cash_revenue)"></p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-base font-semibold text-slate-800 dark:text-white mb-3">
                            Có <span x-text="shiftCloseDetails.transactions.length" class="font-bold text-blue-600 dark:text-blue-400"></span> giao dịch đã kết
                        </h3>
                        <div class="w-full bg-slate-50 dark:bg-slate-900/50 overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700">
                            <div>
                                <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400 border-collapse">
                                    <thead class="sticky top-0 z-10 text-xs text-slate-700 uppercase dark:text-slate-400 bg-slate-100 dark:bg-slate-800">
                                        <tr>
                                            <th scope="col" class="px-4 py-2.5">Mã GD</th>
                                            <th scope="col" class="px-4 py-2.5">Loại GD</th>
                                            <th scope="col" class="px-4 py-2.5">Phòng</th>
                                            <th scope="col" class="px-4 py-2.5">Thông tin</th>
                                            <th scope="col" class="px-4 py-2.5 text-right">Số tiền</th>
                                            <template x-if="userRole === 'admin' || userRole === 'boss'">
                                                <th scope="col" class="px-4 py-2.5 text-center"></th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                        <template x-if="shiftCloseDetails.loading">
                                            <tr><td colspan="5" class="text-center py-8 text-slate-500 dark:text-slate-400">Đang tải chi tiết...</td></tr>
                                        </template>
                                        <template x-if="!shiftCloseDetails.loading && shiftCloseDetails.transactions.length === 0">
                                            <tr><td colspan="5" class="text-center py-8 text-slate-500 dark:text-slate-400">Không có giao dịch nào trong lần kết ca này.</td></tr>
                                        </template>
                                        <template x-for="tx in shiftCloseDetails.transactions" :key="tx.id">
                                            <tr>
                                                <td class="px-4 py-2.5 font-mono text-xs" x-text="tx.transaction_code"></td>
                                                <td class="px-4 py-2.5" x-text="tx.transaction_type_display"></td>
                                                <td class="px-4 py-2.5" x-text="tx.room_number || '-'"></td>
                                                <td class="px-4 py-2.5 max-w-xs truncate" :title="tx.transaction_info" x-text="tx.transaction_info || '-'"></td>
                                                <td class="px-4 py-2.5 text-right font-semibold" 
                                                    :class="tx.amount >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'"
                                                    x-text="formatCurrency(tx.amount)">
                                                </td>
                                                <td x-show="userRole === 'admin' || userRole === 'boss'" class="px-4 py-2.5 text-center">
                                                    <button @click.stop="undoSingleTransactionFromLog(tx.id, shiftCloseDetails.log.id)" title="Hoàn tác giao dịch này" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.79 15.79a.75.75 0 01-1.06 0l-3.25-3.25a.75.75 0 010-1.06l3.25-3.25a.75.75 0 111.06 1.06L13.31 12l2.48 2.48a.75.75 0 010 1.06zM10 18a8 8 0 100-16 8 8 0 000 16z" clip-rule="evenodd" /></svg>
                                                    </button>
                                                    <button @click.stop="deleteSingleTransactionFromLog(tx.id, shiftCloseDetails.log.id)" title="Xóa vĩnh viễn giao dịch này" class="text-rose-500 hover:text-rose-700 dark:text-rose-400 dark:hover:text-rose-300 transition-colors">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.428a.75.75 0 00-.588.733v3.498a.75.75 0 00.588.733c.785.207 1.57.35 2.365.428v.443a2.75 2.75 0 002.75 2.75h2.5A2.75 2.75 0 0014 10.25v-.443c.795-.077 1.58-.22 2.365-.428a.75.75 0 00.588-.733V5.147a.75.75 0 00-.588-.733c-.785-.208-1.57-.351-2.365-.428v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.552 0 1 .448 1 1v1.25a.75.75 0 000 1.5V9c0 .552-.448 1-1 1s-1-.448-1-1V7.75a.75.75 0 000-1.5V5c0-.552.448-1 1-1z" clip-rule="evenodd" />
                                                        </svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <div class="p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col-reverse sm:flex-row sm:justify-end gap-3 rounded-b-2xl">
                <button type="button" @click="captureShiftCloseDetailModal()" :disabled="isCapturing"
                        class="w-full sm:w-auto px-5 py-2.5 text-sm font-semibold text-white bg-purple-600 rounded-xl hover:bg-purple-700 active:bg-purple-800 transition-colors shadow-lg shadow-purple-500/20
                            flex items-center justify-center gap-2"
                        :class="{ 'opacity-50 cursor-not-allowed': isCapturing }">
                    <svg x-show="isCapturing" class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <svg x-show="!isCapturing" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    <span x-text="isCapturing ? 'Đang chụp...' : 'Tải & Sao chép (.png)'"></span>
                </button>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}

<script>
    // SỬA: Tên hàm chính
    function shiftReport(initialDataSelector, totalRecords, currentPage, totalPages) {
        return {
            // Modal states
            isAddModalOpen: false,
            isDetailsModalOpen: false, 
            isEditModalOpen: false, 
            editItem: {}, 
            isBossAuthModalOpen: false, // THÊM: Modal xác thực mật khẩu boss
            isHandoverModalOpen: false, // <-- THÊM
            handoverTransactions: { // <-- THÊM
                loading: true,
                list: []
            },
            isCapturing: false, // <-- THÊM
            postAuthAction: null,
            // SỬA: State cho form xác thực
            bossAuth: {
                username: '',
                password: ''
            },
            postAuthAction: null, // THÊM: Hành động cần thực hiện sau khi xác thực

            isShiftCloseDetailModalOpen: false, // THÊM: Modal chi tiết kết ca

            branchChartInstance: null, // THÊM: State cho biểu đồ
            // THÊM: State cho modal chi tiết kết ca
            shiftCloseDetails: {
                loading: true,
                log: {},
                transactions: []
            },
            isShiftCloseModalOpen: false, // THÊM: Modal kết ca cho admin

            shiftHandoverCash: '', 
            pmsRevenue: '', // THÊM: Doanh thu PMS cho Lễ tân
            
            // THÊM: State cho modal kết ca của admin
            adminShiftClose: {
                branch: '',
                pmsRevenue: ''
            },

            // THÊM: State cho modal kết ca của Lễ tân
            letanShiftClose: {
                pmsRevenue: ''
            },
            isLetanShiftCloseModalOpen: false, 

            // THÊM: State cho các biểu đồ dashboard mới
            charts: {
                loading: true, // Trạng thái tải chung
                data: { 
                    by_branch: [], 
                    by_type: { closed_online: 0, pending_online: 0, closed_branch: 0, pending_branch: 0 },
                    total_pms_revenue: 0,
                    total_cash_revenue: 0,
                    recent_closes: []
                },
            }, // <--- SỬA: Đóng object 'charts' tại đây

            // Các getter để lấy giá trị doanh thu phù hợp với vai trò
            // (ĐÃ ĐƯỢC DI CHUYỂN RA NGOÀI CẤP ROOT)
            get onlineRevenueValue() {
                // 'this' ở đây là component Alpine, 'this.userRole' và 'this.charts' sẽ hoạt động
                if (this.userRole === 'letan') {
                    return this.charts.data.by_type.pending_online;
                }
                return this.charts.data.by_type.closed_online;
            },
            get branchRevenueValue() {
                if (this.userRole === 'letan') {
                    return this.charts.data.by_type.pending_branch;
                }
                return this.charts.data.by_type.closed_branch;
            },
            // THÊM: Getter để tính tổng doanh thu đang chờ xử lý
            get totalPendingRevenue() {
                const pendingOnline = this.charts.data.by_type.pending_online || 0;
                const pendingBranch = this.charts.data.by_type.pending_branch || 0;
                return pendingOnline + pendingBranch;
            },

            // Các getter tính toán tiền mặt
            get letanPmsRevenueValue() {
                const pmsRaw = this.letanShiftClose.pmsRevenue.replace(/[^0-9]/g, '');
                return parseFloat(pmsRaw) || 0;
            },
            get letanCounterCash() {
                const pms = this.letanPmsRevenueValue;
                const pendingOnline = this.charts.data.by_type.pending_online || 0;
                const pendingBranch = this.charts.data.by_type.pending_branch || 0;
                return pms - (pendingOnline + pendingBranch);
            },
            get letanTotalCounter() {
                return this.letanCounterCash + 1500000;
            },
            get selectableRecords() {
                return this.records.filter(r => r.status !== 'Đã kết ca');
            },
            // THÊM MỚI: Getter để kiểm tra logic cho checkbox "chọn tất cả"
            get allSelectableChecked() {
                const selectableCount = this.selectableRecords.length;
                // Chỉ 'checked' khi có mục để chọn VÀ số mục đã chọn bằng số mục có thể chọn
                return selectableCount > 0 && this.selectedIds.length === selectableCount;
            },
            get cashDifference() {
                const handover = parseFloat(this.getRawAmount('handover')) || 0;
                const actualCounterCash = handover - (this.onlineRevenueValue + this.branchRevenueValue);
                return actualCounterCash - this.totalCounter;
            },
            
            // Data states
            selectedItem: {},
            selectedIds: [],
            lastCheckedId: null,
            totalPages: totalPages,

            formattedAmount: '', // THÊM: State cho input tiền
            addTransactionType: '', // THÊM: State cho loại giao dịch khi thêm mới
            userRole: '{{ user.role }}',
            recorderSuggestions: [],
            // XOÁ: reporterSuggestions, disposerSuggestions
            
            user: JSON.parse('{{ user | tojson | safe }}'),
            canDelete: ['letan', 'quanly', 'admin', 'boss'].includes('{{ user.role }}'),
            displayBranch: '',
            hasEditPermission: ['letan', 'quanly', 'admin', 'boss'].includes('{{ user.role }}'),
            
            records: [],
            totalRecords: 0,
            
            datePickerInstance: null, // THÊM: State để lưu instance flatpickr
            // XOÁ: State dashboard
            
            // Các biến được truyền vào
            initialDataSelector: initialDataSelector,
            initialTotalRecords: totalRecords,
            currentPage: currentPage,
            // SỬA: localStorage key
            recordsPerPage: parseInt(localStorage.getItem('shiftReportPerPage')) || 9,
            
            loading: false,
            // THÊM: State cho sắp xếp
            currentSortBy: 'created_datetime',
            currentSortOrder: 'desc',

            errorEl: null,
            recordCountEl: null,

            // SỬA: Helper: Lấy thông tin trạng thái
            getStatusInfo(status) {
                if (!status) {
                    return { badge: '', iconBg: '', iconColor: '', iconPath: '' };
                }
                 const statusMap = {
                    'Chờ xử lý': { badge: 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300', iconBg: 'bg-amber-100 dark:bg-amber-900/50', iconColor: 'text-amber-600 dark:text-amber-300', iconPath: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />' },
                    'Đã kết ca': { badge: 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/50 dark:text-emerald-300', iconBg: 'bg-emerald-100 dark:bg-emerald-900/50', iconColor: 'text-emerald-600 dark:text-emerald-300', iconPath: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />' },
                    'Đã xoá': { badge: 'bg-rose-100 text-rose-800 dark:bg-rose-900/50 dark:text-rose-300', iconBg: 'bg-rose-100 dark:bg-rose-900/50', iconColor: 'text-rose-600 dark:text-rose-300', iconPath: '<path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />' },
                };
                const effectiveStatus = status.includes('Đã xoá') ? 'Đã xoá' : status;
                return statusMap[effectiveStatus] || statusMap['Chờ xử lý'];
            },
 
            // SỬA: Helper: Quyền chỉnh sửa
            get canEdit() {
                if (!this.selectedItem || !this.selectedItem.status) return false;
                // Chỉ có thể sửa khi đang "Chờ xử lý"
                return ['Chờ xử lý'].includes(this.selectedItem.status);
            },
            
            // SỬA: Các hàm search
            async searchRecorders(query, context = 'add') {
                if (query.trim().length < 2) {
                    this.recorderSuggestions = [];
                    return;
                }
                try {
                    // SỬA: API endpoint (giả định)
                    const response = await fetch(`/api/users/search-login-users?q=${encodeURIComponent(query)}&context=${context}`);
                    if (!response.ok) throw new Error('Lỗi khi tìm kiếm');
                    this.recorderSuggestions = await response.json();
                } catch (error) {
                    console.error('Lỗi tìm người tạo:', error);
                }
            },
            selectRecorder(recorder, context = 'add') {
                const searchInput = document.getElementById(`${context}_recorded_by_search`);
                const hiddenInput = document.getElementById(`${context}_recorded_by`);
                const valueToSet = `${recorder.name} (${recorder.code})`;
                if (searchInput) searchInput.value = valueToSet;
                if (hiddenInput) hiddenInput.value = valueToSet;
                if (context === 'edit') this.editItem.recorded_by = valueToSet;
                this.recorderSuggestions = [];
            },
            // XOÁ: searchReporters, searchDisposers, searchFilterReporters

            // ==========================================================
            // ============ LOGIC LÕI (SỬA) =========================
            // ==========================================================
            
            init() {
                // SỬA: Khởi tạo flatpickr ngay trong init và lưu instance
                this.datePickerInstance = flatpickr("#created_date", {
                    dateFormat: "Y-m-d",
                    altInput: true,
                    altFormat: "d/m/Y",
                    locale: "vn",
                });

                this.errorEl = document.getElementById('error');
                this.recordCountEl = document.getElementById('record-count');

                const initialDataElement = document.querySelector(this.initialDataSelector);
                if (initialDataElement) {
                    this.records = JSON.parse(initialDataElement.textContent);
                }
                this.totalRecords = this.initialTotalRecords;

                // SỬA: Thêm "fetchDashboardSummary()"
                document.querySelector('#apply-filters').addEventListener('click', () => { 
                    this.currentPage = 1; 
                    this.fetchData(); 
                    this.fetchDashboardSummary(); // <-- THÊM DÒNG NÀY
                });
                
                // SỬA: Thêm "fetchDashboardSummary()"
                document.querySelector('#clear-filters').addEventListener('click', (e) => {
                    e.preventDefault(); // Ngăn form submit
                    document.getElementById('search').value = '';
                    const statusEl = document.getElementById('status');
                    if (statusEl) statusEl.value = '';
                    // SỬA: Gọi instance đã lưu trong state của Alpine
                    if (this.datePickerInstance) this.datePickerInstance.clear();

                    document.getElementById('transaction_type').value = ''; // THÊM
                    const chiNhanhEl = document.getElementById('chi_nhanh');
                    if (chiNhanhEl && this.userRole !== 'letan') chiNhanhEl.value = '';
                    
                    this.currentPage = 1;
                    this.fetchData();
                    this.fetchDashboardSummary(); // <-- THÊM DÒNG NÀY
                });

                const chiNhanhSelect = document.getElementById('chi_nhanh');
                if (chiNhanhSelect) {
                    this.displayBranch = chiNhanhSelect.value;
                } else {
                    this.displayBranch = '{{ initial_branch_filter }}';
                }

                const perPageSelect = document.getElementById('per-page-select');
                perPageSelect.value = this.recordsPerPage;

                // SỬA LỖI: Khi khởi tạo, sử dụng `totalPages` được truyền từ server.
                // Không tính toán lại ở client để tránh sai lệch.
                // `this.totalPages` đã được gán giá trị đúng từ `x-data`.
                this.renderPagination(this.currentPage, this.totalPages, this.totalRecords, this.records.length);


                // Tải dữ liệu cho dashboard (cho mọi vai trò)
                // Hàm này giờ đã được cập nhật, nó sẽ tự động lấy filter mặc định khi tải trang
                this.fetchDashboardSummary(); 
                this.updateSortIndicators(); // THÊM: Cập nhật chỉ báo sắp xếp khi tải trang

                window.addEventListener('themeChanged', () => {
                    this.updateChartTheme();
                    // Có thể thêm logic vẽ lại biểu đồ ở đây nếu cần
                });
            },

            // ==========================================================
            // ============ LOGIC DASHBOARD (MỚI) =======================
            // ==========================================================
            async fetchDashboardSummary() {
                this.charts.loading = true;

                // Lấy chuỗi query đầy đủ từ bộ lọc (bao gồm cả phân trang)
                const fullQuery = this.buildQueryString();
                
                // Phân tích chuỗi query và xoá các tham số phân trang
                const params = new URLSearchParams(fullQuery);
                params.delete('page');
                params.delete('per_page');
                
                // Đây là chuỗi query cuối cùng chỉ chứa các bộ lọc
                const filterQuery = params.toString(); 

                try {
                    // Thêm '?' vào trước chuỗi query nếu nó không rỗng
                    const query = filterQuery ? `?${filterQuery}` : '';
                    
                    // Gửi request đến API dashboard với các tham số lọc
                    const response = await fetch(`/shift-report/api/dashboard-summary${query}`);
                    
                    if (!response.ok) throw new Error('Lỗi tải dữ liệu dashboard');
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        this.charts.data = result.data; // Gán dữ liệu
                        this.renderBranchChart(); // Vẽ lại biểu đồ
                    }
                } catch (error) {
                    console.error("Lỗi fetch dashboard summary:", error);
                } finally {
                    this.charts.loading = false;
                }
            },   

            renderBranchChart() {
                this.$nextTick(() => {
                    const ctx = document.getElementById('branchRevenueChart');
                    if (!ctx) return;

                    if (this.branchChartInstance) {
                        this.branchChartInstance.destroy();
                    }

                    const chartData = this.charts.data.by_branch;
                    const labels = chartData.map(b => b.branch);
                    const pmsData = chartData.map(b => b.pms_revenue);

                    const textColor = document.documentElement.classList.contains('dark') ? 'rgba(226, 232, 240, 0.8)' : 'rgba(71, 85, 105, 1)';
                    const gridColor = document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

                    this.branchChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Doanh thu PMS',
                                data: pmsData,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${this.formatCurrency(context.raw)}`
                                    }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: textColor, callback: (value) => this.formatCurrency(value, false) }, grid: { color: gridColor } },
                                x: { ticks: { color: textColor }, grid: { display: false } }
                            }
                        }
                    });
                });
            },

            updateChartTheme() {
                if (!this.branchChartInstance) return;
                const textColor = document.documentElement.classList.contains('dark') ? 'rgba(226, 232, 240, 0.8)' : 'rgba(71, 85, 105, 1)';
                const gridColor = document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                this.branchChartInstance.options.scales.y.ticks.color = textColor;
                this.branchChartInstance.options.scales.x.ticks.color = textColor;
                this.branchChartInstance.options.scales.y.grid.color = gridColor;
                this.branchChartInstance.update();
            },

            changePerPage(value) {
                this.recordsPerPage = parseInt(value, 10);
                // 1. Lưu vào localStorage để AlpineJS đọc lại ngay lập tức
                localStorage.setItem('shiftReportPerPage', this.recordsPerPage);
                // 2. Lưu vào cookie để server đọc được khi tải lại trang
                document.cookie = `shiftReportPerPage=${this.recordsPerPage};path=/;max-age=31536000;samesite=Lax`; // Lưu trong 1 năm
                this.currentPage = 1;
                this.fetchData();
            },

            // THÊM: Hàm xử lý sắp xếp
            sortBy(column) {
                if (this.currentSortBy === column) {
                    this.currentSortOrder = this.currentSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.currentSortBy = column;
                    this.currentSortOrder = 'desc';
                }
                this.currentPage = 1;
                this.fetchData();
            },

            // THÊM: Hàm cập nhật giao diện cho chỉ báo sắp xếp
            updateSortIndicators() {
                document.querySelectorAll('.sortable').forEach(th => {
                    th.classList.remove('asc', 'desc');
                    const indicator = th.querySelector('.sort-indicator');
                    if (th.dataset.sort === this.currentSortBy) {
                        th.classList.add(this.currentSortOrder);
                        indicator.innerHTML = this.currentSortOrder === 'asc' ? '&#9650;' : '&#9660;';
                    } else { indicator.innerHTML = '&#8693;'; }
                });
            },

            // SỬA: buildQueryString
            buildQueryString() {
                const params = new URLSearchParams();
                params.append('page', this.currentPage);
                params.append('per_page', this.recordsPerPage);

                const search = document.getElementById('search').value;
                const statusEl = document.getElementById('status');
                const status = statusEl ? statusEl.value : '';
                const chiNhanhEl = document.getElementById('chi_nhanh');
                const chi_nhanh = chiNhanhEl ? chiNhanhEl.value : '{{ initial_branch_filter }}';
                const created_date = document.getElementById('created_date').value; // SỬA
                const transaction_type = document.getElementById('transaction_type').value; // THÊM

                this.displayBranch = chi_nhanh;
                
                if (search) params.append('search', search.trim());
                if (status) params.append('status', status);
                if (chi_nhanh) params.append('chi_nhanh', chi_nhanh);
                if (created_date) params.append('created_date', created_date); // SỬA
                if (transaction_type) params.append('transaction_type', transaction_type); // THÊM

                // THÊM: Tham số sắp xếp
                params.append('sort_by', this.currentSortBy);
                params.append('sort_order', this.currentSortOrder);

                return params.toString();
            },

            // SỬA: fetchData
            fetchData: async function() {
                this.loading = true;
                this.errorEl.classList.add('hidden');
                this.records = [];
                this.selectedIds = [];

                try {
                    // SỬA: API endpoint
                    const response = await fetch(`/shift-report/api?${this.buildQueryString()}`);
                    if (!response.ok) {
                        let errorDetail = 'Network response was not ok';
                        try {
                            const errorData = await response.json();
                            errorDetail = errorData.detail || errorData.message || JSON.stringify(errorData);
                        } catch (e) { /* Bỏ qua */ }
                        throw new Error(errorDetail);
                    }
                    const data = await response.json();

                    this.records = data.records;
                    this.totalRecords = data.totalRecords;
                    this.totalPages = data.totalPages;
                    
                    this.renderPagination(data.currentPage, data.totalPages, data.totalRecords, data.records.length);
                    this.updateSortIndicators(); // THÊM: Cập nhật chỉ báo sau mỗi lần fetch
                } catch (err) {
                    console.error('Fetch error:', err);
                    this.errorEl.classList.remove('hidden');
                    this.errorEl.querySelector('p').textContent = `Có lỗi xảy ra: ${err.message}`;
                } finally {
                    this.loading = false;
                }
            },

            // XOÁ: Các hàm Dashboard

            // SỬA: renderPagination
            renderPagination: function(currentPageNum, totalPages, totalRecords, recordsOnPage) {
                const paginationEl = document.getElementById('pagination-controls');
                paginationEl.innerHTML = '';

                if (totalRecords === 0) {
                    this.recordCountEl.textContent = 'Không có giao dịch nào.'; // SỬA
                    return;
                }
                // SỬA: Cập nhật text
                this.recordCountEl.textContent = `Hiển thị ${recordsOnPage} / ${totalRecords} giao dịch.`;

                if (totalPages <= 1) return;

                const createButton = (text, page, isDisabled = false, isCurrent = false) => {
                    const button = document.createElement('button');
                    button.innerHTML = text;
                    button.dataset.page = page;
                    let baseClasses = 'px-3 py-1 rounded-lg border text-sm font-semibold transition-colors';
                    if (isCurrent) button.className = `${baseClasses} bg-blue-600 text-white border-blue-600 cursor-default shadow-sm`;
                    else if (isDisabled) button.className = `${baseClasses} bg-slate-100 dark:bg-slate-800 text-slate-400 border-slate-200 dark:border-slate-700 cursor-not-allowed`;
                    else button.className = `${baseClasses} bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700`;
                    if (!isDisabled && !isCurrent) button.addEventListener('click', () => { this.currentPage = page; this.fetchData(); });
                    return button;
                };
                
                paginationEl.appendChild(createButton('&laquo;', 1, currentPageNum === 1));
                paginationEl.appendChild(createButton('&lsaquo;', currentPageNum - 1, currentPageNum === 1));
                let startPage = Math.max(1, currentPageNum - 2);
                let endPage = Math.min(totalPages, currentPageNum + 2);
                if (currentPageNum <= 3) endPage = Math.min(5, totalPages);
                if (currentPageNum > totalPages - 3) startPage = Math.max(1, totalPages - 4);
                if (startPage > 1) {
                    paginationEl.appendChild(createButton('1', 1));
                    if (startPage > 2) paginationEl.insertAdjacentHTML('beforeend', `<span class="px-2 text-slate-400">...</span>`);
                }
                for (let i = startPage; i <= endPage; i++) {
                    paginationEl.appendChild(createButton(i, i, false, i === currentPageNum));
                }
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) paginationEl.insertAdjacentHTML('beforeend', `<span class="px-2 text-slate-400">...</span>`);
                    paginationEl.appendChild(createButton(totalPages, totalPages));
                }
                paginationEl.appendChild(createButton('&rsaquo;', currentPageNum + 1, currentPageNum === totalPages));
                paginationEl.appendChild(createButton('&raquo;', totalPages, currentPageNum === totalPages));
            },

            // SỬA: Các hàm Modal
            openAddModal: function() {
                this.isAddModalOpen = true;
                this.$nextTick(() => {
                    const form = document.getElementById('add-item-form');
                    if (form) form.reset();
                    this.formattedAmount = ''; // Reset tiền
                    this.addTransactionType = ''; // Reset loại giao dịch
                    const searchInputRec = document.getElementById('add_recorded_by_search');
                    if (searchInputRec) searchInputRec.value = '';
                });
                this.recorderSuggestions = [];
            },
            closeAddModal: function() { this.isAddModalOpen = false; },

            openEditModal: function(item) {
                this.editItem = JSON.parse(JSON.stringify(item));
                // SỬA: Hiển thị số tiền đã format
                this.formattedAmount = this.formatCurrency(this.editItem.amount, false); // false = không có ' VNĐ'
                // THÊM: Đóng modal chi tiết trước khi mở modal sửa
                this.closeDetailsModal();
                setTimeout(() => {
                    this.isEditModalOpen = true;
                    this.$nextTick(() => {
                        const editRecordedBySearch = document.getElementById('edit_recorded_by_search');
                        if (editRecordedBySearch && this.editItem.recorded_by) {
                            editRecordedBySearch.value = this.editItem.recorded_by; 
                        }
                        this.recorderSuggestions = [];
                    });
                }, 250); // Tăng thời gian chờ để khớp với transition:leave duration (200ms)
            },
            closeEditModal: function() { this.isEditModalOpen = false; },

            openDetailsModal: function(item) {
                this.selectedItem = item;
                this.isDetailsModalOpen = true;
            },
            closeDetailsModal: function() { this.isDetailsModalOpen = false; },
            
            // THÊM: Các hàm cho modal chi tiết kết ca
            async openShiftCloseDetailModal(logId) {
                this.isShiftCloseDetailModalOpen = true;
                this.shiftCloseDetails.loading = true;
                this.shiftCloseDetails.log = {};
                this.shiftCloseDetails.transactions = [];

                try {
                    const response = await fetch(`/shift-report/api/shift-close-details/${logId}`);
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.detail || 'Lỗi tải dữ liệu');
                    }
                    const result = await response.json();
                    if (result.status === 'success') {
                        this.shiftCloseDetails.log = result.log_details;
                        this.shiftCloseDetails.transactions = result.transactions;
                    }
                } catch (error) {
                    alert('Lỗi: ' + error.message);
                } finally {
                    this.shiftCloseDetails.loading = false;
                }
            },
            closeShiftCloseDetailModal() { this.isShiftCloseDetailModalOpen = false; },

            // THÊM: Hàm hoàn tác một giao dịch từ log
            async undoSingleTransactionFromLog(transactionId, logId) {
                if (!confirm('Bạn có chắc chắn muốn hoàn tác giao dịch này không? Nó sẽ được chuyển về trạng thái "Chờ xử lý".')) {
                    return;
                }
                try {
                    const response = await fetch('/shift-report/api/undo-transaction-from-log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ log_id: logId, transaction_id: transactionId })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || 'Lỗi server');

                    showToast('update', result.message);
                    // Tải lại dữ liệu cho modal chi tiết kết ca và bảng chính
                    await this.openShiftCloseDetailModal(logId);
                    await this.fetchData();
                    await this.fetchDashboardSummary();
                } catch (error) {
                    alert('Lỗi khi hoàn tác: ' + error.message);
                }
            },

            // THÊM: Hàm xóa vĩnh viễn một giao dịch từ log
            async deleteSingleTransactionFromLog(transactionId, logId) {
                if (!confirm('CẢNH BÁO: Bạn có chắc chắn muốn XÓA VĨNH VIỄN giao dịch này không? Hành động này không thể hoàn tác và sẽ tính toán lại báo cáo kết ca.')) {
                    return;
                }
                try {
                    const response = await fetch(`/shift-report/api/delete-transaction-from-log/${transactionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ log_id: logId })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || 'Lỗi server');

                    showToast('delete', 'Đã xóa vĩnh viễn giao dịch.');
                    
                    // Cập nhật UI của modal chi tiết
                    this.shiftCloseDetails.transactions = this.shiftCloseDetails.transactions.filter(tx => tx.id !== transactionId);
                    this.shiftCloseDetails.log = result.updated_log; // Cập nhật lại summary của log

                    // Tải lại dữ liệu cho bảng chính và dashboard
                    await this.fetchData();
                    await this.fetchDashboardSummary();
                } catch (error) {
                    alert('Lỗi khi xóa giao dịch: ' + error.message);
                }
            },

            // THÊM: Modal kết ca cho admin
            openShiftCloseModal() { this.isShiftCloseModalOpen = true; },
            closeShiftCloseModal() { this.isShiftCloseModalOpen = false; },
            
            openLetanShiftCloseModal() { this.isLetanShiftCloseModalOpen = true; },
            closeLetanShiftCloseModal() { this.isLetanShiftCloseModalOpen = false; },

            // XOÁ: openDisposeModal, closeDisposeModal
            // THÊM: Modal xác thực mật khẩu boss
            openBossAuthModal() { this.isBossAuthModalOpen = true; },
            closeBossAuthModal() { 
                this.isBossAuthModalOpen = false; 
                this.bossPassword = ''; // Xóa mật khẩu khi đóng modal
            },

            // ==========================================================
            // ============ LOGIC MODAL GIAO CA (MỚI) ===================
            // ==========================================================
            async openHandoverModal() {
                // 1. Kiểm tra xem đã nhập PMS chưa (giữ nguyên)
                const pmsRevenueRaw = this.letanShiftClose.pmsRevenue.replace(/[^0-9]/g, '');
                if (!pmsRevenueRaw || parseInt(pmsRevenueRaw, 10) === 0) {
                    alert('Vui lòng nhập doanh thu PMS trước khi xem biên bản giao ca.');
                    return; 
                }

                // 2. Mở modal và đặt trạng thái loading (giữ nguyên)
                this.isHandoverModalOpen = true;
                this.handoverTransactions.loading = true;
                this.handoverTransactions.list = [];

                // 3. SỬA: Gọi API /api/all-pending với các bộ lọc
                try {
                    // 3a. Xây dựng query string với các bộ lọc
                    const params = new URLSearchParams();
                    // Lễ tân chỉ query chi nhánh của mình
                    params.append('branch', this.displayBranch);

                    // 3b. Lấy giá trị từ các bộ lọc trên màn hình chính
                    const search = document.getElementById('search').value;
                    // Lấy giá trị raw từ flatpickr instance
                    const created_date_val = this.datePickerInstance.selectedDates[0] ? 
                                             this.datePickerInstance.formatDate(this.datePickerInstance.selectedDates[0], "Y-m-d") : 
                                             '';
                    const transaction_type = document.getElementById('transaction_type').value;

                    // 3c. Thêm vào params nếu chúng tồn tại
                    if (search && search.trim() !== '') params.append('search', search.trim());
                    if (created_date_val) params.append('created_date', created_date_val);
                    if (transaction_type) params.append('transaction_type', transaction_type);

                    const filterQuery = params.toString();
                    
                    // 3d. Gọi API (vẫn là /api/all-pending)
                    const response = await fetch(`/shift-report/api/all-pending?${filterQuery}`);

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.detail || 'Lỗi tải dữ liệu');
                    }
                    const result = await response.json();
                    
                    // 3e. Xử lý kết quả (giữ nguyên key 'transactions')
                    if (result.status === 'success') {
                        this.handoverTransactions.list = result.transactions;
                    }
                } catch (error) {
                    alert('Lỗi: ' + error.message);
                } finally {
                    this.handoverTransactions.loading = false;
                }
            },
            
            closeHandoverModal() {
                this.isHandoverModalOpen = false;
            },

            async captureHandoverModal() {
                if (this.isCapturing) return;
                this.isCapturing = true;

                const elementToCapture = document.getElementById('handover-modal-content');
                if (!elementToCapture) {
                    alert('Lỗi: Không tìm thấy nội dung modal.');
                    this.isCapturing = false;
                    return;
                }

                try {
                    // (Phần onclone... giữ nguyên)
                    const canvas = await html2canvas(elementToCapture, {
                        scale: 2, 
                        useCORS: true,
                        logging: false,
                        onclone: (clonedDocument) => {
                            const clonedElement = clonedDocument.getElementById('handover-modal-content');
                            if (!clonedElement) return;
                            clonedElement.style.overflowY = 'visible';
                            clonedElement.style.height = 'auto';
                            clonedElement.style.maxHeight = 'none';
                            if (clonedElement.parentElement) {
                                clonedElement.parentElement.style.maxHeight = 'none';
                                clonedElement.parentElement.style.height = 'auto';
                                clonedElement.parentElement.style.overflow = 'visible';
                            }
                            const innerScrollingDivs = clonedElement.querySelectorAll(
                                '[class*="overflow-auto"], [class*="overflow-y-auto"]'
                            );
                            innerScrollingDivs.forEach(div => {
                                div.style.overflow = 'visible';
                                div.style.overflowY = 'visible';
                                div.style.height = 'auto';
                                div.style.maxHeight = 'none';
                            });
                        }
                    });
                    
                    // Chuyển Canvas thành Blob
                    canvas.toBlob(async (blob) => {
                        let copied = false;

                        // SỬA: Kiểm tra xem API Clipboard có tồn tại không
                        if (navigator.clipboard && navigator.clipboard.write) {
                            try {
                                await navigator.clipboard.write([
                                    new ClipboardItem({ 'image/png': blob })
                                ]);
                                copied = true; // Đánh dấu đã sao chép thành công
                            } catch (err) {
                                console.error('Lỗi khi sao chép (bị từ chối hoặc lỗi):', err);
                            }
                        }

                        // Thông báo dựa trên kết quả
                        if (copied) {
                            alert('Ảnh đã được sao chép vào clipboard và sẽ tải xuống!');
                        } else {
                            // Thông báo nếu không thể sao chép
                            alert('Không thể tự động sao chép (do kết nối không an toàn). Ảnh sẽ được tải xuống.');
                        }

                        // 2. Vẫn tải ảnh xuống như bình thường
                        const link = document.createElement('a');
                        link.download = `GiaoCa_${this.user.branch}_${new Date().toISOString().split('T')[0]}.png`;
                        link.href = URL.createObjectURL(blob);
                        link.click();
                        URL.revokeObjectURL(link.href);
                    }, 'image/png');
                    
                } catch (error) {
                    alert('Lỗi khi chụp ảnh: ' + error.message);
                } finally {
                    this.isCapturing = false;
                }
            },

            async captureShiftCloseDetailModal() {
                if (this.isCapturing) return;
                this.isCapturing = true;

                // SỬA: Target ID mới
                const elementToCapture = document.getElementById('shift-close-detail-content');
                if (!elementToCapture) {
                    alert('Lỗi: Không tìm thấy nội dung modal chi tiết.');
                    this.isCapturing = false;
                    return;
                }

                try {
                    // Logic onclone giữ nguyên, nó sẽ tự động tìm các class overflow
                    const canvas = await html2canvas(elementToCapture, {
                        scale: 2, 
                        useCORS: true,
                        logging: false,
                        onclone: (clonedDocument) => {
                            const clonedElement = clonedDocument.getElementById('shift-close-detail-content');
                            if (!clonedElement) return;
                            // Đảm bảo nội dung được hiển thị đầy đủ, không bị cuộn
                            clonedElement.style.overflowY = 'visible';
                            clonedElement.style.height = 'auto';
                            clonedElement.style.maxHeight = 'none';
                            if (clonedElement.parentElement) {
                                clonedElement.parentElement.style.maxHeight = 'none';
                                clonedElement.parentElement.style.height = 'auto';
                                clonedElement.parentElement.style.overflow = 'visible';
                            }
                            // Tìm các bảng bên trong và làm cho chúng không cuộn
                            const innerScrollingDivs = clonedElement.querySelectorAll(
                                '[class*="overflow-auto"], [class*="overflow-y-auto"]'
                            );
                            innerScrollingDivs.forEach(div => {
                                div.style.overflow = 'visible';
                                div.style.overflowY = 'visible';
                                div.style.height = 'auto';
                                div.style.maxHeight = 'none';
                            });
                        }
                    });
                    
                    // Logic toBlob (sao chép và tải xuống) giữ nguyên
                    canvas.toBlob(async (blob) => {
                        let copied = false;
                        if (navigator.clipboard && navigator.clipboard.write) {
                            try {
                                await navigator.clipboard.write([
                                    new ClipboardItem({ 'image/png': blob })
                                ]);
                                copied = true;
                            } catch (err) {
                                console.error('Lỗi khi sao chép (bị từ chối hoặc lỗi):', err);
                            }
                        }

                        if (copied) {
                            alert('Ảnh đã được sao chép vào clipboard và sẽ tải xuống!');
                        } else {
                            alert('Không thể tự động sao chép (do kết nối không an toàn). Ảnh sẽ được tải xuống.');
                        }

                        // SỬA: Tên file download cho phù hợp
                        const branch = this.shiftCloseDetails.log.branch_code || 'ChiTiet';
                        const date = new Date(this.shiftCloseDetails.log.closed_datetime).toISOString().split('T')[0];
                        const link = document.createElement('a');
                        link.download = `KetCa_${branch}_${date}.png`;
                        link.href = URL.createObjectURL(blob);
                        link.click();
                        URL.revokeObjectURL(link.href);
                    }, 'image/png');
                    
                } catch (error) {
                    alert('Lỗi khi chụp ảnh: ' + error.message);
                } finally {
                    this.isCapturing = false;
                }
            },

            // THÊM: Hàm xác thực mật khẩu boss
            async verifyBossPasswordAndProceed() {
                try {
                    const response = await fetch('/api/users/verify-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: this.bossAuth.username, 
                            password: this.bossAuth.password 
                        })
                    });
                    const result = await response.json();

                    // SỬA: Logic sau khi xác thực thành công
                    if (response.ok && result.success) {
                        this.closeBossAuthModal();
                        
                        // Thực thi hành động đã được lưu (nếu có)
                        if (this.postAuthAction) {
                            this.postAuthAction();      // Chạy hành động (vd: openLetanShiftCloseModal)
                            this.postAuthAction = null; // Xóa hành động sau khi chạy
                        } else {
                            // Giữ lại hành động mặc định cho các luồng cũ (nếu có)
                            this.openShiftCloseModal(); 
                        }
                    } else {
                        throw new Error(result.detail || 'Mật khẩu không chính xác.');
                    }
                } catch (error) {
                    alert('Lỗi xác thực: ' + error.message);
                }
            },

            // THÊM: Hàm khởi tạo quá trình kết ca của Lễ tân
            initiateLetanCloseShift() {
                // 1. LẤY VÀ XÁC THỰC DOANH THU PMS TỪ MÀN HÌNH CHÍNH
                const pmsRevenueRaw = this.letanShiftClose.pmsRevenue.replace(/[^0-9]/g, '');
                if (!pmsRevenueRaw || parseInt(pmsRevenueRaw, 10) === 0) {
                    alert('Vui lòng nhập doanh thu PMS trước khi kết ca.');
                    return; 
                }
                
                // 2. GÁN HÀNH ĐỘNG LÀ SUBMIT (Không phải mở modal)
                this.postAuthAction = () => this.submitLetanCloseShift(); 
                
                // 3. MỞ MODAL XÁC THỰC
                this.openBossAuthModal();
            },

            async closeAllPending() {
                // SỬA: Gộp admin, boss, và quanly vào một luồng (không xác thực)
                if (this.userRole === 'boss' || this.userRole === 'admin' || this.userRole === 'quanly') {
                    this.openShiftCloseModal(); // Mở thẳng modal kết ca, không cần xác thực
                    return;
                }

                // SỬA: Lễ tân phải qua BƯỚC XÁC THỰC
                if (this.userRole === 'letan') {
                    this.initiateLetanCloseShift(); // Bắt đầu luồng xác thực (sẽ gọi Bước 1 & 2)
                    return;
                }
            },

            // THÊM: Các hàm helper tiền tệ
            handleAmountInput: function(event, context) {
                let rawValue = event.target.value.replace(/[^0-9]/g, '');
                if (rawValue) {
                    this.formattedAmount = new Intl.NumberFormat('vi-VN').format(parseInt(rawValue, 10));
                    if (context === 'admin_pms') this.adminShiftClose.pmsRevenue = this.formattedAmount;
                    if (context === 'letan_pms') this.letanShiftClose.pmsRevenue = this.formattedAmount; // <-- THÊM DÒNG NÀY
                } else {
                    this.formattedAmount = '';
                    if (context === 'admin_pms') this.adminShiftClose.pmsRevenue = '';
                    if (context === 'letan_pms') this.letanShiftClose.pmsRevenue = ''; // <-- THÊM DÒNG NÀY
                }

                // Cập nhật cho tiền giao ca
                if (context === 'handover') {
                    this.shiftHandoverCash = this.formattedAmount;
                }
                if (context === 'pms') {
                    this.pmsRevenue = this.formattedAmount;
                }
            },
            getRawAmount: function(context) {
                const amountStr = (context === 'handover') ? this.shiftHandoverCash : (context === 'pms' ? this.pmsRevenue : this.formattedAmount);
                if (!amountStr) {
                    return '0';
                }
                return amountStr.replace(/[^0-9]/g, '');
            },
            formatCurrency: function(value, useSymbol = true) {
                if (value === null || value === undefined) return 'N/A';
                try {
                    const options = { 
                        style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 0 
                    };
                    return new Intl.NumberFormat('vi-VN', options).format(value);
                } catch (e) {
                    return value;
                }
            },
            // Giữ nguyên: formatDate
            formatDate: function(dateString) {
                if (!dateString) return 'N/A';
                const options = { 
                    day: '2-digit', month: '2-digit', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit',
                    timeZone: 'Asia/Ho_Chi_Minh' 
                };
                return new Date(dateString).toLocaleString('vi-VN', options);
            },
            
            // Giữ nguyên: toggleSelection, toggleSelectAll, handleCheckboxClick
            toggleSelection(id) {
                const index = this.selectedIds.indexOf(id);
                if (index > -1) {
                    this.selectedIds.splice(index, 1);
                } else {
                    this.selectedIds.push(id);
                }
            },
            toggleSelectAll(event) {
                const isChecked = event.target.checked;
                if (isChecked) {
                    // SỬA: Dùng getter đã tạo, hiệu quả hơn
                    this.selectedIds = this.selectableRecords.map(r => r.id);
                } else {
                    this.selectedIds = [];
                }
            },
            handleCheckboxClick(event, id) {
                const isChecked = !this.selectedIds.includes(id); 
                if (event.shiftKey && this.lastCheckedId !== null && this.lastCheckedId !== id) {
                    const allRecordIds = this.records.map(r => r.id);
                    const start = allRecordIds.indexOf(this.lastCheckedId);
                    const end = allRecordIds.indexOf(id);
                    if (start !== -1 && end !== -1) {
                        const rangeStart = Math.min(start, end);
                        const rangeEnd = Math.max(start, end);
                        const idsToToggle = allRecordIds.slice(rangeStart, rangeEnd + 1);
                        if (isChecked) {
                            const idsToAdd = idsToToggle.filter(i => !this.selectedIds.includes(i));
                            this.selectedIds.push(...idsToAdd);
                        } else {
                            this.selectedIds = this.selectedIds.filter(selectedId => !idsToToggle.includes(selectedId));
                        }
                    }
                } else {
                    this.toggleSelection(id);
                    this.lastCheckedId = id;
                }
                event.target.checked = this.selectedIds.includes(id);
            },

            // ==========================================================
            // ============ CÁC HÀM SUBMIT (ĐÃ SỬA) =====================
            // ==========================================================

            submitAddItemForm: async function(event) {
                const submitBtn = event.target.closest('.modal').querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Đang lưu...';

                const formData = new FormData(event.target);
                
                // Ghi đè 'amount' bằng giá trị số
                formData.set('amount', this.getRawAmount());

                // Validation
                const transactionType = formData.get('transaction_type');
                const amount = formData.get('amount');
                
                if (!transactionType || !amount || parseInt(amount, 10) === 0) {
                    alert('Vui lòng chọn "Loại giao dịch" và nhập "Số tiền" hợp lệ.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }

                try {
                    // SỬA: API endpoint
                    const response = await fetch('/shift-report/add', {
                        method: 'POST',
                        body: formData,
                    });
                    
                    const result = await response.json();
                    if (!response.ok) {
                         throw new Error(result.detail || 'Lỗi server');
                    }

                    if (result.status === 'success') {
                        showToast('add');
                        this.closeAddModal();
                        
                        // Instant UI
                        this.records.unshift(result.item); 
                        this.records = [...this.records];
                        this.totalRecords++;
                        this.renderPagination(this.currentPage, Math.ceil(this.totalRecords / this.recordsPerPage), this.totalRecords, this.records.length);
                        this.fetchDashboardSummary(); // CẬP NHẬT: Tải lại dashboard
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không nhận được dữ liệu hợp lệ.'));
                    }
                } catch (error) {
                    alert('Lỗi kết nối: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            },

            submitEditForm: async function() {
                if (!confirm('Bạn có chắc chắn muốn lưu các thay đổi này không?')) return;

                const form = document.getElementById('edit-item-form');
                if (!form) return;

                const submitBtn = form.closest('.modal').querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Đang lưu...';

                const formData = new FormData(form);
                
                // Ghi đè 'amount' bằng giá trị số
                formData.set('amount', this.getRawAmount());

                // Validation
                const transactionType = formData.get('transaction_type');
                const amount = formData.get('amount');
                
                if (!transactionType || !amount || parseInt(amount, 10) === 0) {
                    alert('Vui lòng chọn "Loại giao dịch" và nhập "Số tiền" hợp lệ.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }

                try {
                    // SỬA: API endpoint
                    const response = await fetch(`/shift-report/edit-details/${this.editItem.id}`, {
                        method: 'POST',
                        body: formData,
                    });
                    
                    const result = await response.json();
                    if (!response.ok) {
                        let errorMessage = result.detail || 'Lỗi không xác định.';
                        if (Array.isArray(result.detail)) {
                             errorMessage = result.detail.map(e => `${e.loc.join(' -> ')}: ${e.msg}`).join('\n');
                        }
                        throw new Error(errorMessage);
                    }

                    if (result.status === 'success') {
                        showToast('update');
                        this.closeEditModal();

                        // Instant UI
                        const index = this.records.findIndex(r => r.id === this.editItem.id);
                        if (index !== -1) {
                            this.records.splice(index, 1, result.item);
                            this.records = [...this.records];
                        }
                        this.fetchDashboardSummary(); // CẬP NHẬT: Tải lại dashboard
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không nhận được dữ liệu hợp lệ.'));
                    }
                } catch (error) {
                    alert('Lỗi khi lưu:\n' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            },

            // THÊM: Hàm xử lý submit kết ca của admin
            submitAdminCloseShift: async function() {
                const branch = this.adminShiftClose.branch;
                const pmsRevenueRaw = this.adminShiftClose.pmsRevenue.replace(/[^0-9]/g, '');

                if (!branch || !pmsRevenueRaw) {
                    alert('Vui lòng chọn chi nhánh và nhập doanh thu PMS.');
                    return;
                }
                
                // THÊM: Lấy tổng số tiền và số lượng giao dịch đang chờ xử lý từ API
                const pendingSummaryResponse = await fetch(`/shift-report/api/pending-summary?branch=${branch}`);
                const pendingSummaryData = await pendingSummaryResponse.json();
                const totalPendingAmount = pendingSummaryData.total_pending_amount || 0;

                const pendingCountResponse = await fetch(`/shift-report/api?status=PENDING&chi_nhanh=${branch}&per_page=1`); // Vẫn dùng để lấy count
                const pendingCountData = await pendingCountResponse.json();
                const pendingCount = pendingCountData.totalRecords || 0;

                let confirmMessage = `Bạn có chắc chắn muốn kết ca cho chi nhánh "${branch}" không?\nThao tác này sẽ chốt ${pendingCount} giao dịch đang chờ.`;

                // So sánh doanh thu PMS với tổng tiền đang chờ
                const pmsRevenueValue = parseFloat(pmsRevenueRaw);
                if (pmsRevenueValue < totalPendingAmount) {
                    confirmMessage += `\n\n⚠️ CẢNH BÁO: Doanh thu PMS (${this.formatCurrency(pmsRevenueValue)}) đang nhỏ hơn tổng doanh thu chờ xử lý (${this.formatCurrency(totalPendingAmount)}).`;
                }

                if (pendingCount > 0) {
                    // Đã gộp vào message ban đầu
                } else if (pendingCount === 0) {
                    confirmMessage = `Chi nhánh "${branch}" hiện không có giao dịch nào đang chờ xử lý. Bạn vẫn muốn tiếp tục kết ca?`;
                }

                if (!confirm(confirmMessage)) {
                    return;
                }

                // SỬA LỖI: Gửi lại trường `ids` dưới dạng mảng rỗng để khớp với Pydantic model ở backend.
                const payload = { ids: [], branch: branch, pms_revenue: pmsRevenueRaw };
                await this.executeBatchClose(payload);
                this.closeShiftCloseModal();
                // Reset form
                this.adminShiftClose.branch = '';
                this.adminShiftClose.pmsRevenue = '';
            },

            // THÊM: Hàm xử lý submit kết ca của Lễ Tân
            submitLetanCloseShift: async function() {
                // 1. LẤY DỮ LIỆU TỪ STATE (đã được nhập ở main page)
                const branch = this.user.branch;
                const pmsRevenueRaw = this.letanShiftClose.pmsRevenue.replace(/[^0-9]/g, '');

                // 2. VALIDATE LẠI (đề phòng)
                if (!pmsRevenueRaw || parseInt(pmsRevenueRaw, 10) === 0) {
                    alert('Lỗi: Không tìm thấy doanh thu PMS. Vui lòng thử lại.');
                    return;
                }

                // 3. LẤY THÔNG TIN GIAO DỊCH CHỜ (Copy logic từ submitAdminCloseShift)
                const pendingSummaryResponse = await fetch(`/shift-report/api/pending-summary?branch=${branch}`);
                const pendingSummaryData = await pendingSummaryResponse.json();
                const totalPendingAmount = pendingSummaryData.total_pending_amount || 0;

                const pendingCountResponse = await fetch(`/shift-report/api?status=PENDING&chi_nhanh=${branch}&per_page=1`);
                const pendingCountData = await pendingCountResponse.json();
                const pendingCount = pendingCountData.totalRecords || 0;

                // 4. HIỂN THỊ HỘP THOẠI CONFIRM
                let confirmMessage = `Bạn có chắc chắn muốn kết ca cho chi nhánh "${branch}" không?\nThao tác này sẽ chốt ${pendingCount} giao dịch đang chờ.`;
                const pmsRevenueValue = parseFloat(pmsRevenueRaw);
                
                if (pmsRevenueValue < totalPendingAmount) {
                    confirmMessage += `\n\n⚠️ CẢNH BÁO: Doanh thu PMS (${this.formatCurrency(pmsRevenueValue)}) đang nhỏ hơn tổng doanh thu chờ xử lý (${this.formatCurrency(totalPendingAmount)}).`;
                }
                if (pendingCount === 0) {
                    confirmMessage = `Chi nhánh "${branch}" hiện không có giao dịch nào đang chờ xử lý. Bạn vẫn muốn tiếp tục kết ca?`;
                }

                if (!confirm(confirmMessage)) {
                    return; // Hủy nếu người dùng không xác nhận
                }

                // 5. TẠO PAYLOAD VÀ GỌI API
                const payload = { ids: [], branch: branch, pms_revenue: pmsRevenueRaw };
                const logId = await this.executeBatchClose(payload);
                
                // 6. MỞ MODAL CHI TIẾT NẾU THÀNH CÔNG
                if (logId) {
                    this.openShiftCloseDetailModal(logId);
                }
                
                // 7. RESET FORM
                // (Không cần đóng modal vì nó không được mở)
                this.letanShiftClose.pmsRevenue = '';
            },

            // THÊM: Hàm hoàn tác kết ca

            // THÊM: Hàm hoàn tác kết ca
            async undoShiftClose(logId) {
                if (!confirm('Bạn có chắc chắn muốn hoàn tác lần kết ca này không? Các giao dịch liên quan sẽ được chuyển về trạng thái "Chờ xử lý".')) {
                    return;
                }
                try {
                    const response = await fetch(`/shift-report/api/undo-shift-close/${logId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || 'Lỗi server');
                    
                    showToast('update', result.message); // Giả sử bạn có toast 'update'
                    this.fetchData(); // Tải lại bảng chính
                    this.fetchDashboardSummary(); // Tải lại dashboard
                } catch (error) {
                    alert('Lỗi khi hoàn tác: ' + error.message);
                }
            },

            // THÊM: Hàm xóa vĩnh viễn một lần kết ca
            async deleteShiftClose(logId) {
                if (!confirm('CẢNH BÁO: Bạn có chắc chắn muốn XÓA VĨNH VIỄN lần kết ca này không? Hành động này sẽ xóa cả các giao dịch liên quan và không thể hoàn tác.')) {
                    return;
                }
                try {
                    const response = await fetch(`/shift-report/api/delete-shift-close/${logId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || 'Lỗi server');
                    showToast('delete', result.message);
                    this.fetchData();
                    this.fetchDashboardSummary();
                } catch (error) {
                    alert('Lỗi khi xóa kết ca: ' + error.message);
                }
            },

            // SỬA: Hàm helper để gọi API batch-close
            // SỬA: Hàm helper để gọi API batch-close
            async executeBatchClose(payload) {
                try {
                    const response = await fetch('/shift-report/batch-close', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.detail || 'Lỗi server');
                    }

                    // SỬA: Chúng ta chỉ xử lý 'success' (vì backend đã sửa, không còn 'noop')
                    if (result.status === 'success') {
                        showToast('close', result.message);
                        // Cập nhật UI
                        const updatedItemsMap = new Map(result.items.map(item => [item.id, item]));
                        this.records = this.records.map(record => updatedItemsMap.has(record.id) ? updatedItemsMap.get(record.id) : record);
                        this.selectedIds = [];
                        this.fetchDashboardSummary();
                        
                        // SỬA: TRẢ VỀ LOG ID ĐỂ MỞ CHI TIẾT
                        return result.log_id || null; 
                    } else {
                        // Xử lý các trường hợp 'fail' hoặc status lạ khác
                        throw new Error(result.message || 'Trạng thái trả về không thành công.');
                    }
                } catch (error) {
                    alert('Lỗi khi kết ca: ' + error.message);
                    return null; // Trả về null nếu lỗi
                }
            },

            // SỬA: deleteItem (chỉ đổi URL)
            deleteItem: async function (itemId, hardDelete = false) {
                const isAdminAction = (this.userRole === 'admin' || this.userRole === 'boss') && hardDelete;
                const confirmMessage = isAdminAction
                    ? 'Bạn có chắc chắn muốn XÓA VĨNH VIỄN giao dịch này không? Hành động này không thể hoàn tác.'
                    : 'Bạn có chắc chắn muốn xoá giao dịch này không?';

                if (!confirm(confirmMessage)) return;
                
                try {
                    const formData = new FormData();
                    formData.append('hard_delete', hardDelete);

                    // SỬA: API endpoint
                    const response = await fetch(`/shift-report/delete/${itemId}`, {
                        method: 'POST',
                        body: formData 
                    });
                    
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.detail || 'Lỗi server');
                    }
                    
                    if (result.status === 'success') {
                        showToast('delete');
                        this.closeDetailsModal();

                        // Instant UI (giữ nguyên logic)
                        if (result.hard_delete) {
                            this.records = this.records.filter(r => r.id !== result.deleted_id);
                            this.totalRecords--;
                        } else {
                            const index = this.records.findIndex(r => r.id === itemId);
                            if (index !== -1) {
                                this.records.splice(index, 1, result.item);
                                this.records = [...this.records];
                            }
                        }
                        
                        this.renderPagination(this.currentPage, Math.ceil(this.totalRecords / this.recordsPerPage), this.totalRecords, this.records.length);
                        this.fetchDashboardSummary();
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (error) {
                    alert('Lỗi khi xóa: ' + error.message);
                }
            },

            // SỬA: batchDelete (chỉ đổi URL)
            batchDelete: async function() {
                if (this.selectedIds.length === 0) {
                    alert('Vui lòng chọn ít nhất một mục để xóa.');
                    return;
                }
                const confirmMessage = (this.userRole === 'admin' || this.userRole === 'boss')
                    ? `Bạn có chắc chắn muốn XÓA VĨNH VIỄN ${this.selectedIds.length} mục đã chọn không?`
                    : `Bạn có chắc chắn muốn xóa ${this.selectedIds.length} mục đã chọn không?`;

                if (!confirm(confirmMessage)) return;

                try {
                    // SỬA: API endpoint
                    const response = await fetch('/shift-report/batch-delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: this.selectedIds })
                    });
                    
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.detail || 'Lỗi server');
                    }
                    
                    showToast('delete');
                    
                    if (result.status === 'success') {
                        // Instant UI (giữ nguyên logic)
                        if (result.hard_delete) {
                            this.records = this.records.filter(r => !result.ids.includes(r.id));
                            this.totalRecords -= result.ids.length;
                        } else {
                            const updatedItemsMap = new Map(result.items.map(item => [item.id, item]));
                            this.records = this.records.map(record => {
                                if (updatedItemsMap.has(record.id)) {
                                    return updatedItemsMap.get(record.id);
                                }
                                return record;
                            });
                        }
                        
                        this.selectedIds = [];
                        this.renderPagination(this.currentPage, Math.ceil(this.totalRecords / this.recordsPerPage), this.totalRecords, this.records.length);
                        this.fetchDashboardSummary();
                    }
                } catch (error) {
                    alert('Lỗi khi xóa hàng loạt: ' + error.message);
                }
            }
        };  
    }
</script>
<script> // --- LOGIC HIỂN THỊ THÔNG BÁO (TOAST) (ĐÃ SỬA) ---
    // Hàm này sẽ "mở khóa" AudioContext của trình duyệt
    (function() {
      let audioUnlocked = false;
      const unlockAudio = () => {
        if (audioUnlocked) return;
        const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
        audio.play().then(() => { audioUnlocked = true; }).catch(() => {});
        document.body.removeEventListener('click', unlockAudio);
      };
      document.body.addEventListener('click', unlockAudio, { once: true });
    })();

    function showToast(action) {
      const toastMap = {
        add: { title: "Ghi nhận thành công", message: "Giao dịch mới đã được thêm.", bg: "#10b981", sound: "/static/sounds/Add.mp3",
          icon: `<div class="w-8 h-8 flex items-center justify-center rounded-full bg-green-500/10 animate-bounce-in"><svg class="w-5 h-5 text-green-700 dark:text-green-300 drop-shadow" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg></div>`
        },
        update: { title: "Cập nhật thành công", message: "Thông tin giao dịch đã được sửa.", bg: "#3b82f6", sound: "/static/sounds/Update.mp3",
          icon: `<div class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-500/10 animate-scale-fade"><svg class="w-5 h-5 text-blue-700 dark:text-blue-300 drop-shadow" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/></svg></div>`
        },
        // SỬA: 'return' -> 'close'
        close: { title: "Đã Kết Ca", message: "Giao dịch đã được chốt.", bg: "#0ea5e9", sound: "/static/sounds/Complete.mp3",
          icon: `<div class="w-8 h-8 flex items-center justify-center rounded-full bg-sky-500/10 animate-rotate-in"><svg class="w-5 h-5 text-sky-700 dark:text-sky-300 drop-shadow" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>`
        },
        // XOÁ: 'dispose'
        delete: { title: "Đã xoá", message: "Mục đã bị xoá.", bg: "#ef4444", sound: "/static/sounds/Delete.mp3",
          icon: `<div class="w-8 h-8 flex items-center justify-center rounded-full bg-red-500/10 animate-shake"><svg class="w-5 h-5 text-red-700 dark:text-red-300 drop-shadow" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></div>`
        }
      };
      const config = toastMap[action] || toastMap.add;
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
          toastContainer = document.createElement("div");
          toastContainer.id = 'toast-container';
          toastContainer.className = "fixed top-6 right-6 z-[99999] flex flex-col gap-3";
          document.body.appendChild(toastContainer);
      }
      const toast = document.createElement("div");
      toast.className = `group relative overflow-hidden transition-all shadow-xl border border-gray-200 dark:border-gray-700 rounded-xl px-5 py-4 w-[300px] bg-white dark:bg-[#1f2937] backdrop-blur-md animate-toastIn`;
      toast.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="mt-1">${config.icon}</div>
          <div class="flex-1">
            <div class="text-sm font-semibold text-gray-800 dark:text-white">${config.title}</div>
            <div class="text-xs text-gray-600 dark:text-gray-300 mt-0.5">${config.message}</div>
          </div>
        </div>
        <div class="progress-bar absolute bottom-0 left-0 h-[3px] bg-opacity-80"
            style="background-color: ${config.bg}; width: 100%; transition: none;"></div>`;
      toastContainer.appendChild(toast);

      if (config.sound) {
        const audio = new Audio(config.sound);
        audio.volume = 0.6;
        audio.play().catch(err => { console.warn("⚠️ Không phát được âm thanh:", err.message); });
      }

      let duration = 3500, elapsed = 0, last = performance.now();
      const progress = toast.querySelector('.progress-bar');
      const updateProgress = (now) => {
        if (!toast._paused) elapsed += now - last;
        last = now;
        const percent = Math.max(0, 1 - elapsed / duration);
        progress.style.width = `${percent * 100}%`;
        if (elapsed < duration) { toast._rafId = requestAnimationFrame(updateProgress); } 
        else {
          toast.classList.add("opacity-0", "translate-x-6");
          toast.style.transition = "all 0.4s ease-in-out";
          setTimeout(() => toast.remove(), 400);
        }
      };
      toast._paused = false;
      toast._rafId = requestAnimationFrame(updateProgress);
      toast.addEventListener("mouseenter", () => toast._paused = true);
      toast.addEventListener("mouseleave", () => {
        if (toast._rafId) cancelAnimationFrame(toast._rafId);
        toast._paused = false; last = performance.now();
        toast._rafId = requestAnimationFrame(updateProgress);
      });
    }
</script>
{% endblock %}
