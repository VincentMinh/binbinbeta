<!DOCTYPE html>
<html lang="vi" class="h-full antialiased scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Điểm danh — Bin Bin Hotel</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Config Tailwind cho Dark Mode & Font -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
          colors: {
            primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
            dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' } // Slate-based dark theme
          },
          animation: {
            'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
            'fade-in': 'fadeIn 0.2s ease-out',
            'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
          },
          keyframes: {
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            pop: {
              '0%': { transform: 'scale(0.8)' },
              '100%': { transform: 'scale(1)' },
            }
          }
        }
      }
    }
  </script>

  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Custom Scrollbar hide */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Safe Area Variables */
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }

    /* Base styles */
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    
    /* Smooth transitions for theme switch */
    body, div, p, span, input, select, button {
      transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 200ms;
    }

    /* Glassmorphism utilities */
    .glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.5);
    }
    .dark .glass {
      background: rgba(15, 23, 42, 0.85);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Remove Input Spinners */
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-dark-950 dark:text-slate-200">

  <!-- Main Layout -->
  <div class="mx-auto max-w-lg min-h-screen flex flex-col relative pb-32">
    
    <!-- Header (Sticky & Glass) -->
    <header class="sticky top-0 z-30 glass px-4 py-3 flex items-center justify-between shadow-sm shadow-slate-200/50 dark:shadow-none" style="padding-top: calc(var(--safe-top) + 12px)">
      <div class="flex items-center gap-3">
        <div class="relative group cursor-pointer">
          <div class="absolute -inset-1.5 bg-gradient-to-r from-blue-600 to-cyan-500 rounded-xl blur opacity-25 group-hover:opacity-50 transition duration-200"></div>
          <div class="relative h-10 w-10 bg-white dark:bg-slate-800 rounded-xl flex items-center justify-center shadow-sm border border-slate-100 dark:border-slate-700">
            <svg class="h-6 w-6 text-blue-600 dark:text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          </div>
        </div>
        <div>
          <h1 class="text-lg font-bold tracking-tight text-slate-900 dark:text-white">Điểm danh</h1>
          <p class="text-xs font-medium text-slate-500 dark:text-slate-400" id="currentDateDisplay">Bin Bin Hotel</p>
        </div>
      </div>
      
      <!-- Theme Toggle -->
      <button id="themeToggle" class="p-2.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all focus:outline-none active:scale-95">
        <!-- Sun Icon -->
        <svg id="sunIcon" class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        <!-- Moon Icon -->
        <svg id="moonIcon" class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
      </button>
    </header>

    <main class="px-4 mt-4 space-y-4">
      
      <!-- Night Shift Alert -->
      <div id="nightShiftNotice" class="hidden animate-fade-in rounded-2xl bg-amber-50 dark:bg-amber-900/20 border border-amber-100 dark:border-amber-800/50 p-4 shadow-sm">
        <div class="flex gap-3">
          <div class="p-2 bg-amber-100 dark:bg-amber-800/40 rounded-full h-fit text-amber-600 dark:text-amber-400">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
          </div>
          <div>
            <h3 class="text-sm font-bold text-amber-800 dark:text-amber-300">Ca đêm</h3>
            <p class="text-xs mt-1 text-amber-700 dark:text-amber-400/80">
              Điểm danh sẽ được tính cho ngày <strong id="workDate" class="underline decoration-dotted">...</strong>
            </p>
          </div>
        </div>
      </div>

      <!-- Branch Info Card -->
      <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700/50 p-4 shadow-sm flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-full bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center text-blue-600 dark:text-blue-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          </div>
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider font-semibold">Chi nhánh hiện tại</p>
            <p id="branchName" class="text-sm font-bold text-slate-800 dark:text-slate-100 mt-0.5 animate-pulse">Đang định vị...</p>
          </div>
        </div>
      </div>

      <!-- VISUAL SEPARATOR (New Request) -->
      <div class="pt-4 pb-1 flex items-center justify-between opacity-80">
         <h2 class="text-[11px] font-bold uppercase tracking-widest text-slate-400 dark:text-slate-500 ml-1">
            Danh sách nhân viên
         </h2>
         <div class="h-px bg-gradient-to-r from-slate-200 to-transparent dark:from-slate-700 flex-1 ml-4"></div>
      </div>

      <!-- Employee List -->
      <div id="attendanceList" class="space-y-3 pb-4">
        <!-- Skeleton Loading will be injected here -->
      </div>
      
      <!-- Empty State -->
      <div id="emptyHint" class="hidden flex flex-col items-center justify-center py-12 text-center">
        <div class="w-20 h-20 bg-slate-50 dark:bg-slate-800/50 rounded-full flex items-center justify-center mb-4">
          <svg class="w-10 h-10 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        </div>
        <p class="text-slate-500 dark:text-slate-400 font-medium">Chưa có nhân viên nào</p>
        <p class="text-slate-400 dark:text-slate-500 text-sm mt-1">Bấm nút "Thêm" bên dưới để bắt đầu</p>
      </div>

    </main>
  </div>

  <!-- MODERN BOTTOM NAVIGATION BAR (2025 REDESIGN) -->
  <div class="fixed bottom-0 left-0 right-0 z-40">
    <!-- Gradient Fade to separate content -->
    <div class="absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-white via-white/80 to-transparent dark:from-dark-950 dark:via-dark-950/80 pointer-events-none"></div>
    
    <!-- Bar Container -->
    <!-- Added px-8 for "Breathing Room" -->
    <div class="relative glass bg-white/70 dark:bg-slate-900/70 backdrop-blur-2xl border-t border-white/50 dark:border-white/10">
      <div class="mx-auto max-w-lg px-8 pb-[env(safe-area-inset-bottom)] pt-2">
        <div class="grid grid-cols-3 gap-8 h-[68px] items-center">
          
          <!-- LEFT: Refresh -->
          <button id="refreshBtn" class="group flex flex-col items-center justify-center gap-1.5 rounded-2xl p-1 text-slate-400 dark:text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 active:scale-90 transition-all duration-300">
            <!-- Icon -->
            <div class="relative p-1.5 group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 rounded-xl transition-colors">
                <svg class="h-6 w-6 transition-transform duration-700 ease-in-out group-active:-rotate-180" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M3 21v-5h5"></path></svg>
            </div>
            <span class="text-[10px] font-semibold opacity-70 group-hover:opacity-100">Tải lại</span>
          </button>

          <!-- CENTER: Save Attendance (Floating Primary FAB) -->
          <button id="saveBtn" class="group relative -top-8 flex flex-col items-center justify-center focus:outline-none z-10">
            <!-- Glow Effect Layer -->
            <div class="absolute top-2 w-14 h-14 rounded-full bg-blue-500 blur-xl opacity-30 group-hover:opacity-50 transition-opacity duration-500"></div>
            
            <!-- Button Circle -->
            <div class="relative h-[72px] w-[72px] rounded-full bg-gradient-to-b from-blue-500 to-blue-700 shadow-2xl shadow-blue-600/40 text-white flex items-center justify-center transform transition-all duration-300 group-active:scale-95 group-hover:-translate-y-1 border-4 border-white dark:border-slate-900">
              
              <!-- Icon -->
              <svg id="saveIcon" class="h-8 w-8 drop-shadow-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              
              <!-- Spinner -->
              <svg id="saveSpinner" class="hidden h-8 w-8 animate-spin text-white/90" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              
              <!-- Smart Badge (NUMBER instead of !) -->
              <div id="saveBadge" class="hidden absolute -top-1 -right-1 flex h-6 min-w-[24px] px-1.5 items-center justify-center rounded-full bg-red-500 text-[11px] font-bold text-white border-[3px] border-white dark:border-slate-900 shadow-sm transition-transform duration-200">
                0
              </div>
            </div>
            
            <span class="mt-2 text-[11px] font-bold text-blue-600 dark:text-blue-400 tracking-wide uppercase opacity-0 group-hover:opacity-100 transition-opacity absolute -bottom-5">Lưu</span>
          </button>

          <!-- RIGHT: Add Employee -->
          <button id="addEmployeeBtn" class="group flex flex-col items-center justify-center gap-1.5 rounded-2xl p-1 text-slate-400 dark:text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400 active:scale-90 transition-all duration-300">
            <!-- Icon -->
            <div class="relative p-1.5 group-hover:bg-indigo-50 dark:group-hover:bg-indigo-900/20 rounded-xl transition-colors">
                <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            <span class="text-[10px] font-semibold opacity-70 group-hover:opacity-100">Thêm NV</span>
          </button>

        </div>
      </div>
    </div>
  </div>

  <!-- Status Modal (Redesigned) -->
  <div id="statusModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm transition-opacity duration-200 opacity-0">
    <div id="statusModalContent" class="relative w-full max-w-xs bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-6 text-center transform transition-all scale-95 opacity-0">
      
      <!-- Loading State -->
      <div id="statusLoading" class="flex flex-col items-center py-4">
        <div class="relative w-16 h-16">
          <div class="absolute inset-0 rounded-full border-4 border-slate-100 dark:border-slate-700"></div>
          <div class="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
        </div>
        <p id="loadingMessage" class="mt-6 text-slate-800 dark:text-slate-100 font-semibold text-lg">Đang xử lý...</p>
      </div>

      <!-- Success State -->
      <div id="statusSuccess" class="hidden py-2">
        <div class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/30">
          <svg class="h-10 w-10 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <h3 class="mt-4 text-xl font-bold text-slate-900 dark:text-white">Thành công!</h3>
        <p id="successMessage" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Dữ liệu đã được lưu.</p>
        <!-- Timer bar -->
        <div class="mt-6 h-1 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
           <div class="timer-bar-inner h-full bg-green-500 w-full"></div>
        </div>
      </div>

      <!-- Error State -->
      <div id="statusError" class="hidden py-2">
        <div class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30">
          <svg class="h-10 w-10 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </div>
        <h3 class="mt-4 text-xl font-bold text-slate-900 dark:text-white">Có lỗi xảy ra</h3>
        <p id="errorMessage" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Vui lòng thử lại sau.</p>
        <button onclick="hideStatusModal()" class="mt-6 w-full rounded-2xl bg-slate-100 dark:bg-slate-700 py-3 text-sm font-bold text-slate-700 dark:text-slate-200 transition active:scale-95">Đóng</button>
      </div>
    </div>
  </div>

  <!-- Search Modal (Full screen on mobile) -->
  <div id="searchModal" class="fixed inset-0 z-50 hidden bg-white dark:bg-slate-900">
    <div class="flex h-full flex-col">
      <div class="flex items-center gap-3 border-b border-slate-100 dark:border-slate-800 px-4 py-3" style="padding-top: calc(var(--safe-top) + 12px)">
        <button onclick="closeModal('searchModal')" class="rounded-full p-2 -ml-2 text-slate-500 dark:text-slate-400 active:bg-slate-100 dark:active:bg-slate-800">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
        <div class="relative flex-1">
          <input id="searchInputMain" type="text" placeholder="Nhập tên hoặc mã..." class="w-full rounded-xl border-none bg-slate-100 dark:bg-slate-800 py-3 pl-11 pr-4 text-base font-medium text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500/50 outline-none" autocomplete="off" />
          <svg class="absolute left-3.5 top-3.5 h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
      </div>

      <!-- Inline Error Message Container -->
      <div id="searchError" class="hidden px-4 py-3 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-sm font-medium text-center transition-all duration-300">
        Nhân viên đã có trong danh sách.
      </div>
      
      <div class="flex-1 overflow-y-auto px-4 py-4">
        <h4 class="mb-3 text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500">Gợi ý</h4>
        <div id="suggestListMain" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Branch Popup (Bottom Sheet style) -->
  <div id="branchPopup" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center sm:p-4">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeModal('branchPopup')"></div>
    <div class="relative w-full max-w-md rounded-t-3xl sm:rounded-3xl bg-white dark:bg-slate-900 p-6 shadow-2xl transition-transform transform translate-y-full">
      <div class="mb-6 flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-900 dark:text-white">Chọn chi nhánh</h3>
        <button onclick="closeModal('branchPopup')" class="rounded-full bg-slate-100 dark:bg-slate-800 p-2 text-slate-500">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <div id="branchChoices" class="max-h-[60vh] overflow-y-auto space-y-2 pb-8 sm:pb-0"></div>
    </div>
  </div>

  <!-- Template variables -->
  <script>
    const userRole = "{{ role | lower }}";
    const loginCode = "{{ login_code }}";
    const csrfToken = "{{ csrf_token }}";
    let currentBranch = "{{ branch_id }}" || "";
    const qrToken = "{{ token | default('', true) }}";

    /* ========= SOUND MANAGER (NEW) ========= */
    // 1. Mở khóa AudioContext cho Mobile (Copy từ Lost & Found)
    (function() {
      let audioUnlocked = false;
      const unlockAudio = () => {
        if (audioUnlocked) return;
        // Phát một âm thanh rỗng cực ngắn để "mồi" trình duyệt
        const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
        audio.play().then(() => { audioUnlocked = true; }).catch(() => {});
        ['click', 'touchstart'].forEach(evt => document.body.removeEventListener(evt, unlockAudio));
      };
      ['click', 'touchstart'].forEach(evt => document.body.addEventListener(evt, unlockAudio, { once: true }));
    })();

    // 2. Hàm phát âm thanh tập trung
    const audioFiles = {
        success: '/static/sounds/Complete.mp3', // Dùng khi Lưu thành công
        add:     '/static/sounds/Add.mp3',      // Dùng khi Thêm nhân viên vào list
        update:  '/static/sounds/Update.mp3',   // Dùng cho nút Refresh / Mở modal
        delete:  '/static/sounds/Delete.mp3'    // Dùng khi Xóa dòng
    };

    function playSound(type) {
        const src = audioFiles[type];
        if (!src) return;
        const audio = new Audio(src);
        audio.volume = 0.6; // Âm lượng vừa phải
        audio.play().catch(err => console.warn("Audio blocked:", err));
    }

  </script>

  <!-- Logic Script -->
  <script>
    /* ========= Theme Logic ========= */

    const themeToggleBtn = document.getElementById('themeToggle');
    const htmlEl = document.documentElement;

    function initTheme() {
      const storedTheme = localStorage.getItem('theme'); // Lấy theme đã lưu
      if (storedTheme) {
        // Nếu người dùng đã chọn, ưu tiên lựa chọn đó
        htmlEl.classList.toggle('dark', storedTheme === 'dark');
      } else {
        // Nếu chưa, tự động xác định theo giờ
        const currentHour = new Date().getHours();
        // Chế độ tối từ 19:00 (7 PM) đến 6:59 AM
        if (currentHour >= 19 || currentHour < 7) {
          htmlEl.classList.add('dark');
        } else {
          // Chế độ sáng từ 7:00 AM đến 18:59 PM
          htmlEl.classList.remove('dark');
        }
      }
    }
    
    themeToggleBtn.addEventListener('click', () => {
      htmlEl.classList.toggle('dark');
      localStorage.setItem('theme', htmlEl.classList.contains('dark') ? 'dark' : 'light');
    });
    
    initTheme();
    // Update date
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' };
    document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('vi-VN', dateOptions);

    /* ========= App Logic ========= */
    const byBranchUrl = (b) => `{{ url_for('get_employees_by_branch', branch_code='PLACEHOLDER') }}`.replace('PLACEHOLDER', encodeURIComponent(b));
    const searchUrl   = (q) => `{{ url_for('search_employees') }}?q=${encodeURIComponent(q)}&loginCode=${encodeURIComponent(loginCode)}`;
    const saveUrl     = () => `{{ url_for('attendance_checkin_bulk') }}`;
    const detectBranchUrl = () => `{{ url_for('detect_branch') }}`;
    const selectBranchUrl = () => `{{ url_for('select_branch') }}`;

    let employees = [];

    function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    function formatDepartment(department) {
        const roleMap = {
            "letan": "Lễ tân",
            "buongphong": "Buồng phòng",
            "baove": "Bảo vệ",
            "ktv": "Kỹ thuật viên",
            "quanly": "Quản lý"
        };
        const lowerDept = (department || "").toLowerCase();
        return roleMap[lowerDept] || department;
    }
    function escapeAttr(s){ return String(s||"").replaceAll('"','&quot;'); }

    function updateEmployeeOvertime(emp) {
        const isDifferentBranch = (emp.branch || "") !== (emp.branch_today || currentBranch);
        const hasHighWorkUnits = (emp.so_cong_nv || 1) > 1;
        emp.la_tang_ca = isDifferentBranch || hasHighWorkUnits;
    }
    
    function vibrate(duration = 5) {
      if ('vibrate' in navigator && window.navigator.vibrate) navigator.vibrate(duration);
    }

    /* Modal Helpers */
    function openModal(id) {
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.remove('hidden');
        if(id === 'branchPopup') {
            setTimeout(() => el.querySelector('div.transform').classList.remove('translate-y-full'), 10);
        }
        if(id === 'searchModal') {
             setTimeout(() => document.getElementById("searchInputMain").focus(), 100);
        }
    }
    function closeModal(id) {
        const el = document.getElementById(id);
        if(!el) return;
        if(id === 'branchPopup') {
            el.querySelector('div.transform').classList.add('translate-y-full');
            setTimeout(() => el.classList.add('hidden'), 300);
        } else {
            el.classList.add('hidden');
        }
    }

    /* Status Modal Logic */
    const statusModal = document.getElementById('statusModal');
    const statusModalContent = document.getElementById('statusModalContent');
    let modalHideTimer = null;

    function showStatusModal(state, message = "", autoHideDuration = 0, onHidden = null, title = null) {
      if (modalHideTimer) clearTimeout(modalHideTimer);
      
      const states = ['statusLoading', 'statusSuccess', 'statusError'];
      states.forEach(s => document.getElementById(s).classList.add('hidden'));

      if(state === 'loading') {
        document.getElementById('statusLoading').classList.remove('hidden');
        document.getElementById('loadingMessage').textContent = message || "Đang xử lý...";
      } else if(state === 'success') {
        const successEl = document.getElementById('statusSuccess');
        successEl.classList.remove('hidden');
        successEl.querySelector('h3').textContent = title || 'Thành công!';
        successEl.querySelector('p').textContent = message || 'Dữ liệu đã được lưu.';
      } else {
          document.getElementById('statusError').classList.remove('hidden');
          document.getElementById('errorMessage').textContent = message || "Lỗi không xác định";
      }

      statusModal.classList.remove('hidden');
      setTimeout(() => {
          statusModal.classList.remove('opacity-0');
          statusModalContent.classList.remove('scale-95', 'opacity-0');
      }, 10);

      if (state === 'success' && autoHideDuration > 0) {
        const timerBar = document.querySelector('.timer-bar-inner');
        if(timerBar) {
            timerBar.style.width = '100%';
            timerBar.style.transition = `width ${autoHideDuration}ms linear`;
            setTimeout(() => timerBar.style.width = '0%', 50);
        }
        modalHideTimer = setTimeout(() => {
           hideStatusModal();
           if (onHidden) onHidden();
        }, autoHideDuration);
      }
    }

    function hideStatusModal() {
        statusModal.classList.add('opacity-0');
        statusModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => statusModal.classList.add('hidden'), 200);
    }

    /* Render Logic */
    function renderSkeleton(count = 3) {
      const wrap = document.getElementById("attendanceList");
      wrap.innerHTML = "";
      let html = '';
      for (let i = 0; i < count; i++) {
        html += `
        <div class="animate-pulse rounded-2xl border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 shadow-sm">
          <div class="flex items-center gap-4">
             <div class="h-12 w-12 rounded-full bg-slate-200 dark:bg-slate-700"></div>
             <div class="flex-1 space-y-2">
               <div class="h-4 w-1/2 rounded bg-slate-200 dark:bg-slate-700"></div>
               <div class="h-3 w-1/3 rounded bg-slate-200 dark:bg-slate-700"></div>
             </div>
          </div>
          <div class="mt-4 flex gap-3">
             <div class="h-10 w-1/3 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
             <div class="h-10 flex-1 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
          </div>
        </div>`;
      }
      wrap.innerHTML = html;
    }

    function renderAttendanceList(){
      const wrap = document.getElementById("attendanceList");
      wrap.innerHTML = "";
      document.getElementById("emptyHint").classList.toggle('hidden', employees.length > 0);
      
      // === BADGE LOGIC UPDATE (NUMBER COUNT) ===
      const badge = document.getElementById('saveBadge');
      if (employees.length > 0) {
          badge.textContent = employees.length; // Show number
          badge.classList.remove('hidden');
          // Scale Effect on update
          badge.classList.remove('scale-100');
          badge.classList.add('scale-125');
          setTimeout(() => {
             badge.classList.remove('scale-125');
             badge.classList.add('scale-100');
          }, 200);
      } else {
          badge.classList.add('hidden');
      }
      // =========================================

      employees.forEach((emp, idx) => {
        const row = document.createElement("div");
        row.className = "animate-slide-up relative overflow-hidden rounded-2xl border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 shadow-sm transition-all hover:shadow-md";
        row.style.animationDelay = `${idx * 50}ms`;

        let optionsHtml = "";
        const values = emp.department?.toLowerCase() === "letan" ? [0.5, 1] : [0.5, 1, 1.5, 2, 2.5];
        values.forEach(v => {
            optionsHtml += `<option value="${v}" ${emp.so_cong_nv === v ? "selected" : ""}>${v}</option>`;
        });

        // Generate Avatar Initials
        const names = emp.name.split(' ');
        const initials = names.length > 1 ? names[names.length-1][0] : names[0][0];
        const avatarColor = ['bg-blue-100 text-blue-600', 'bg-purple-100 text-purple-600', 'bg-emerald-100 text-emerald-600', 'bg-amber-100 text-amber-600'][emp.code.charCodeAt(emp.code.length-1) % 4];

        row.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-center gap-3">
                <div class="flex h-12 w-12 items-center justify-center rounded-2xl ${avatarColor} dark:bg-opacity-20 font-bold text-lg">
                    ${initials}
                </div>
                <div>
                    <h3 class="font-bold text-slate-800 dark:text-slate-100">${escapeHtml(emp.name)}</h3>
                    <p class="text-xs font-medium text-slate-500 dark:text-slate-400">
                        ${escapeHtml(emp.code)} <span class="mx-1 text-slate-300">|</span> ${escapeHtml(formatDepartment(emp.department))}
                    </p>
                    <div class="badge-container mt-1">
                        ${emp.la_tang_ca ? '<span class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-900/30 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300 ring-1 ring-inset ring-blue-700/10">Tăng ca</span>' : ''}
                    </div>
                </div>
            </div>
            <button data-code="${escapeAttr(emp.code)}" class="btn-delete -mr-2 -mt-2 p-2 text-slate-300 hover:text-red-500 transition-colors">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>

          <div class="mt-4 grid grid-cols-10 gap-3">
            <div class="col-span-3">
                <div class="relative">
                    <select data-code="${escapeAttr(emp.code)}" data-field="so_cong_nv" class="w-full appearance-none rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 py-2.5 pl-3 pr-8 text-sm font-semibold text-slate-700 dark:text-slate-200 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        ${optionsHtml}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>
            <div class="col-span-7">
                <input data-code="${escapeAttr(emp.code)}" data-field="ghi_chu" value="${escapeAttr(emp.ghi_chu || '')}" 
                    placeholder="Ghi chú..." 
                    class="w-full rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 py-2.5 px-3 text-sm text-slate-700 dark:text-slate-200 placeholder-slate-400 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition" />
            </div>
          </div>
        `;

        // Event Handlers
        row.querySelector('.btn-delete').onclick = (e) => {
            vibrate(10);
            playSound('delete');
            employees = employees.filter(x => x.code !== e.currentTarget.dataset.code);
            // Animate out
            const parent = e.currentTarget.closest('div.animate-slide-up');
            parent.style.transform = 'translateX(100%)';
            parent.style.opacity = '0';
            setTimeout(renderAttendanceList, 200);
        };
        
        row.querySelector('select').onchange = (e) => {
            const t = employees.find(x => x.code === e.currentTarget.dataset.code);
            if(t) {
                t.so_cong_nv = parseFloat(e.target.value);
                updateEmployeeOvertime(t);
                renderAttendanceList(); // Re-render to update badges
            }
        };

        row.querySelector('input').oninput = (e) => {
            const t = employees.find(x => x.code === e.currentTarget.dataset.code);
            if(t) t.ghi_chu = e.target.value;
        }

        wrap.appendChild(row);
      });
    }

    async function safeFetchJson(url, options){
      try {
          const res = await fetch(url, options);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const ct = res.headers.get("content-type") || "";
          return ct.includes("application/json") ? res.json() : res.text();
      } catch(e) { throw e; }
    }

    async function loadEmployeesForBranch(){
      if(!currentBranch) return;
      renderSkeleton(3);
      try{
        const data = await safeFetchJson(byBranchUrl(currentBranch));
        if (Array.isArray(data)) {
            employees = data.map(emp => {
                const e = { ...emp, branch_today: currentBranch, so_cong_nv: 1, ghi_chu: "" };
                updateEmployeeOvertime(e);
                return e;
            });
            renderAttendanceList();
        }
      }catch(err){ showStatusModal('error', "Lỗi tải dữ liệu"); }
    }

    /* Save Logic */
    async function saveAttendance(){
      vibrate();
      const saveBtn = document.getElementById('saveBtn');
      if (saveBtn.disabled) return;
      const saveIcon = document.getElementById('saveIcon');
      const saveSpinner = document.getElementById('saveSpinner');

      // THÊM: Hộp thoại xác nhận trước khi lưu
      if (!confirm(`Bạn có chắc chắn muốn lưu điểm danh cho ${employees.length} nhân viên không?`)) {
        return; // Dừng lại nếu người dùng không xác nhận
      }
      
      if (employees.length === 0){ showStatusModal('error', "Danh sách trống!"); return; }
      if (!currentBranch) { showStatusModal('error', "Chưa xác định chi nhánh!"); return; }

      // UI Feedback: Toggle Icon/Spinner
      saveBtn.disabled = true;
      saveIcon.classList.add('hidden');
      saveSpinner.classList.remove('hidden');

      showStatusModal('loading', 'Đang lưu lên hệ thống...');

      const payload = employees.map(emp => ({
        ma_nv: emp.code, ten_nv: emp.name,
        chi_nhanh_chinh: emp.branch, chi_nhanh_lam: currentBranch,
        la_tang_ca: !!emp.la_tang_ca, so_cong_nv: emp.so_cong_nv,
        ghi_chu: emp.ghi_chu, token: qrToken 
      }));

      const resetBtn = () => {
         saveBtn.disabled = false;
         saveIcon.classList.remove('hidden');
         saveSpinner.classList.add('hidden');
      };

      try {
        const res = await fetch(saveUrl(), { 
          method:"POST", headers:{ "Content-Type":"application/json", "X-CSRF-Token": csrfToken },
          body: JSON.stringify(payload)
        });
        
        if(!res.ok) throw new Error("Server Error");
        const doc = await res.json();

        if (doc && doc.status === 'success') {
            playSound('success');
            if(doc.redirect_to) {
                showStatusModal('success', 'Chuyển hướng...', 1000, () => window.location.replace(doc.redirect_to), 'Điểm danh thành công!');
            } else {
                showStatusModal('success', 'Dữ liệu đã được cập nhật.', 2000, () => {
                   const role = (userRole||"").toLowerCase();
                   if (["quanly","ktv","boss","admin"].includes(role)) {
                       employees = []; renderAttendanceList();
                   }
                   resetBtn();
                });
            }
        } else { throw new Error(doc.message || "API returned failure"); }

      } catch(err) {
        playSound('delete')
        showStatusModal('error', "Lỗi lưu: " + err.message);
        resetBtn();
      }
    }

    /* Search & Branch Logic (Simplified for brevity but fully functional) */
    document.getElementById("addEmployeeBtn").onclick = () => { 
        vibrate(); 
        openModal('searchModal'); 
        document.getElementById("searchInputMain").value=""; 
        document.getElementById("suggestListMain").innerHTML=""; 
    };

    document.getElementById("refreshBtn").onclick = () => { 
        vibrate(); 
        playSound('update'); // <--- THÊM: Âm thanh click nhẹ
        document.getElementById("attendanceList").innerHTML=""; 
        loadEmployeesForBranch(); 
    };
    document.getElementById("saveBtn").onclick = saveAttendance;

    let searchTimer;
    document.getElementById("searchInputMain").oninput = (e) => {
        clearTimeout(searchTimer);
        const q = e.target.value.trim();
        if(!q) { document.getElementById("suggestListMain").innerHTML=""; return; }
        searchTimer = setTimeout(async() => {
             try {
                 const data = await safeFetchJson(searchUrl(q));
                 const html = (Array.isArray(data) ? data : []).map(emp => `
                    <div class="flex items-center justify-between gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer active:scale-95 transition" onclick="addOne('${emp.code}', '${escapeAttr(emp.name)}', '${escapeAttr(emp.department)}', '${escapeAttr(emp.branch)}')">
                        <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center font-bold text-blue-600 dark:text-blue-300">${emp.name.charAt(0)}</div>
                        <div>
                            <p class="font-bold text-slate-800 dark:text-slate-100">${escapeHtml(emp.name)}</p>
                            <p class="text-xs text-slate-500">${emp.code} - ${formatDepartment(emp.department)}</p>
                        </div>
                        </div>
                        <div class="p-2 text-slate-400">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        </div>
                    </div>
                 `).join('');
                 document.getElementById("suggestListMain").innerHTML = html;
             } catch(e){}
        }, 300);
    };

    window.addOne = (code, name, dept, branch) => {
        if(employees.some(e => e.code === code)) {
            const errorDiv = document.getElementById('searchError');
            errorDiv.textContent = `Nhân viên "${name}" đã có trong danh sách.`;
            errorDiv.classList.remove('hidden');
            // Rung và phát âm thanh lỗi
            vibrate(20);
            playSound('delete');
            // Tự động ẩn sau 3 giây
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 3000);
            return; 
        }
        // Ẩn thông báo lỗi nếu có
        document.getElementById('searchError').classList.add('hidden');
        const newEmp = { code, name, department: dept, branch, branch_today: currentBranch, so_cong_nv: 1, ghi_chu: "" };
        updateEmployeeOvertime(newEmp);
        employees.unshift(newEmp);
        renderAttendanceList();
        closeModal('searchModal'); // Đóng modal sau khi thêm
        playSound('add');
        showStatusModal('success', `Đã thêm "${name} - ${formatDepartment(dept)}" vào danh sách.`, 2000);
    };

    /* GPS & Init */
    async function detectBranchByGPS(){
      // Logic same as original, adapted for UI
      if (!navigator.geolocation) return;
      document.getElementById("branchName").textContent = "Đang tìm vị trí...";
      navigator.geolocation.getCurrentPosition(async (pos)=>{
          try {
             const data = await safeFetchJson(detectBranchUrl(), { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ lat:pos.coords.latitude, lng:pos.coords.longitude }) });
             if(data.branch) {
                 currentBranch = data.branch;
                 document.getElementById("branchName").textContent = currentBranch || "(Chưa rõ)";
                 loadEmployeesForBranch();
             } else if(data.choices) {
                 // Populate branch popup
                 const html = data.choices.map(c => `
                    <button onclick="selectBranch('${c.branch}')" class="w-full flex items-center justify-between p-4 rounded-xl border border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 mb-2 transition">
                        <span class="font-bold text-slate-800 dark:text-slate-200">${c.branch}</span>
                        <span class="text-xs text-slate-500">${Math.round(c.distance_km*1000)}m</span>
                    </button>
                 `).join('');
                 document.getElementById('branchChoices').innerHTML = html;
                 openModal('branchPopup');
             }
          } catch(e) { document.getElementById("branchName").textContent = "Lỗi GPS"; }
      }, () => document.getElementById("branchName").textContent = "Không có GPS");
    }

    window.selectBranch = async (b) => {
        currentBranch = b;
        document.getElementById("branchName").textContent = b;
        await safeFetchJson(selectBranchUrl(), { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ branch: b }) });
        closeModal('branchPopup');
        loadEmployeesForBranch();
    }

    // Initialize logic
    window.addEventListener("DOMContentLoaded", async () => {
        // Night shift logic
        const h = new Date().getHours();
        if(h < 7) {
            const y = new Date(); y.setDate(y.getDate()-1);
            document.getElementById('workDate').textContent = `${y.getDate()}/${y.getMonth()+1}/${y.getFullYear()}`;
            document.getElementById('nightShiftNotice').classList.remove('hidden');
        }
        
        const role = (userRole||"").toLowerCase();
        if(["quanly","ktv","boss","admin"].includes(role)) {
            try {
                const d = await safeFetchJson("/attendance/api/detect-branch", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({}) });
                if(d.branch) { currentBranch=d.branch; document.getElementById("branchName").textContent=currentBranch; loadEmployeesForBranch(); }
            } catch(e){}
        } else {
            detectBranchByGPS();
        }
    });
  </script>
</body>
</html>
