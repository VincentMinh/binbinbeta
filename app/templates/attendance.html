<!DOCTYPE html>
<html lang="vi" class="h-full antialiased scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Điểm danh — Bin Bin Hotel</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Config Tailwind cho Dark Mode & Font -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
          colors: {
            primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
            dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' } // Slate-based dark theme
          },
          animation: {
            'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
            'fade-in': 'fadeIn 0.2s ease-out',
            'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
          },
          keyframes: {
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            pop: {
              '0%': { transform: 'scale(0.8)' },
              '100%': { transform: 'scale(1)' },
            }
          }
        }
      }
    }
  </script>

  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>

    /* Thêm vào trong <style> */
    .bg-size-200 {
        background-size: 200% 200%;
    }
    .bg-pos-0 {
        background-position: 0% 0%;
    }
    .bg-pos-100 {
        background-position: 100% 100%;
    }

    /* Custom Scrollbar hide */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Safe Area Variables */
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }

    /* Base styles */
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    
    /* Smooth transitions for theme switch */
    body, div, p, span, input, select, button {
      transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 200ms;
    }

    /* Glassmorphism utilities */
    .glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.5);
    }
    .dark .glass {
      background: rgba(15, 23, 42, 0.85);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Remove Input Spinners */
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

    /* Thêm vào trong thẻ <style> */

    /* Hiệu ứng trượt sang phải khi xóa */
    .slide-out-right {
      animation: slideOutRight 0.4s cubic-bezier(0.33, 1, 0.68, 1) forwards;
    }

    /* Hiệu ứng thu gọn chiều cao sau khi trượt xong */
    .collapse-height {
      transition: max-height 0.3s ease-out, margin-top 0.3s ease-out, padding 0.3s ease-out, opacity 0.3s ease-out;
      max-height: 0 !important;
      margin-top: 0 !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      opacity: 0 !important;
      overflow: hidden;
    }

    @keyframes slideOutRight {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
    }

    /* Tinh chỉnh Select box cho gọn - SẠCH SẼ HOÀN TOÀN */
    .select-minimal {
      background-image: none; /* Bỏ mũi tên */
      text-align: center;
      text-align-last: center;
      border: none !important;      /* Bỏ viền */
      outline: none !important;     /* Bỏ focus ring */
      box-shadow: none !important;  /* Bỏ bóng */
    }
    
    /* Xóa bỏ focus mặc định của Firefox */
    .select-minimal:-moz-focusring {
      color: transparent;
      text-shadow: 0 0 0 #000;
    }

    .ui-locked {
        pointer-events: none !important; /* Không cho click bất cứ đâu */
        filter: grayscale(100%) opacity(0.6); /* Xám màu và mờ đi */
        user-select: none; /* Không cho bôi đen text */
    }

    /* [NEW] Style cho Modal Cảnh báo bắt buộc (Không cho đóng) */
    .modal-backdrop-force {
        background-color: rgba(0, 0, 0, 0.9) !important; /* Đen đặc hơn */
        backdrop-filter: blur(5px);
        z-index: 9999; /* Luôn đè lên trên cùng */
    }
  </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-dark-950 dark:text-slate-200">

  <!-- Main Layout -->
  <div class="mx-auto max-w-lg min-h-screen flex flex-col relative pb-32">
    
    <!-- Header (Sticky & Glass) -->
    <!-- Header (Sticky & Glass) - DESIGN 2025: SQUIRCLE ICON & CLEAN TYPO -->
    <header class="sticky top-0 z-30 glass px-6 py-4 flex items-center justify-between transition-all duration-300" style="padding-top: calc(var(--safe-top) + 16px)">
      
      <!-- Left: Brand Identity -->
      <div class="flex items-center gap-4">
        
        <!-- Logo Container: Hình khối bo tròn mềm mại (Squircle) + Hiệu ứng chiều sâu -->
        <div class="relative group cursor-pointer">
            <!-- Glow Effect phía sau -->
            <div class="absolute inset-0 bg-blue-500/20 dark:bg-blue-400/10 blur-xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
            
            <!-- Icon Box chính -->
            <div class="relative h-11 w-11 flex items-center justify-center rounded-2xl bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 border border-slate-100 dark:border-slate-700 shadow-[0_2px_8px_rgba(0,0,0,0.04)] dark:shadow-none group-hover:scale-105 transition-transform duration-300">
                <svg class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
        </div>
        
        <!-- Text Info -->
        <div class="flex flex-col justify-center">
          <h1 class="text-lg font-bold text-slate-900 dark:text-white leading-none tracking-tight">
            Điểm danh
          </h1>
          
          <!-- Live Date Status -->
          <div class="flex items-center gap-1.5 mt-1.5">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
            </span>
            <p class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-widest" id="currentDateDisplay">
              Loading...
            </p>
          </div>
        </div>
      </div>
      
      <!-- Right: Theme Toggle (Minimalist) -->
      <button id="themeToggle" class="group p-2.5 rounded-2xl bg-slate-50/50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700 border border-transparent hover:border-slate-200 dark:hover:border-slate-600 text-slate-500 dark:text-slate-400 transition-all focus:outline-none active:scale-95">
        <svg id="sunIcon" class="w-5 h-5 hidden dark:block transition-transform duration-500 group-hover:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        <svg id="moonIcon" class="w-5 h-5 block dark:hidden transition-transform duration-500 group-hover:-rotate-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
      </button>
    </header>

    <main class="px-4 mt-4 space-y-4">
      
      <!-- Night Shift Alert -->
      <div id="nightShiftNotice" class="hidden animate-fade-in rounded-2xl bg-amber-50 dark:bg-amber-900/20 border border-amber-100 dark:border-amber-800/50 p-4 shadow-sm">
        <div class="flex gap-3">
          <div class="p-2 bg-amber-100 dark:bg-amber-800/40 rounded-full h-fit text-amber-600 dark:text-amber-400">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
          </div>
          <div>
            <h3 class="text-sm font-bold text-amber-800 dark:text-amber-300">Ca đêm</h3>
            <p class="text-xs mt-1 text-amber-700 dark:text-amber-400/80">
              Điểm danh sẽ được tính cho ngày <strong id="workDate" class="underline decoration-dotted">...</strong>
            </p>
          </div>
        </div>
      </div>

      <!-- Branch Info Card -->
      <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700/50 p-4 shadow-sm flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-full bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center text-blue-600 dark:text-blue-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          </div>
          <div>
            <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider font-semibold">Chi nhánh hiện tại</p>
            <p id="branchName" class="text-sm font-bold text-slate-800 dark:text-slate-100 mt-0.5 animate-pulse">Đang định vị...</p>
          </div>
        </div>
      </div>

      <!-- VISUAL SEPARATOR (New Request) -->
      <div class="pt-4 pb-1 flex items-center justify-between opacity-80">
         <h2 class="text-[11px] font-bold uppercase tracking-widest text-slate-400 dark:text-slate-500 ml-1">
            Danh sách nhân viên
         </h2>
         <div class="h-px bg-gradient-to-r from-slate-200 to-transparent dark:from-slate-700 flex-1 ml-4"></div>
      </div>

      <!-- Employee List -->
      <div id="attendanceList" class="space-y-3 pb-4">
        <!-- Skeleton Loading will be injected here -->
      </div>
      
      <!-- Empty State -->
      <div id="emptyHint" class="hidden flex flex-col items-center justify-center py-12 text-center">
        <div class="w-20 h-20 bg-slate-50 dark:bg-slate-800/50 rounded-full flex items-center justify-center mb-4">
          <svg class="w-10 h-10 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        </div>
        <p class="text-slate-500 dark:text-slate-400 font-medium">Chưa có nhân viên nào</p>
        <p class="text-slate-400 dark:text-slate-500 text-sm mt-1">Bấm nút "Thêm" hoặc "Tải lại" bên dưới để bắt đầu</p>
      </div>

    </main>
  </div>

  <!-- MODERN BOTTOM NAVIGATION BAR (2025 REDESIGN) -->
  <div class="fixed bottom-0 left-0 right-0 z-40">
    <!-- Gradient Fade to separate content -->
    <div class="absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-white via-white/80 to-transparent dark:from-dark-950 dark:via-dark-950/80 pointer-events-none"></div>
    
    <!-- Bar Container -->
    <!-- Added px-8 for "Breathing Room" -->
    <div class="relative glass bg-white/70 dark:bg-slate-900/70 backdrop-blur-2xl border-t border-white/50 dark:border-white/10">
      <div class="mx-auto max-w-lg px-8 pb-[env(safe-area-inset-bottom)] pt-2">
        <div class="grid grid-cols-3 gap-8 h-[68px] items-center">
          
          <!-- LEFT: Refresh -->
          <button id="refreshBtn" class="group flex flex-col items-center justify-center gap-1.5 rounded-2xl p-1 text-slate-400 dark:text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 active:scale-90 transition-all duration-300">
            <!-- Icon -->
            <div class="relative p-1.5 group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 rounded-xl transition-colors">
                <svg class="h-6 w-6 transition-transform duration-700 ease-in-out group-active:-rotate-180" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M3 21v-5h5"></path></svg>
            </div>
            <span class="text-[10px] font-semibold opacity-70 group-hover:opacity-100">Tải lại</span>
          </button>

          <!-- CENTER: Save Attendance (Floating Primary FAB) -->
          <button id="saveBtn" class="group relative -top-8 flex flex-col items-center justify-center focus:outline-none z-10">
            
            <div class="absolute top-1 left-1/2 -translate-x-1/2 w-16 h-16 rounded-full bg-cyan-500 blur-2xl opacity-40 group-hover:opacity-70 animate-pulse transition-opacity duration-500"></div>
            
            <div class="relative h-[72px] w-[72px] rounded-full 
                        bg-gradient-to-br from-cyan-400 via-blue-500 to-indigo-600 
                        shadow-[0_0_20px_rgba(6,182,212,0.5)] 
                        text-white flex items-center justify-center 
                        transform transition-all duration-300 
                        group-active:scale-95 group-hover:-translate-y-1 group-hover:shadow-[0_10px_30px_rgba(6,182,212,0.6)]
                        border-[4px] border-white dark:border-slate-900 bg-size-200 bg-pos-0 hover:bg-pos-100">
              
              <svg id="saveIcon" class="h-9 w-9 drop-shadow-md transition-transform duration-300 group-hover:rotate-12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              
              <svg id="saveSpinner" class="hidden h-8 w-8 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              
              <div id="saveBadge" class="hidden absolute top-0 -right-1 flex h-6 min-w-[24px] px-1.5 items-center justify-center rounded-full bg-red-500 text-[11px] font-bold text-white border-[3px] border-white dark:border-slate-900 shadow-sm transition-transform duration-200">
                0
              </div>
            </div>
            
            <span class="mt-2 text-[10px] font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600 tracking-wider uppercase opacity-0 group-hover:opacity-100 transition-opacity absolute -bottom-6">
                Hoàn tất
            </span>
          </button>

          <!-- RIGHT: Add Employee -->
          <button id="addEmployeeBtn" class="group flex flex-col items-center justify-center gap-1.5 rounded-2xl p-1 text-slate-400 dark:text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400 active:scale-90 transition-all duration-300">
            <!-- Icon -->
            <div class="relative p-1.5 group-hover:bg-indigo-50 dark:group-hover:bg-indigo-900/20 rounded-xl transition-colors">
                <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            <span class="text-[10px] font-semibold opacity-70 group-hover:opacity-100">Thêm NV</span>
          </button>

        </div>
      </div>
    </div>
  </div>

  <!-- Status Modal (Redesigned) -->
  <div id="statusModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm transition-opacity duration-200 opacity-0">
    <div id="statusModalContent" class="relative w-full max-w-xs bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-6 text-center transform transition-all scale-95 opacity-0">
      
      <!-- Loading State -->
      <div id="statusLoading" class="flex flex-col items-center py-4">
        <div class="relative w-16 h-16">
          <div class="absolute inset-0 rounded-full border-4 border-slate-100 dark:border-slate-700"></div>
          <div class="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
        </div>
        <p id="loadingMessage" class="mt-6 text-slate-800 dark:text-slate-100 font-semibold text-lg">Đang xử lý...</p>
      </div>

      <!-- Success State -->
      <div id="statusSuccess" class="hidden py-2">
        <div class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/30">
          <svg class="h-10 w-10 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <h3 class="mt-4 text-xl font-bold text-slate-900 dark:text-white">Thành công!</h3>
        <p id="successMessage" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Dữ liệu đã được lưu.</p>
        <!-- Timer bar -->
        <div class="mt-6 h-1 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
           <div class="timer-bar-inner h-full bg-green-500 w-full"></div>
        </div>
      </div>

      <!-- Error State -->
      <div id="statusError" class="hidden py-2">
        <div class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30">
          <svg class="h-10 w-10 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </div>
        <h3 class="mt-4 text-xl font-bold text-slate-900 dark:text-white">Có lỗi xảy ra</h3>
        <p id="errorMessage" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Vui lòng thử lại sau.</p>
        <button onclick="hideStatusModal()" class="mt-6 w-full rounded-2xl bg-slate-100 dark:bg-slate-700 py-3 text-sm font-bold text-slate-700 dark:text-slate-200 transition active:scale-95">Đóng</button>
      </div>
    </div>
  </div>

  <!-- Search Modal (Full screen on mobile) -->
  <div id="searchModal" class="fixed inset-0 z-50 hidden bg-white dark:bg-slate-900">
    <div class="flex h-full flex-col">
      <div class="flex items-center gap-3 border-b border-slate-100 dark:border-slate-800 px-4 py-3" style="padding-top: calc(var(--safe-top) + 12px)">
        <button onclick="closeModal('searchModal')" class="rounded-full p-2 -ml-2 text-slate-500 dark:text-slate-400 active:bg-slate-100 dark:active:bg-slate-800">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
        <div class="relative flex-1">
          <input id="searchInputMain" type="text" placeholder="Nhập tên hoặc mã..." class="w-full rounded-xl border-none bg-slate-100 dark:bg-slate-800 py-3 pl-11 pr-4 text-base font-medium text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500/50 outline-none" autocomplete="off" />
          <svg class="absolute left-3.5 top-3.5 h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
      </div>

      <!-- Inline Error Message Container -->
      <div id="searchError" class="hidden px-4 py-3 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-sm font-medium text-center transition-all duration-300">
        Nhân viên đã có trong danh sách.
      </div>
      
      <div class="flex-1 overflow-y-auto px-4 py-4">
        <h4 class="mb-3 text-xs font-semibold uppercase tracking-wider text-slate-400 dark:text-slate-500">Gợi ý</h4>
        <div id="suggestListMain" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Branch Popup (Bottom Sheet style) -->
  <div id="branchPopup" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center sm:p-4">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeModal('branchPopup')"></div>
    <div class="relative w-full max-w-md rounded-t-3xl sm:rounded-3xl bg-white dark:bg-slate-900 p-6 shadow-2xl transition-transform transform translate-y-full">
      <div class="mb-6 flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-900 dark:text-white">Chọn chi nhánh</h3>
        <button onclick="closeModal('branchPopup')" class="rounded-full bg-slate-100 dark:bg-slate-800 p-2 text-slate-500">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <div id="branchChoices" class="max-h-[60vh] overflow-y-auto space-y-2 pb-8 sm:pb-0"></div>
    </div>
  </div>

  <!-- Template variables -->
  <script>
    const userRole = "{{ role | lower }}";
    const loginCode = "{{ login_code }}";
    const csrfToken = "{{ csrf_token }}";
    let currentBranch = "{{ branch_id }}" || "";
    const qrToken = "{{ token | default('', true) }}";

    /* ========= SOUND MANAGER (NEW) ========= */
    // 1. Mở khóa AudioContext cho Mobile (Copy từ Lost & Found)
    (function() {
      let audioUnlocked = false;
      const unlockAudio = () => {
        if (audioUnlocked) return;
        // Phát một âm thanh rỗng cực ngắn để "mồi" trình duyệt
        const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
        audio.play().then(() => { audioUnlocked = true; }).catch(() => {});
        ['click', 'touchstart'].forEach(evt => document.body.removeEventListener(evt, unlockAudio));
      };
      ['click', 'touchstart'].forEach(evt => document.body.addEventListener(evt, unlockAudio, { once: true }));
    })();

    // 2. Hàm phát âm thanh tập trung
    const audioFiles = {
        success: '/static/sounds/Complete.mp3', // Dùng khi Lưu thành công
        add:     '/static/sounds/Add.mp3',      // Dùng khi Thêm nhân viên vào list
        update:  '/static/sounds/Update.mp3',   // Dùng cho nút Refresh / Mở modal
        delete:  '/static/sounds/Delete.mp3'    // Dùng khi Xóa dòng
    };

    function playSound(type) {
        const src = audioFiles[type];
        if (!src) return;
        const audio = new Audio(src);
        audio.volume = 0.6; // Âm lượng vừa phải
        audio.play().catch(err => console.warn("Audio blocked:", err));
    }

  </script>

  <!-- Logic Script -->
  <script>
    /* ========= Theme Logic ========= */

    const themeToggleBtn = document.getElementById('themeToggle');
    const htmlEl = document.documentElement;

    function initTheme() {
      const storedTheme = localStorage.getItem('theme'); // Lấy theme đã lưu
      if (storedTheme) {
        // Nếu người dùng đã chọn, ưu tiên lựa chọn đó
        htmlEl.classList.toggle('dark', storedTheme === 'dark');
      } else {
        // Nếu chưa, tự động xác định theo giờ
        const currentHour = new Date().getHours();
        // Chế độ tối từ 19:00 (7 PM) đến 6:59 AM
        if (currentHour >= 19 || currentHour < 7) {
          htmlEl.classList.add('dark');
        } else {
          // Chế độ sáng từ 7:00 AM đến 18:59 PM
          htmlEl.classList.remove('dark');
        }
      }
    }
    
    themeToggleBtn.addEventListener('click', () => {
      htmlEl.classList.toggle('dark');
      localStorage.setItem('theme', htmlEl.classList.contains('dark') ? 'dark' : 'light');
    });
    
    initTheme();
    // Update date
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' };
    document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('vi-VN', dateOptions);

    /* ========= App Logic ========= */
    const byBranchUrl = (b) => `{{ url_for('get_employees_by_branch', branch_code='PLACEHOLDER') }}`.replace('PLACEHOLDER', encodeURIComponent(b));
    const searchUrl   = (q) => `{{ url_for('search_employees') }}?q=${encodeURIComponent(q)}&loginCode=${encodeURIComponent(loginCode)}`;
    const saveUrl     = () => `{{ url_for('attendance_checkin_bulk') }}`;
    const detectBranchUrl = () => `{{ url_for('detect_branch') }}`;
    const selectBranchUrl = () => `{{ url_for('select_branch') }}`;

    let employees = [];

    // [THÊM MỚI] Hàm chuyển đổi Mã chi nhánh -> Tên hiển thị đầy đủ
    function getBranchFullName(code) {
        if (!code) return "Chưa xác định";
        
        // 1. Các chi nhánh đặc biệt
        const specialMap = {
            "QL": "Văn phòng Quản Lý",
            "KTV": "Bộ phận Kỹ Thuật",
            "ADMIN": "Quản Trị Hệ Thống",
            "BOSS": "Ban Giám Đốc",
            "DI DONG": "Nhân viên chạy ca (Mobile)"
        };
        
        if (specialMap[code]) return specialMap[code];
        
        // 2. Các chi nhánh Khách sạn (B1, B2, B10...)
        // Logic: Nếu bắt đầu bằng chữ "B" và theo sau là số -> Bin Bin Hotel + số
        if (/^B\d+$/.test(code)) {
            return `Bin Bin Hotel ${code.substring(1)}`;
        }
        
        // 3. Fallback: Nếu không khớp cái nào thì trả về mã gốc
        return code;
    }

    function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    function formatDepartment(department) {
        const roleMap = {
            "letan": "Lễ tân",
            "buongphong": "Buồng phòng",
            "baove": "Bảo vệ",
            "ktv": "Kỹ thuật viên",
            "quanly": "Quản lý"
        };
        const lowerDept = (department || "").toLowerCase();
        return roleMap[lowerDept] || department;
    }
    function escapeAttr(s){ return String(s||"").replaceAll('"','&quot;'); }

    function updateEmployeeOvertime(emp) {
        const isDifferentBranch = (emp.branch || "") !== (emp.branch_today || currentBranch);
        const hasHighWorkUnits = (emp.so_cong_nv || 1) > 1;
        emp.la_tang_ca = isDifferentBranch || hasHighWorkUnits;
    }
    
    function vibrate(duration = 5) {
      if ('vibrate' in navigator && window.navigator.vibrate) navigator.vibrate(duration);
    }

    /* Modal Helpers */
    function openModal(id) {
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.remove('hidden');
        if(id === 'branchPopup') {
            setTimeout(() => el.querySelector('div.transform').classList.remove('translate-y-full'), 10);
        }
        if(id === 'searchModal') {
             setTimeout(() => document.getElementById("searchInputMain").focus(), 100);
        }
    }
    function closeModal(id) {
        const el = document.getElementById(id);
        if(!el) return;
        if(id === 'branchPopup') {
            el.querySelector('div.transform').classList.add('translate-y-full');
            setTimeout(() => el.classList.add('hidden'), 300);
        } else {
            el.classList.add('hidden');
        }
    }

    /* Status Modal Logic */
    const statusModal = document.getElementById('statusModal');
    const statusModalContent = document.getElementById('statusModalContent');
    let modalHideTimer = null;

    function showStatusModal(state, message = "", autoHideDuration = 0, onHidden = null, title = null) {
      if (modalHideTimer) clearTimeout(modalHideTimer);
      
      const states = ['statusLoading', 'statusSuccess', 'statusError'];
      states.forEach(s => document.getElementById(s).classList.add('hidden'));

      if(state === 'loading') {
        document.getElementById('statusLoading').classList.remove('hidden');
        document.getElementById('loadingMessage').textContent = message || "Đang xử lý...";
      } else if(state === 'success') {
        const successEl = document.getElementById('statusSuccess');
        successEl.classList.remove('hidden');
        successEl.querySelector('h3').textContent = title || 'Thành công!';
        successEl.querySelector('p').textContent = message || 'Dữ liệu đã được lưu.';
      } else {
          document.getElementById('statusError').classList.remove('hidden');
          document.getElementById('errorMessage').textContent = message || "Lỗi không xác định";
      }

      statusModal.classList.remove('hidden');
      setTimeout(() => {
          statusModal.classList.remove('opacity-0');
          statusModalContent.classList.remove('scale-95', 'opacity-0');
      }, 10);

      if (state === 'success' && autoHideDuration > 0) {
        const timerBar = document.querySelector('.timer-bar-inner');
        if(timerBar) {
            timerBar.style.width = '100%';
            timerBar.style.transition = `width ${autoHideDuration}ms linear`;
            setTimeout(() => timerBar.style.width = '0%', 50);
        }
        modalHideTimer = setTimeout(() => {
           hideStatusModal();
           if (onHidden) onHidden();
        }, autoHideDuration);
      }
    }

    function hideStatusModal() {
        statusModal.classList.add('opacity-0');
        statusModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => statusModal.classList.add('hidden'), 200);
    }

    /* Render Logic */
    function renderSkeleton(count = 3) {
      const wrap = document.getElementById("attendanceList");
      wrap.innerHTML = "";
      let html = '';
      for (let i = 0; i < count; i++) {
        html += `
        <div class="animate-pulse rounded-2xl border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 shadow-sm">
          <div class="flex items-center gap-4">
             <div class="h-12 w-12 rounded-full bg-slate-200 dark:bg-slate-700"></div>
             <div class="flex-1 space-y-2">
               <div class="h-4 w-1/2 rounded bg-slate-200 dark:bg-slate-700"></div>
               <div class="h-3 w-1/3 rounded bg-slate-200 dark:bg-slate-700"></div>
             </div>
          </div>
          <div class="mt-4 flex gap-3">
             <div class="h-10 w-1/3 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
             <div class="h-10 flex-1 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
          </div>
        </div>`;
      }
      wrap.innerHTML = html;
    }

    // [UX 2025] Hàm Render: Color Coding (Vàng cho Tăng ca) - Bỏ Badge chữ
    function renderAttendanceList(){
      const wrap = document.getElementById("attendanceList");
      wrap.innerHTML = "";
      
      document.getElementById("emptyHint").classList.toggle('hidden', employees.length > 0);
      updateBadgeUI(); 

      employees.forEach((emp, idx) => {
        const row = document.createElement("div");
        
        // === [LOGIC MÀU SẮC ĐỘNG] ===
        // Nếu tăng ca: Nền Vàng (Amber) + Viền Vàng
        // Nếu thường: Nền Trắng (White/Slate) + Viền Xám
        const bgClass = emp.la_tang_ca 
            ? "bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-700/50" 
            : "bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700/50";

        row.className = `employee-card animate-slide-up relative overflow-hidden rounded-2xl border shadow-sm transition-all h-auto ${bgClass}`;
        row.style.animationDelay = `${idx * 40}ms`; 
        row.dataset.code = emp.code; 

        // Generate Options
        let optionsHtml = "";
        const values = emp.department?.toLowerCase() === "letan" ? [0.5, 1] : [0.5, 1, 1.5, 2, 2.5];
        values.forEach(v => {
            optionsHtml += `<option value="${v}" ${emp.so_cong_nv === v ? "selected" : ""}>${v}</option>`;
        });

        // HTML Content
        row.innerHTML = `
          <div class="p-4">
            <div class="flex items-start justify-between gap-3">
                
                <div class="flex-1 min-w-0 flex flex-col gap-1">
                    <h3 class="font-bold text-[15px] text-slate-800 dark:text-slate-100 leading-snug break-words text-pretty">
                        ${escapeHtml(emp.name)}
                    </h3>

                    <p class="text-xs font-medium text-slate-400 dark:text-slate-500 flex items-center gap-1.5">
                        <span class="uppercase tracking-wider font-semibold opacity-80">${escapeHtml(emp.code)}</span>
                        <span class="h-1 w-1 rounded-full bg-slate-300 dark:bg-slate-600 shrink-0"></span>
                        <span class="truncate">${escapeHtml(formatDepartment(emp.department))}</span>
                    </p>
                </div>

                <div class="shrink-0 flex items-center gap-1 rounded-xl p-1 border self-start mt-0.5 ${emp.la_tang_ca ? 'bg-white/60 dark:bg-black/20 border-amber-200/50 dark:border-amber-700/30' : 'bg-slate-50 dark:bg-slate-700/50 border-slate-100 dark:border-slate-700'}">
                     
                     <div class="relative group h-8 flex items-center justify-center">
                        <select data-code="${escapeAttr(emp.code)}" class="select-minimal w-14 appearance-none bg-transparent text-sm font-bold text-blue-600 dark:text-blue-400 cursor-pointer">
                            ${optionsHtml}
                        </select>
                     </div>

                     <div class="w-px h-4 bg-slate-200 dark:bg-slate-600 opacity-50"></div>

                     <button type="button" class="btn-delete p-2 text-slate-400 hover:text-red-500 hover:bg-white dark:hover:bg-slate-600 rounded-lg transition-all active:scale-90" data-code="${escapeAttr(emp.code)}" data-name="${escapeAttr(emp.name)}">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                     </button>
                </div>
            </div>

            <div class="mt-3">
                <div class="relative group">
                    <input data-code="${escapeAttr(emp.code)}" data-field="ghi_chu" value="${escapeAttr(emp.ghi_chu || '')}" 
                        placeholder="Thêm ghi chú..." 
                        class="w-full rounded-xl border-none py-2.5 px-3 text-sm text-slate-700 dark:text-slate-200 placeholder-slate-400 focus:ring-2 focus:ring-blue-500/20 transition-all ${emp.la_tang_ca ? 'bg-white/80 dark:bg-black/20 focus:bg-white dark:focus:bg-black/40' : 'bg-slate-50 dark:bg-slate-900/50 focus:bg-white dark:focus:bg-slate-800'}" />
                </div>
            </div>
          </div>
        `;

        // === LOGIC XÓA (Giữ nguyên) ===
        const delBtn = row.querySelector('.btn-delete');
        delBtn.onclick = (e) => {
            e.stopPropagation();
            const btn = e.currentTarget;
            const empName = btn.dataset.name;
            const codeToDelete = btn.dataset.code;

            if (!confirm(`Bạn có chắc chắn muốn xóa nhân viên "${empName}" khỏi danh sách chấm công không?`)) {
                return;
            }

            vibrate(10);
            playSound('delete');

            const card = btn.closest('.employee-card');
            card.style.pointerEvents = 'none';
            card.style.maxHeight = card.scrollHeight + "px";

            requestAnimationFrame(() => {
                card.classList.add('slide-out-right');
                setTimeout(() => {
                    card.classList.add('collapse-height');
                    setTimeout(() => {
                        card.remove();
                        employees = employees.filter(x => x.code !== codeToDelete);
                        updateBadgeUI();
                        if(employees.length === 0) document.getElementById("emptyHint").classList.remove('hidden');
                    }, 300);
                }, 350);
            });
        };
        
        // Event Change Select
        const selectEl = row.querySelector('select');
        selectEl.onchange = (e) => {
            const t = employees.find(x => x.code === e.currentTarget.dataset.code);
            if(t) {
                t.so_cong_nv = parseFloat(e.target.value);
                updateEmployeeOvertime(t); 
                renderAttendanceList(); 
            }
        };

        // Event Input Note
        const inputEl = row.querySelector('input');
        inputEl.oninput = (e) => {
            const t = employees.find(x => x.code === e.currentTarget.dataset.code);
            if(t) t.ghi_chu = e.target.value;
        }

        wrap.appendChild(row);
      });
    }

    // Helper: Update Badge số lượng nhân viên
    function updateBadgeUI() {
        const badge = document.getElementById('saveBadge');
        if (employees.length > 0) {
            badge.textContent = employees.length;
            badge.classList.remove('hidden');
            // Hiệu ứng "pop" nhẹ
            badge.classList.remove('scale-100');
            badge.classList.add('scale-125');
            setTimeout(() => {
                badge.classList.remove('scale-125');
                badge.classList.add('scale-100');
            }, 200);
        } else {
            badge.classList.add('hidden');
        }
    }

    async function safeFetchJson(url, options){
      try {
          const res = await fetch(url, options);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const ct = res.headers.get("content-type") || "";
          return ct.includes("application/json") ? res.json() : res.text();
      } catch(e) { throw e; }
    }

    async function loadEmployeesForBranch(){
      if(!currentBranch) return;
      renderSkeleton(3);
      try{
        const data = await safeFetchJson(byBranchUrl(currentBranch));
        if (Array.isArray(data)) {
            employees = data.map(emp => {
                const e = { ...emp, branch_today: currentBranch, so_cong_nv: 1, ghi_chu: "" };
                updateEmployeeOvertime(e);
                return e;
            });
            renderAttendanceList();
        }
      }catch(err){ showStatusModal('error', "Lỗi tải dữ liệu"); }
    }

    /* Save Logic */
    async function saveAttendance(){
      vibrate();
      const saveBtn = document.getElementById('saveBtn');
      if (saveBtn.disabled) return;
      const saveIcon = document.getElementById('saveIcon');
      const saveSpinner = document.getElementById('saveSpinner');

      // THÊM: Hộp thoại xác nhận trước khi lưu
      if (!confirm(`Bạn có chắc chắn muốn lưu điểm danh cho ${employees.length} nhân viên không?`)) {
        return; // Dừng lại nếu người dùng không xác nhận
      }
      
      if (employees.length === 0){ showStatusModal('error', "Danh sách trống!"); return; }
      if (!currentBranch) { showStatusModal('error', "Chưa xác định chi nhánh!"); return; }

      // UI Feedback: Toggle Icon/Spinner
      saveBtn.disabled = true;
      saveIcon.classList.add('hidden');
      saveSpinner.classList.remove('hidden');

      showStatusModal('loading', 'Đang lưu lên hệ thống...');

      const payload = employees.map(emp => ({
        ma_nv: emp.code, ten_nv: emp.name,
        chi_nhanh_chinh: emp.branch, chi_nhanh_lam: currentBranch,
        la_tang_ca: !!emp.la_tang_ca, so_cong_nv: emp.so_cong_nv,
        ghi_chu: emp.ghi_chu, token: qrToken 
      }));

      const resetBtn = () => {
         saveBtn.disabled = false;
         saveIcon.classList.remove('hidden');
         saveSpinner.classList.add('hidden');
      };

      try {
        const res = await fetch(saveUrl(), { 
          method:"POST", headers:{ "Content-Type":"application/json", "X-CSRF-Token": csrfToken },
          body: JSON.stringify(payload)
        });
        
        if(!res.ok) throw new Error("Server Error");
        const doc = await res.json();

        if (doc && doc.status === 'success') {
            playSound('success');
            if(doc.redirect_to) {
                showStatusModal('success', 'Chuyển hướng...', 1000, () => window.location.replace(doc.redirect_to), 'Điểm danh thành công!');
            } else {
                showStatusModal('success', 'Dữ liệu đã được cập nhật.', 2000, () => {
                   const role = (userRole||"").toLowerCase();
                   if (["quanly","ktv","boss","admin"].includes(role)) {
                       employees = []; renderAttendanceList();
                   }
                   resetBtn();
                });
            }
        } else { throw new Error(doc.message || "API returned failure"); }

      } catch(err) {
        playSound('delete')
        showStatusModal('error', "Lỗi lưu: " + err.message);
        resetBtn();
      }
    }

    /* Search & Branch Logic (Simplified for brevity but fully functional) */
    document.getElementById("addEmployeeBtn").onclick = () => { 
        vibrate(); 
        openModal('searchModal'); 
        document.getElementById("searchInputMain").value=""; 
        document.getElementById("suggestListMain").innerHTML=""; 
    };

    document.getElementById("refreshBtn").onclick = () => { 
        vibrate(); 
        playSound('update'); // <--- THÊM: Âm thanh click nhẹ
        document.getElementById("attendanceList").innerHTML=""; 
        loadEmployeesForBranch(); 
    };
    document.getElementById("saveBtn").onclick = saveAttendance;

    let searchTimer;
    document.getElementById("searchInputMain").oninput = (e) => {
        clearTimeout(searchTimer);
        const q = e.target.value.trim();
        if(!q) { document.getElementById("suggestListMain").innerHTML=""; return; }
        searchTimer = setTimeout(async() => {
             try {
                 const data = await safeFetchJson(searchUrl(q));
                 const html = (Array.isArray(data) ? data : []).map(emp => `
                    <div class="flex items-center justify-between gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer active:scale-95 transition" onclick="addOne('${emp.code}', '${escapeAttr(emp.name)}', '${escapeAttr(emp.department)}', '${escapeAttr(emp.branch)}')">
                        <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center font-bold text-blue-600 dark:text-blue-300">${emp.name.charAt(0)}</div>
                        <div>
                            <p class="font-bold text-slate-800 dark:text-slate-100">${escapeHtml(emp.name)}</p>
                            <p class="text-xs text-slate-500">${emp.code} - ${formatDepartment(emp.department)}</p>
                        </div>
                        </div>
                        <div class="p-2 text-slate-400">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        </div>
                    </div>
                 `).join('');
                 document.getElementById("suggestListMain").innerHTML = html;
             } catch(e){}
        }, 300);
    };

    window.addOne = (code, name, dept, branch) => {
        if(employees.some(e => e.code === code)) {
            const errorDiv = document.getElementById('searchError');
            errorDiv.textContent = `Nhân viên "${name}" đã có trong danh sách.`;
            errorDiv.classList.remove('hidden');
            // Rung và phát âm thanh lỗi
            vibrate(20);
            playSound('delete');
            // Tự động ẩn sau 3 giây
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 3000);
            return; 
        }
        // Ẩn thông báo lỗi nếu có
        document.getElementById('searchError').classList.add('hidden');
        const newEmp = { code, name, department: dept, branch, branch_today: currentBranch, so_cong_nv: 1, ghi_chu: "" };
        updateEmployeeOvertime(newEmp);
        employees.unshift(newEmp);
        renderAttendanceList();
        closeModal('searchModal'); // Đóng modal sau khi thêm
        playSound('add');
        showStatusModal('success', `Đã thêm "${name} - ${formatDepartment(dept)}" vào danh sách.`, 2000);
    };

    /* ========= Lock/Unlock System ========= */
    
    // Hàm khóa giao diện
    function lockInterface() {
        const mainContent = document.querySelector('main');
        const bottomNav = document.querySelector('.fixed.bottom-0');
        const header = document.querySelector('header');
        
        mainContent.classList.add('ui-locked');
        bottomNav.classList.add('ui-locked');
        // header.classList.add('ui-locked'); // Có thể giữ header để user log out nếu muốn
    }

    // Hàm mở khóa
    function unlockInterface() {
        const mainContent = document.querySelector('main');
        const bottomNav = document.querySelector('.fixed.bottom-0');
        
        mainContent.classList.remove('ui-locked');
        bottomNav.classList.remove('ui-locked');
    }

    // Hàm hiện Modal bắt buộc bật GPS (Không có nút tắt)
    function showForceGPSModal() {
        // Tạo modal cứng nếu chưa có
        if (!document.getElementById('forceGpsModal')) {
            const div = document.createElement('div');
            div.id = 'forceGpsModal';
            div.className = 'fixed inset-0 flex items-center justify-center p-6 modal-backdrop-force animate-fade-in';
            div.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl border-2 border-red-500 relative">
                    <div class="mx-auto w-20 h-20 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mb-6 animate-pulse">
                        <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-3">Yêu cầu GPS!</h2>
                    <p class="text-slate-600 dark:text-slate-300 mb-6 leading-relaxed">
                        Để chấm công, bạn <strong>bắt buộc</strong> phải bật định vị và cấp quyền truy cập vị trí cho trình duyệt.
                    </p>
                    <button onclick="location.reload()" class="w-full py-3.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-500/30 transition-transform active:scale-95">
                        Đã bật, thử lại ngay
                    </button>
                    <p class="text-xs text-slate-400 mt-4">Nếu vẫn không được, hãy kiểm tra cài đặt quyền riêng tư trên điện thoại.</p>
                </div>
            `;
            document.body.appendChild(div);
        }
    }

    /* GPS & Init */
    async function detectBranchByGPS(){
      document.getElementById("branchName").textContent = "Đang định vị...";
      
      if (!navigator.geolocation) {
          showForceGPSModal();
          return;
      }

      navigator.geolocation.getCurrentPosition(async (pos)=>{
          // --- GPS THÀNH CÔNG ---
          try {
             const data = await safeFetchJson(detectBranchUrl(), { 
                 method:"POST", 
                 headers:{"Content-Type":"application/json"}, 
                 body: JSON.stringify({ lat:pos.coords.latitude, lng:pos.coords.longitude }) 
             });
             
             if(data.branch) {
                currentBranch = data.branch;
                document.getElementById("branchName").textContent = getBranchFullName(currentBranch);

                window.dispatchEvent(new CustomEvent('branch-changed', { detail: currentBranch }));
                
                // QUAN TRỌNG: Mở khóa giao diện khi đã có chi nhánh hợp lệ
                unlockInterface();
                loadEmployeesForBranch();

              } else if(data.choices) {
                 // Logic chọn nhiều chi nhánh (nếu có)
                 const html = data.choices.map(c => `...`).join(''); // (Giữ code cũ render list)
                 document.getElementById('branchChoices').innerHTML = html;
                 openModal('branchPopup');
                 // Lưu ý: Chưa unlock vội, đợi user chọn xong ở hàm selectBranch
             }
          } catch(e) { 
             // Lỗi API (ví dụ server trả về lỗi quá xa)
             document.getElementById("branchName").textContent = "Lỗi xác thực vị trí";
             showStatusModal('error', "Vị trí không hợp lệ hoặc quá xa!");
             // Vẫn giữ khóa UI
          }

      }, (error) => {
          // --- GPS THẤT BẠI / TỪ CHỐI ---
          console.error("GPS Error:", error);
          document.getElementById("branchName").textContent = "Không có GPS";
          
          // Hiện Modal bắt buộc -> Chặn toàn bộ thao tác
          showForceGPSModal();
      }, {
          enableHighAccuracy: true, // Yêu cầu chính xác cao
          timeout: 10000,           // Chờ tối đa 10s
          maximumAge: 0             // Không dùng cache vị trí cũ
      });
    }

    window.selectBranch = async (b) => {
      currentBranch = b;
      document.getElementById("branchName").textContent = getBranchFullName(b);
      window.dispatchEvent(new CustomEvent('branch-changed', { detail: b }));
      await safeFetchJson(selectBranchUrl(), { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ branch: b }) });
      closeModal('branchPopup');
      loadEmployeesForBranch();
      unlockInterface(); // Mở khóa
    }

    // Initialize logic
    window.addEventListener("DOMContentLoaded", async () => {
        // Night shift logic
        lockInterface();
        const h = new Date().getHours();
        if(h < 7) {
            const y = new Date(); y.setDate(y.getDate()-1);
            document.getElementById('workDate').textContent = `${y.getDate()}/${y.getMonth()+1}/${y.getFullYear()}`;
            document.getElementById('nightShiftNotice').classList.remove('hidden');
        }
        
        const role = (userRole||"").toLowerCase();
        const specialRoles = ["quanly", "ktv", "boss", "admin"];

        if(specialRoles.includes(role)) {
            // === LOGIC CHO QUẢN LÝ / KTV ===
            try {
                // Gọi API detect-branch (Server sẽ tự lấy theo ID, không cần GPS)
                const d = await safeFetchJson("/attendance/api/detect-branch", { 
                    method:"POST", 
                    headers:{"Content-Type":"application/json"}, 
                    body: JSON.stringify({}) // Gửi body rỗng
                });
                
                if(d.branch) { 
                  currentBranch = d.branch; 
                  document.getElementById("branchName").textContent = getBranchFullName(currentBranch);

                  window.dispatchEvent(new CustomEvent('branch-changed', { detail: currentBranch }));
                  
                  // MỞ KHÓA CHO QUẢN LÝ
                  unlockInterface();
                  loadEmployeesForBranch(); 
                } else {
                    // Trường hợp hy hữu QL mà không có branch trong DB
                    document.getElementById("branchName").textContent = "Chưa gán chi nhánh";
                    // Vẫn khóa
                }
            } catch(e){
                 document.getElementById("branchName").textContent = "Lỗi dữ liệu";
            }
        } else {
            // === LOGIC CHO NHÂN VIÊN THƯỜNG ===
            // Bắt buộc chạy GPS check
            detectBranchByGPS();
        }
    });
  </script>
</body>
</html>
